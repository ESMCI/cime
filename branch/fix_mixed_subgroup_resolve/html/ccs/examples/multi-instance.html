

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-instance &mdash; CIME master documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-toolbox-code.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=3d7e66fe" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=30d551ce"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Timers" href="../timers.html" />
    <link rel="prev" title="Setting up a branch or hybrid run" href="branch-hybrid.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CIME
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">For Users</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Case Control System (CCS)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../query-configuration.html">Query configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-config.html">User Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../creating-a-case.html">Creating a Case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setting-up-a-case.html">Setting up a Case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../building-a-case.html">Building a Case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../running-a-case.html">Running a Case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloning-a-case.html">Cloning a Case</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="multi-year.html">Setting up a multi-year run</a></li>
<li class="toctree-l3"><a class="reference internal" href="branch-hybrid.html">Setting up a branch or hybrid run</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Multi-instance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../timers.html">Timers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../model-configuration/index.html">Model Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../system_testing.html">System Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For Developers/Contributors</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing-guide.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CIME</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Case Control System (CCS)</a></li>
          <li class="breadcrumb-item"><a href="index.html">Examples</a></li>
      <li class="breadcrumb-item active">Multi-instance</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/ccs/examples/multi-instance.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="multi-instance">
<span id="ccs-examples-multi-instance"></span><h1>Multi-instance<a class="headerlink" href="#multi-instance" title="Link to this heading"></a></h1>
<p>The CIME coupling infrastructure is capable of running multiple
component instances (ensembles) under one model executable.  There are
two modes of ensemble capability, single driver in which all component
instances are handled by a single driver/coupler component or
multi-driver in which each instance includes a separate driver/coupler
component. In the multi-driver mode the entire model is duplicated
for each instance while in the single driver mode only active
components need be duplicated. In most cases the multi-driver mode
will give better performance and should be used.</p>
<p>The primary motivation for this development was to be able to run an
ensemble Kalman-Filter for data assimilation and parameter estimation
(UQ, for example). However, it also provides the ability to run a set
of experiments within a single model executable where each instance
can have a different namelist, and to have all the output go to one
directory.</p>
<ol class="arabic">
<li><p>Create the case.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./scripts/create_newcase<span class="w"> </span>--case<span class="w"> </span>~/MULTI_EXAMPLE<span class="w"> </span>--compset<span class="w"> </span>F2000_DEV<span class="w"> </span>--res<span class="w"> </span>f19_f19_mg17
<span class="nb">cd</span><span class="w"> </span>~/MULTI_EXAMPLE
</pre></div>
</div>
</li>
<li><p>Assume this is the out-of-the-box pe-layout:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Comp<span class="w">  </span>NTASKS<span class="w">  </span>NTHRDS<span class="w">  </span>ROOTPE
CPL<span class="w"> </span>:<span class="w">    </span><span class="m">144</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
ATM<span class="w"> </span>:<span class="w">    </span><span class="m">144</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
LND<span class="w"> </span>:<span class="w">    </span><span class="m">144</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
ICE<span class="w"> </span>:<span class="w">    </span><span class="m">144</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
OCN<span class="w"> </span>:<span class="w">    </span><span class="m">144</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
ROF<span class="w"> </span>:<span class="w">    </span><span class="m">144</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
GLC<span class="w"> </span>:<span class="w">    </span><span class="m">144</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
WAV<span class="w"> </span>:<span class="w">    </span><span class="m">144</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
ESP<span class="w"> </span>:<span class="w">      </span><span class="m">1</span>/<span class="w">     </span><span class="m">1</span><span class="p">;</span><span class="w">      </span><span class="m">0</span>
</pre></div>
</div>
<p>Lets assume that the atm, lnd, rof, and glc components are activate in this compset.
The ocn is a prescribed data component, cice is a mixed prescribed/active
component (ice-coverage is prescribed), and wav and esp are stub
components.</p>
<p>In this example each each non-stub component will run two instances.</p>
</li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">xmlchange</span></code> the <code class="docutils literal notranslate"><span class="pre">NINST</span></code> can be modified for each of these components.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xmlchange<span class="w"> </span><span class="nv">NINST_ATM</span><span class="o">=</span><span class="m">2</span>
./xmlchange<span class="w"> </span><span class="nv">NINST_LND</span><span class="o">=</span><span class="m">2</span>
./xmlchange<span class="w"> </span><span class="nv">NINST_ICE</span><span class="o">=</span><span class="m">2</span>
./xmlchange<span class="w"> </span><span class="nv">NINST_ROF</span><span class="o">=</span><span class="m">2</span>
./xmlchange<span class="w"> </span><span class="nv">NINST_GLC</span><span class="o">=</span><span class="m">2</span>
./xmlchange<span class="w"> </span><span class="nv">NINST_OCN</span><span class="o">=</span><span class="m">2</span>
</pre></div>
</div>
<p>Each of these components will have each instance run on 72 MPI tasks (NTASKS/NINST) and all using the same driver/coupler component.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a separate driver/coupler component per instance is desired, the
<code class="docutils literal notranslate"><span class="pre">MULTI_DRIVER</span></code> option can be used.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./xmlchange<span class="w"> </span><span class="nv">MULTI_DRIVER</span><span class="o">=</span>TRUE
</pre></div>
</div>
<p>This configuration will run each component instance on the original 144 tasks but will generate two copies of the model (in the same executable) for a total of 288 tasks.</p>
</div>
</li>
<li><p>Set up the case.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./case.setup
</pre></div>
</div>
<p>A new <strong>user_nl_xxx_NNNN</strong> file is generated for each component instance when <code class="docutils literal notranslate"><span class="pre">case.setup</span></code> is called (where xxx is the component type and NNNN is the number of the component instance).</p>
<p>For example if the <code class="docutils literal notranslate"><span class="pre">ICE</span></code> component is <code class="docutils literal notranslate"><span class="pre">cice</span></code> then the following files are created in <code class="docutils literal notranslate"><span class="pre">$CASEROOT</span></code> after calling <code class="docutils literal notranslate"><span class="pre">./xmlchange</span> <span class="pre">NINST_ICE=2</span></code> and <code class="docutils literal notranslate"><span class="pre">./case.setup</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>user_nl_cice_0001
user_nl_cice_0002
</pre></div>
</div>
<p>The namelist for each component instance can be modified by changing the corresponding <strong>user_nl_xxx_NNNN</strong> file.</p>
<p>The components steam files can also be modified per instance. To change the DOCN stream txt file instance 0002, copy <strong>docn.streams.txt.prescribed_0002</strong> to your <strong>$CASEROOT</strong> directory with the name <strong>user_docn.streams.txt.prescribed_0002</strong> and modify it accordlingly.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>These changes can be made when <code class="docutils literal notranslate"><span class="pre">create_newcase</span></code> is called using <code class="docutils literal notranslate"><span class="pre">--ninst</span> <span class="pre">#</span></code> where # is a positive integer, and <code class="docutils literal notranslate"><span class="pre">--multi-driver</span></code> to invoke the multi-driver mode.</p></li>
<li><p>Multiple component instances can differ ONLY in namelist settings; they ALL use the same model executable.</p></li>
<li><p>Calling <code class="docutils literal notranslate"><span class="pre">case.setup</span></code> with <code class="docutils literal notranslate"><span class="pre">--clean</span></code> <em>DOES NOT</em> remove the <strong>user_nl_xxx_NN</strong> (where xxx is the component name) files created by <code class="docutils literal notranslate"><span class="pre">case.setup</span></code>.</p></li>
<li><p>A special variable NINST_LAYOUT is provided for some experimental compsets, its value should be ‘concurrent’ for all but a few special cases and it cannot be used if MULTI_DRIVER=TRUE.</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">create_test</span></code> these options can be invoked with testname modifiers <code class="docutils literal notranslate"><span class="pre">_N#</span></code> for the single driver mode and <code class="docutils literal notranslate"><span class="pre">_C#</span></code> for the multi-driver mode.  These are mutually exclusive options.</p></li>
<li><p>In multi-driver mode you will always get 1 instance of each component for each driver/coupler, if you change a case using <code class="docutils literal notranslate"><span class="pre">./xmlchange</span> <span class="pre">MULTI_COUPLER=TRUE</span></code> you will get a number of driver/couplers equal to the maximum NINST value over all components.</p></li>
</ul>
</div>
</li>
</ol>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="branch-hybrid.html" class="btn btn-neutral float-left" title="Setting up a branch or hybrid run" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../timers.html" class="btn btn-neutral float-right" title="Timers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  

  <script type="text/javascript">
    let baseUriRegex = /(.*\/cime)\/.*/g;
    let parsedUri = baseUriRegex.exec(document.baseURI);

    if (parsedUri != null && parsedUri.length == 2) {
      let baseUri = parsedUri[1];

      $.get(`${baseUri}/versions/versions.json`, function(data) {
        let versionElement = $("#versions");

        Object.keys(data).forEach(function(key) {
          let value = data[key];

          let item = `<dd><a href="${baseUri}/versions/${key}/html/">${value}</a></dd>`

          versionElement.append(item);
        });
      });
    }
  </script>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: master
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl id="versions">
        <dt>Versions</dt>
      </dl>
      
      
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>