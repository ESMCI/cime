

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2. CIME Load Balancing Tool &mdash; CIME master documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=30d551ce"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Glossary" href="../glossary/index.html" />
    <link rel="prev" title="1. CESM-ECT (CESM Ensemble Consistency Test):" href="ect.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CIME
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../what_cime/index.html">What is CIME?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/index.html">Using the Case Control System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/index.html#configuring-the-case-control-system">Configuring the Case Control System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build_cpl/index.html">Building a Coupled Model with CIME</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Miscellaneous Tools</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ect.html">1. CESM-ECT (CESM Ensemble Consistency Test):</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2. CIME Load Balancing Tool</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#running-simulations-using-load-balancing-submit-py">2.1. Running simulations using load_balancing_submit.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimizing-the-layout-using-load-balacing-solve-py">2.2. Optimizing the layout using load_balacing_solve.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="#more-about-the-algorithm">2.3. More about the algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extending-the-load-balancing-tool">2.4. Extending the Load Balancing Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing">2.5. Testing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools_user/index.html">User Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xml_files/index.html">XML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CIME_api/modules.html">CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools_api/modules.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CIME</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Miscellaneous Tools</a></li>
      <li class="breadcrumb-item active"><span class="section-number">2. </span>CIME Load Balancing Tool</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/misc_tools/load-balancing-tool.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cime-load-balancing-tool">
<span id="load-balancing-tool"></span><h1><span class="section-number">2. </span>CIME Load Balancing Tool<a class="headerlink" href="#cime-load-balancing-tool" title="Link to this heading"></a></h1>
<blockquote>
<div><p>Originally Developed by Sheri Mickelson <a class="reference external" href="mailto:mickelso&#37;&#52;&#48;ucar&#46;edu">mickelso<span>&#64;</span>ucar<span>&#46;</span>edu</a>
and Yuri Alekseev (ALCF/Argonne National Laboratory</p>
<p>Updated 2017 Jason Sarich <a class="reference external" href="mailto:sarich&#37;&#52;&#48;mcs&#46;anl&#46;gov">sarich<span>&#64;</span>mcs<span>&#46;</span>anl<span>&#46;</span>gov</a> (Argonne National Laboratory)</p>
</div></blockquote>
<p>This Load Balancing tool performs several operations intended to find
a reasonable PE layout for CIME simulations. These operations involve two
steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="n">load_balancing_submit</span><span class="o">.</span><span class="n">py</span>
   <span class="n">Run</span> <span class="n">a</span> <span class="n">series</span> <span class="n">of</span> <span class="n">simulations</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">obtain</span> <span class="n">timing</span> <span class="n">data</span>

<span class="mf">2.</span> <span class="n">load_balancing_solve</span><span class="o">.</span><span class="n">py</span>
   <span class="n">Using</span> <span class="n">the</span> <span class="n">data</span> <span class="n">provided</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">program</span><span class="p">,</span> <span class="n">solve</span> <span class="n">a</span> <span class="n">mixed</span> <span class="n">integer</span>
   <span class="n">linear</span> <span class="n">program</span> <span class="n">to</span> <span class="n">optimize</span> <span class="n">the</span> <span class="n">model</span> <span class="n">throughput</span><span class="o">.</span> <span class="n">Requires</span> <span class="n">installation</span>
   <span class="n">of</span> <span class="n">PuLP</span> <span class="ow">and</span> <span class="n">uses</span> <span class="n">the</span> <span class="n">included</span> <span class="n">COIN</span><span class="o">-</span><span class="n">CBC</span> <span class="n">solver</span><span class="o">.</span> <span class="p">(</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">pythonhosted</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">PuLP</span><span class="p">)</span>
</pre></div>
</div>
<p>Also in this documentation is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">3.</span> <span class="n">More</span> <span class="n">about</span> <span class="n">the</span> <span class="n">algorithm</span> <span class="n">used</span>

<span class="mf">4.</span> <span class="n">Extending</span> <span class="n">the</span> <span class="n">solver</span> <span class="k">for</span> <span class="n">other</span> <span class="n">models</span>

<span class="mf">5.</span> <span class="n">Testing</span> <span class="n">information</span> <span class="k">for</span> <span class="n">developers</span>
</pre></div>
</div>
<p><em>For the impatient</em></p>
<ol class="arabic simple">
<li><p>set PYTHONPATH to include $CIME_DIR/scripts:$CIME_DIR/tools/load_balancing_tool</p></li>
<li><p>create PE XML &lt;PESFILE&gt; file to describe the PE layouts for the timing runs</p></li>
<li><p>$ ./load_balancing_submit.py –res &lt;RESOLUTION&gt; –compset &lt;COMPSET&gt; –pesfile &lt;PESFILE&gt;</p></li>
<li><p>…  wait for jobs to run …</p></li>
<li><p>$ ./load_balancing_solve.py –total-tasks &lt;N&gt; –blocksize 8</p></li>
</ol>
<section id="running-simulations-using-load-balancing-submit-py">
<h2><span class="section-number">2.1. </span>Running simulations using load_balancing_submit.py<a class="headerlink" href="#running-simulations-using-load-balancing-submit-py" title="Link to this heading"></a></h2>
<p>Simulations can be run on a given system by executing the load_balancing_tool.py
script, located in cime/tools/load_balancing_tool/load_balancing_tool_submit.py.
This creates timing files in the case directory which will be used to solve
a mixed integer linear program optimizing the layout. If there is already timing
information available, then a</p>
<p>As with the create_newcase and create_test scripts, command line options
are used to tailor the simulations for a given model. These values will be
directly forwarded to the passed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">compiler</span>
<span class="o">--</span><span class="n">project</span>
<span class="o">--</span><span class="n">compset</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span>
<span class="o">--</span><span class="n">res</span>     <span class="p">(</span><span class="n">required</span><span class="p">)</span>
<span class="o">--</span><span class="n">machine</span>
</pre></div>
</div>
<p>Other options include:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">pesfile</span> <span class="o">&lt;</span><span class="n">filename</span><span class="o">&gt;</span>    <span class="p">(</span><span class="n">required</span><span class="p">)</span>
     <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">designated</span> <span class="n">the</span> <span class="n">pes</span> <span class="n">layout</span> <span class="n">that</span>
     <span class="n">are</span> <span class="n">used</span> <span class="n">to</span> <span class="n">create</span> <span class="n">the</span> <span class="n">timing</span> <span class="n">data</span><span class="o">.</span> <span class="n">The</span> <span class="nb">format</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span> <span class="n">used</span>
     <span class="n">by</span> <span class="n">CIME</span> <span class="n">pes_files</span><span class="p">,</span> <span class="n">but</span> <span class="n">note</span> <span class="n">that</span> <span class="n">the</span> <span class="s1">&#39;pesize&#39;</span> <span class="n">tag</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span>
     <span class="n">to</span> <span class="n">generate</span> <span class="n">the</span> <span class="n">casename</span><span class="o">.</span> <span class="n">Also</span><span class="p">,</span> <span class="n">this</span> <span class="n">file</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">directly</span>
     <span class="n">passed</span> <span class="n">through</span> <span class="n">to</span> <span class="n">CIME</span><span class="p">,</span> <span class="n">but</span> <span class="n">rather</span> <span class="n">it</span> <span class="n">will</span> <span class="n">trigger</span> <span class="n">xmlchange</span>
     <span class="n">commands</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">file</span><span class="o">.</span>

<span class="o">--</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span> <span class="o">&lt;</span><span class="n">prefix</span><span class="o">&gt;</span>
     <span class="n">By</span> <span class="n">default</span><span class="p">,</span> <span class="n">the</span> <span class="n">load</span> <span class="n">balancing</span> <span class="n">tool</span> <span class="n">will</span> <span class="n">use</span> <span class="n">casenames</span><span class="p">:</span>
        <span class="n">PFS_I0</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">compset</span><span class="o">.</span><span class="n">lbt</span>
        <span class="n">PFS_I1</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">compset</span><span class="o">.</span><span class="n">lbt</span>
        <span class="o">...</span>
        <span class="n">PFS_IN</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">compset</span><span class="o">.</span><span class="n">lbt</span>
     <span class="k">for</span> <span class="n">each</span> <span class="n">simulation</span> <span class="n">requested</span><span class="o">.</span> <span class="n">These</span> <span class="n">casenames</span> <span class="n">will</span> <span class="n">be</span> <span class="n">forwarded</span> <span class="n">to</span>
     <span class="n">the</span> <span class="n">create_test</span> <span class="n">script</span><span class="o">.</span>

     <span class="n">Using</span> <span class="n">this</span> <span class="n">option</span> <span class="n">will</span> <span class="n">instead</span> <span class="n">direct</span> <span class="n">the</span> <span class="n">tool</span> <span class="n">to</span> <span class="n">use</span><span class="p">:</span>
        <span class="n">PFS_I0</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">compset</span><span class="o">.</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span>
        <span class="n">PFS_I1</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">compset</span><span class="o">.</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span>
        <span class="o">...</span>
        <span class="n">PFS_IN</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">compset</span><span class="o">.</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span>

<span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">purge</span>
     <span class="n">Force</span> <span class="n">the</span> <span class="n">tool</span> <span class="n">to</span> <span class="n">remove</span> <span class="nb">any</span> <span class="n">existing</span> <span class="n">case</span> <span class="n">directories</span> <span class="k">if</span> <span class="n">they</span>
     <span class="n">exist</span><span class="o">.</span> <span class="n">Removes</span> <span class="n">PFS_I</span><span class="o">*.</span><span class="n">res</span><span class="o">.</span><span class="n">compset</span><span class="o">.</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span>

<span class="o">--</span><span class="n">extra</span><span class="o">-</span><span class="n">options</span><span class="o">-</span><span class="n">file</span>
     <span class="n">Add</span> <span class="n">extra</span> <span class="n">xml</span> <span class="n">options</span> <span class="n">to</span> <span class="n">the</span> <span class="n">timing</span> <span class="n">runs</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">user</span> <span class="n">file</span><span class="p">,</span>
     <span class="n">these</span> <span class="n">options</span> <span class="n">will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">after</span> <span class="n">create_newcase</span> <span class="ow">and</span> <span class="n">before</span>
     <span class="k">case</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span>
     <span class="n">This</span> <span class="n">text</span> <span class="n">file</span> <span class="n">should</span> <span class="n">have</span> <span class="n">one</span> <span class="n">variable</span> <span class="n">per</span> <span class="n">line</span> <span class="ow">in</span>
     <span class="n">the</span> <span class="nb">format</span> <span class="o">&lt;</span><span class="n">var</span><span class="o">&gt;=&lt;</span><span class="n">value</span><span class="o">&gt;.</span> <span class="n">Example</span><span class="p">:</span>

     <span class="n">STOP_OPTION</span><span class="o">=</span><span class="n">ndays</span>
     <span class="n">STOP_N</span><span class="o">=</span><span class="mi">7</span>
     <span class="n">DOUT_S</span><span class="o">=</span><span class="n">FALSE</span>
</pre></div>
</div>
</section>
<section id="optimizing-the-layout-using-load-balacing-solve-py">
<h2><span class="section-number">2.2. </span>Optimizing the layout using load_balacing_solve.py<a class="headerlink" href="#optimizing-the-layout-using-load-balacing-solve-py" title="Link to this heading"></a></h2>
<p>Reads timing data created with load_balancing_submit.py (or otherwise,
see –timing-files option) and solves an mixed integer optimization problem
using these timings. The default layout (IceLndAtmOcn) minimizes the cost per
model day assuming the layout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">____________________</span>
<span class="o">|</span> <span class="n">ICE</span>  <span class="o">|</span>  <span class="n">LND</span>  <span class="o">|</span>     <span class="o">|</span>
<span class="o">|</span><span class="n">______</span><span class="o">|</span><span class="n">_______</span><span class="o">|</span>     <span class="o">|</span>
<span class="o">|</span>              <span class="o">|</span> <span class="n">OCN</span> <span class="o">|</span>
<span class="o">|</span>    <span class="n">ATM</span>       <span class="o">|</span>     <span class="o">|</span>
<span class="o">|</span><span class="n">______________</span><span class="o">|</span><span class="n">_____</span><span class="o">|</span>
</pre></div>
</div>
<p>An IceLndWavAtmOcn layout is also available.  It is possible to extend
this tool to solve for other layouts (See Section 1.4 Extending the Load
Balancing Tool)</p>
<p>Note – threading is not considered part of this optimization, it is assumed that
all timing data have the same threading structure (i.e. all ATM runs use two threads per PE)</p>
<p>Options recognized by the solver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">layout</span> <span class="o">&lt;</span><span class="n">class_name</span><span class="o">&gt;</span>
    <span class="n">Name</span> <span class="n">of</span> <span class="n">the</span> <span class="k">class</span> <span class="nc">used</span> <span class="n">to</span> <span class="n">solve</span> <span class="n">the</span> <span class="n">layout</span> <span class="n">problem</span><span class="o">.</span> <span class="n">The</span> <span class="n">only</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span>
    <span class="k">class</span> <span class="nc">at</span> <span class="n">this</span> <span class="n">time</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">default</span> <span class="n">IceLndAtmOcn</span><span class="p">,</span> <span class="n">but</span> <span class="n">this</span> <span class="n">can</span> <span class="n">be</span> <span class="n">extended</span><span class="o">.</span>
    <span class="n">See</span> <span class="n">section</span> <span class="mi">4</span> <span class="n">Extending</span> <span class="n">the</span> <span class="n">Load</span> <span class="n">Balancing</span> <span class="n">Tool</span>

<span class="o">--</span><span class="n">total</span><span class="o">-</span><span class="n">tasks</span> <span class="n">N</span>    <span class="p">(</span><span class="n">required</span><span class="p">)</span>
    <span class="n">The</span> <span class="n">total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">PEs</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">assigned</span>

<span class="o">--</span><span class="n">timing</span><span class="o">-</span><span class="nb">dir</span> <span class="o">&lt;</span><span class="nb">dir</span><span class="o">&gt;</span>
    <span class="n">Optional</span><span class="p">,</span> <span class="n">read</span> <span class="ow">in</span> <span class="nb">all</span> <span class="n">files</span> <span class="kn">from</span> <span class="nn">this</span> <span class="n">directory</span> <span class="k">as</span> <span class="n">timing</span> <span class="n">data</span>

<span class="o">--</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span> <span class="o">&lt;</span><span class="n">prefix</span><span class="o">&gt;</span>
    <span class="n">The</span> <span class="n">test</span><span class="o">-</span><span class="nb">id</span> <span class="n">used</span> <span class="n">when</span> <span class="n">submitting</span> <span class="n">the</span> <span class="n">timing</span> <span class="n">jobs</span><span class="o">.</span> <span class="n">This</span> <span class="n">option</span> <span class="n">can</span> <span class="n">also</span>
    <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">a</span> <span class="n">single</span> <span class="n">directory</span> <span class="n">where</span> <span class="n">ALL</span> <span class="n">of</span> <span class="n">the</span> <span class="n">timing</span> <span class="n">data</span> <span class="ow">is</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">solver</span> <span class="n">will</span> <span class="n">extract</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">timing</span> <span class="n">files</span> <span class="n">that</span> <span class="n">match</span> <span class="n">either</span> <span class="n">pattern</span><span class="p">:</span>
       <span class="o">&lt;</span><span class="n">prefix</span><span class="o">&gt;.</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">timing</span><span class="o">/</span><span class="n">timing</span><span class="o">.&lt;</span><span class="n">prefix</span><span class="o">&gt;.</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span>
       <span class="o">&lt;</span><span class="n">prefix</span><span class="o">&gt;.</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">timing</span><span class="o">/</span><span class="n">timing</span><span class="o">.&lt;</span><span class="n">prefix</span><span class="o">&gt;.</span><span class="n">test</span><span class="o">-</span><span class="nb">id</span>

<span class="o">--</span><span class="n">blocksize</span> <span class="n">N</span>
    <span class="n">The</span> <span class="n">blocksize</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">granularity</span> <span class="n">of</span> <span class="n">processors</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">group</span>
    <span class="n">together</span><span class="p">,</span> <span class="n">useful</span> <span class="k">for</span> <span class="n">when</span> <span class="n">PEs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">multiples</span> <span class="n">of</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span>

<span class="o">--</span><span class="n">blocksize</span><span class="o">-</span><span class="n">XXX</span> <span class="n">N</span>
    <span class="n">Components</span> <span class="n">don</span><span class="s1">&#39;t all have to have the same blocksize. The default</span>
    <span class="n">blocksize</span> <span class="n">given</span> <span class="n">by</span> <span class="o">--</span><span class="n">blocksize</span> <span class="n">can</span> <span class="n">be</span> <span class="n">overridden</span> <span class="k">for</span> <span class="n">a</span> <span class="n">given</span> <span class="n">component</span>
    <span class="n">using</span> <span class="n">this</span> <span class="n">option</span><span class="p">,</span> <span class="n">where</span> <span class="n">XXX</span> <span class="n">can</span> <span class="n">be</span> <span class="n">ATM</span><span class="p">,</span> <span class="n">ICE</span><span class="p">,</span> <span class="n">GLC</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span>
    <span class="n">Example</span><span class="p">:</span>
    <span class="o">--</span><span class="n">blocksize</span> <span class="mi">8</span> <span class="o">--</span><span class="n">blocksize</span><span class="o">-</span><span class="n">GLC</span> <span class="mi">1</span>
        <span class="n">will</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">GLC</span> <span class="n">blocksize</span> <span class="n">to</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span> <span class="n">other</span> <span class="n">blocksizes</span> <span class="n">to</span> <span class="mi">8</span>

<span class="o">--</span><span class="n">milp</span><span class="o">-</span><span class="n">output</span> <span class="o">&lt;</span><span class="n">filename</span><span class="o">&gt;</span>
    <span class="n">After</span> <span class="n">extracting</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">timing</span> <span class="n">files</span> <span class="ow">and</span> <span class="n">before</span> <span class="n">solving</span><span class="p">,</span> <span class="n">write</span> <span class="n">the</span>
    <span class="n">data</span> <span class="n">to</span> <span class="n">a</span> <span class="o">.</span><span class="n">json</span> <span class="n">file</span> <span class="n">where</span> <span class="ow">is</span> <span class="n">can</span> <span class="n">be</span> <span class="n">analyzed</span> <span class="ow">or</span> <span class="n">manually</span> <span class="n">edited</span><span class="o">.</span>

<span class="o">--</span><span class="n">milp</span><span class="o">-</span><span class="nb">input</span> <span class="o">&lt;</span><span class="n">filename</span><span class="o">&gt;</span>
    <span class="n">Read</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">problem</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">given</span> <span class="o">.</span><span class="n">json</span> <span class="n">file</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">extracting</span> <span class="kn">from</span>
    <span class="nn">timing</span> <span class="n">files</span><span class="o">.</span>

<span class="o">--</span><span class="n">pe</span><span class="o">-</span><span class="n">output</span> <span class="o">&lt;</span><span class="n">filename</span><span class="o">&gt;</span>
    <span class="n">Write</span> <span class="n">the</span> <span class="n">solution</span> <span class="n">PE</span> <span class="n">layout</span> <span class="n">to</span> <span class="n">a</span> <span class="n">potential</span> <span class="n">pe</span> <span class="n">xml</span> <span class="n">file</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="more-about-the-algorithm">
<h2><span class="section-number">2.3. </span>More about the algorithm<a class="headerlink" href="#more-about-the-algorithm" title="Link to this heading"></a></h2>
<p>Before solving the mixed-integer linear program, a model of the cost vs ntasks
function is constructed for each component.</p>
<p>Given a component data set of costs (C1,C2,..,Cn) and nblocks (N1,N2,..,Nn),
then an piecewise set of n+1 linear constraints are created using the idea:</p>
<p>If N &lt; N1 (which means that N1 cannot be 1), then assume that there is
perfect scalability from N to N1. Thus the cost is on the line
defined by the points (1, C1*N1) - (N1, C1).</p>
<p>If N is between N_i and N_{i+1}, then the cost is on the line defined by the
points (N_i, C_i) and (N_{i+1}, C_{i+1}.</p>
<p>If N &gt; Nn, then we want to extrapolate the cost at N=total_tasks
(we define N{n+1} = total_tasks, C{n+1} = estimated cost using all nodes)
Assuming perfect scalability is problematic at this level, so we instead
assume that the parallel efficiency drops at the same factor as it does</p>
<blockquote>
<div><p>from N=N{n-1} to N = Nn</p>
<blockquote>
<div><p>First solve for efficiency E:
C{n-1} - Cn = E * (C{n-1} * N{n-1} / Nn)</p>
<p>Then E to find C{n+1} (cost at ntasks N{n+1}):
Cn - Ct = E * (Cn * Nn / Nt)</p>
<p>Now cost is on the line defined by (Nn,Cn) - (Nt,Ct)</p>
</div></blockquote>
</div></blockquote>
<p>Assuming that this piecewise linear function describes a convex function, we do
not have to explicitly construct this piecewise function and can instead use
each of the cost functions on the entire domain.</p>
<p>These piecewise linear models give us the following linear constraints, where
the model time cost C as a function of N (ntasks) for each component
is constrained by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span> <span class="o">&gt;=</span> <span class="n">Ci</span>  <span class="o">-</span> <span class="n">Ni</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span><span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span><span class="o">-</span><span class="n">Ci</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span><span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span><span class="o">-</span><span class="n">Ni</span><span class="p">)</span> <span class="o">+</span>
           <span class="n">N</span> <span class="o">*</span>  <span class="p">(</span><span class="n">C</span><span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span><span class="o">-</span><span class="n">Ci</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span><span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span><span class="o">-</span><span class="n">Ni</span><span class="p">)</span>    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mf">0.</span><span class="o">.</span><span class="n">n</span>
</pre></div>
</div>
<p>These constraints should be in effect for any extensions of the solver (the
components involved may be different).</p>
<p>There are options available in load_balancing_submit.py to inspect these
piecewise linear models:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">graph</span><span class="o">-</span><span class="n">models</span> <span class="p">(</span><span class="n">requires</span> <span class="n">matplotlib</span><span class="p">)</span>
<span class="o">--</span><span class="nb">print</span><span class="o">-</span><span class="n">models</span> <span class="p">(</span><span class="n">debugging</span> <span class="n">modes</span> <span class="n">writes</span> <span class="n">the</span> <span class="n">models</span> <span class="n">to</span> <span class="n">the</span> <span class="n">log</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that these constraints are defined, the mixed integer linear program (MILP)
follows from the layout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NOTES</span><span class="p">:</span> <span class="n">variable</span> <span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="ow">is</span> <span class="n">number</span> <span class="n">of</span> <span class="n">tasks</span> <span class="n">assigned</span> <span class="k">for</span> <span class="n">component</span> <span class="n">c</span>
       <span class="n">variable</span> <span class="n">NB</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">blocks</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">component</span> <span class="n">c</span>
       <span class="n">constant</span> <span class="n">C</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_i</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">cost</span> <span class="n">contributed</span> <span class="n">by</span> <span class="n">component</span> <span class="n">c</span> <span class="kn">from</span>
                     <span class="nn">timing</span> <span class="n">data</span> <span class="nb">set</span> <span class="n">i</span>
       <span class="n">constant</span> <span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_i</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">ntasks</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">component</span> <span class="n">c</span> <span class="kn">from</span>
                     <span class="nn">timing</span> <span class="n">data</span> <span class="nb">set</span> <span class="n">i</span>

         <span class="n">____________________</span>
        <span class="o">|</span> <span class="n">ICE</span>  <span class="o">|</span>  <span class="n">LND</span>  <span class="o">|</span>     <span class="o">|</span>
  <span class="n">T1</span>    <span class="o">|</span><span class="n">______</span><span class="o">|</span><span class="n">_______</span><span class="o">|</span>     <span class="o">|</span>
        <span class="o">|</span>              <span class="o">|</span> <span class="n">OCN</span> <span class="o">|</span>
        <span class="o">|</span>    <span class="n">ATM</span>       <span class="o">|</span>     <span class="o">|</span>
  <span class="n">T</span>     <span class="o">|</span><span class="n">______________</span><span class="o">|</span><span class="n">_____</span><span class="o">|</span>

 <span class="n">Min</span> <span class="n">T</span>
 <span class="n">s</span><span class="o">.</span><span class="n">t</span><span class="o">.</span>  <span class="n">Tice</span>      <span class="o">&lt;=</span> <span class="n">T1</span>
       <span class="n">Tlnd</span>      <span class="o">&lt;=</span> <span class="n">T1</span>
       <span class="n">T1</span> <span class="o">+</span> <span class="n">Tatm</span> <span class="o">&lt;=</span> <span class="n">T</span>
       <span class="n">Tocn</span>      <span class="o">&lt;=</span> <span class="n">T</span>

       <span class="n">NB</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>        <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ice</span><span class="p">,</span><span class="n">lnd</span><span class="p">,</span><span class="n">ocn</span><span class="p">,</span><span class="n">atm</span><span class="p">]</span>
       <span class="n">N</span><span class="p">[</span><span class="n">ice</span><span class="p">]</span> <span class="o">+</span> <span class="n">N</span><span class="p">[</span><span class="n">lnd</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">[</span><span class="n">atm</span><span class="p">]</span>
       <span class="n">N</span><span class="p">[</span><span class="n">atm</span><span class="p">]</span> <span class="o">+</span> <span class="n">N</span><span class="p">[</span><span class="n">ocn</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">TotalTasks</span>
       <span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">*</span> <span class="n">NB</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ice</span><span class="p">,</span><span class="n">lnd</span><span class="p">,</span><span class="n">ocn</span><span class="p">,</span><span class="n">atm</span><span class="p">]</span>


       <span class="n">T</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>        <span class="o">&gt;=</span> <span class="n">C</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="p">}</span> <span class="o">-</span> <span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="p">}</span> <span class="o">*</span>
                  <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span> <span class="o">-</span> <span class="n">C</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="p">})</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span> <span class="o">-</span> <span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="p">})</span>
                  <span class="o">+</span> <span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span> <span class="o">-</span> <span class="n">C</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="p">})</span>
                                          <span class="o">/</span> <span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span> <span class="o">-</span> <span class="n">N</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="p">}),</span>
                   <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mf">0.</span><span class="o">.</span><span class="c1">#data points (original + extrapolated,</span>
                       <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ice</span><span class="p">,</span><span class="n">lnd</span><span class="p">,</span><span class="n">ocn</span><span class="p">,</span><span class="n">atm</span><span class="p">]</span>
       <span class="nb">all</span> <span class="n">T</span> <span class="nb">vars</span> <span class="o">&gt;=</span><span class="mi">0</span>
       <span class="nb">all</span> <span class="n">N</span><span class="p">,</span><span class="n">NB</span> <span class="nb">vars</span> <span class="n">integer</span>
</pre></div>
</div>
<p>This MILP is solved using the PuLP python interface to the COIN-CBC solver
<a class="reference external" href="https://pythonhosted.org/PuLP/">https://pythonhosted.org/PuLP/</a>
<a class="reference external" href="https://www.coin-or.org/Cbc/">https://www.coin-or.org/Cbc/</a></p>
</section>
<section id="extending-the-load-balancing-tool">
<h2><span class="section-number">2.4. </span>Extending the Load Balancing Tool<a class="headerlink" href="#extending-the-load-balancing-tool" title="Link to this heading"></a></h2>
<p>The file $CIME_DIR/tools/load_balancing_tool/optimize_model.py
contains a base class OptimizeModel as well as an implementation class
IceLndAtmOcn. Any layout solver will look similar to IceLndAtmOcn
except for the components involved and the layout-specific constraints.</p>
<p>Example class and inherited methods that should be overridden:</p>
<p>file my_new_layout.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">optimize_model</span>

<span class="k">class</span> <span class="nc">MyNewLayout</span><span class="p">(</span><span class="n">optimize_model</span><span class="o">.</span><span class="n">OptimizeModel</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">get_required_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">       </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Should be overridden by derived class. Return a list of required</span>
<span class="sd">       components (capitalized) used in the layout.</span>
<span class="sd">       Example: return [&#39;ATM&#39;, &#39;LND&#39;, &#39;ICE&#39;]</span>
<span class="sd">       &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the optimization.</span>
<span class="sd">        Must set self.state using LpStatus object</span>
<span class="sd">        LpStatusOptimal    -&gt; STATE_SOLVED_OK</span>
<span class="sd">        LpStatusNotSolved  -&gt; STATE_UNSOLVED</span>
<span class="sd">        LpStatusInfeasible -&gt; STATE_SOLVED_BAD</span>
<span class="sd">        LpStatusUnbounded  -&gt; STATE_SOLVED_BAD</span>
<span class="sd">        LpStatusUndefined  -&gt; STATE_UNDEFINED</span>
<span class="sd">        -- use self.set_state(lpstatus) --</span>
<span class="sd">        Returns state</span>

<span class="sd">        If solved, then solution will be stored in self.X dictionary, indexed</span>
<span class="sd">        by variable name. Suggested convention:</span>
<span class="sd">        &#39;Tice&#39;, &#39;Tlnd&#39;, ... for cost per component</span>
<span class="sd">        &#39;Nice&#39;, &#39;Nlnd&#39;, ... for ntasks per component</span>
<span class="sd">        &#39;NBice&#39;, &#39;NBlnd&#39;, ... for number of blocks per component</span>

<span class="sd">        The default implementation of get_solution() returns a dictionary</span>
<span class="sd">        of these variable keys and their values.</span>
<span class="sd">        &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">get_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">       </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Return a dictionary of the solution variables, can be overridden.</span>
<span class="sd">       Default implementation returns values in self.X</span>
<span class="sd">       &quot;&quot;&quot;</span>
</pre></div>
</div>
<dl>
<dt>To use this new layout:</dt><dd><ol class="arabic">
<li><p>save the class MyNewLayout in file my_new_layout.py</p></li>
<li><p>make sure that my_new_layout.py is in PYTHONPATH</p></li>
<li><p>Use those names in your execution command line argument to –layout</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./load_balancing_solve.py ... --layout my_new_layout.MyNewLayout
</pre></div>
</div>
</li>
</ol>
</dd>
</dl>
<p>To permanently add to CIME:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>add MyNewLayout class to layouts.py</p></li>
<li><p>run using ‘–layout MyNewLayout’</p></li>
<li><p>add test in tests/load_balance_test.py that uses that name in command
line argument (see test for atm_lnd)</p></li>
<li><p>make pull request</p></li>
</ol>
</div></blockquote>
</section>
<section id="testing">
<h2><span class="section-number">2.5. </span>Testing<a class="headerlink" href="#testing" title="Link to this heading"></a></h2>
<p>To run the provided test suite:</p>
<blockquote>
<div><ol class="arabic">
<li><p>set PYTHONPATH to include CIME libraries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ export CIME_DIR=/path/to/cime
$ export PYTHONPATH=$CIME_DIR/scripts:$CIME_DIR/tools/load_balancing_tool
</pre></div>
</div>
</li>
<li><p>To run an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd $CIME_DIR/tools/load_balancing_tool
$ ./load_balancing_solve.py --json-input tests/example.json --blocksize 8
Solving Mixed Integer Linear Program using PuLP interface to COIN-CBC
PuLP solver status: Solved
COST_ATM = 22.567587
COST_ICE = 1.375768
COST_LND = 1.316000
COST_OCN = 15.745000
COST_TOTAL = 23.943355
NBLOCKS_ATM = 124
NBLOCKS_ICE = 109
NBLOCKS_LND = 15
NBLOCKS_OCN = 4
NTASKS_ATM = 992
NTASKS_ICE = 872
NTASKS_LND = 120
NTASKS_OCN = 32
NTASKS_TOTAL = 1024
</pre></div>
</div>
</li>
<li><p>To run the test suite:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd $CIME_DIR/tools/load_balancing_tool
$ ./tests/load_balancing_test.py
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ect.html" class="btn btn-neutral float-left" title="1. CESM-ECT (CESM Ensemble Consistency Test):" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../glossary/index.html" class="btn btn-neutral float-right" title="Glossary" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  

  <script type="text/javascript">
    let baseUriRegex = /(.*\/cime)\/.*/g;
    let parsedUri = baseUriRegex.exec(document.baseURI);

    if (parsedUri != null && parsedUri.length == 2) {
      let baseUri = parsedUri[1];

      $.get(`${baseUri}/versions/versions.json`, function(data) {
        let versionElement = $("#versions");

        Object.keys(data).forEach(function(key) {
          let value = data[key];

          let item = `<dd><a href="${baseUri}/versions/${key}/html/">${value}</a></dd>`

          versionElement.append(item);
        });
      });
    }
  </script>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: master
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl id="versions">
        <dt>Versions</dt>
      </dl>
      
      
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>