

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3.1. Time Management &#8212; on  documentation</title>
    
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.2. Grids" href="grids.html" />
    <link rel="prev" title="3. Implementation" href="implementation.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="grids.html" title="3.2. Grids"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="implementation.html" title="3. Implementation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">on  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >CIME Driver/Coupler</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="implementation.html" accesskey="U">3. Implementation</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3.1. Time Management</a><ul>
<li><a class="reference internal" href="#driver-clocks">3.1.1. Driver Clocks</a></li>
<li><a class="reference internal" href="#the-driver-time-loop">3.1.2. The Driver Time Loop</a></li>
<li><a class="reference internal" href="#coupling-frequency">3.1.3. Coupling Frequency</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="implementation.html"
                        title="previous chapter">3. Implementation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="grids.html"
                        title="next chapter">3.2. Grids</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/driver_cpl/time-management.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="time-management">
<h1>3.1. Time Management<a class="headerlink" href="#time-management" title="Permalink to this headline">¶</a></h1>
<div class="section" id="driver-clocks">
<h2>3.1.1. Driver Clocks<a class="headerlink" href="#driver-clocks" title="Permalink to this headline">¶</a></h2>
<p>The driver manages the main clock in the system.
The main clock advances at the shortest coupling period and uses alarms to trigger component coupling and other events.
In addition, the driver maintains a clock that is associated with each component.
The driver&#8217;s component clocks have a timestep associated with the coupling period of that component.
The main driver clock and the component clocks in the driver advance in a coordinated manor and are always synchronized.
The advancement of time is managed as follows in the main run loop.
First, the main driver clock advances one timestep and the component clocks are advanced in a synchronous fashion.
The clock time represents the time at the end of the next model timestep.
Alarms may be triggered at that timestep to call the the atmosphere, land, runoff, sea ice, land ice, or ocean run methods.
If a component run alarm is triggered, the run method is called and the driver passes that component&#8217;s clock to that component.
The component clock contains information about the length of the next component integration and the expected time of the component at the end of the integration period.</p>
<p>Generally, the component models have indepedent time management software.
When a component run method is called, the component must advance the proper period and also check that their internal clock is consistent with the coupling clock before returning to the driver.
The clock passed to the component by the driver contains this information.
Component models are also responsible for making sure the coupling period is consistent with their internal timestep.
History files are managed independently by each component, but restart files are coordinated by the driver.</p>
<p>The driver clocks are based on ESMF clock datatype are are supported in software by either an official ESMF library or by software included in CIME called <code class="docutils literal"><span class="pre">esmf_wrf_timemgr</span></code>, which is a much simplified Fortran implementation of a subset of the ESMF time manager interfaces.</p>
</div>
<div class="section" id="the-driver-time-loop">
<h2>3.1.2. The Driver Time Loop<a class="headerlink" href="#the-driver-time-loop" title="Permalink to this headline">¶</a></h2>
<p>The driver time loop is hardwired to sequence the component models in a specific way to meet scientific requirements and to otherwise provide the maximum amount of potential concurrency of work.
The results of the model integration are not dependent on the processor layout of the components.
See the Craig et al IJHPCA 2012 reference for further details.</p>
<p>In addition, the driver is currently configured to couple the atmosphere, land, and sea ice models using the same coupling frequency while the runoff, land ice, and ocean model can be coupled at the same or at a lower frequency.
To support this feature, the driver does temporal averaging of coupling inputs to the ocean and runoff, and the driver also computes the surface ocean albedo at the higher coupling frequency.
There is no averaging of coupling fields for other component coupling interactions and the land and sea ice models&#8217; surface albedos are computed inside those components.
Averaging functionality could be added to the driver to support alternative relative coupling schemes in the future if desired with the additional caveat that the interaction between the surface albedo computation in each component and the atmospheric radiation calculation have to be carefully considered.
In addition, some other features may need to be extended to support other coupling schemes and still allow model concurrency.</p>
<p>The coupler processors (pes) handle the interaction of data between components, so there are separate tasks associated with deriving fields on the coupler pes, transfering data to and from the coupler pes and other components, and then running the component models on their processors.
The driver time loop is basically sequenced as follows,</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">The</span> <span class="n">driver</span> <span class="n">clock</span> <span class="ow">is</span> <span class="n">advanced</span> <span class="n">first</span> <span class="ow">and</span> <span class="n">alarms</span> <span class="nb">set</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Input</span> <span class="n">data</span> <span class="k">for</span> <span class="n">ocean</span><span class="p">,</span> <span class="n">land</span><span class="p">,</span> <span class="n">sea</span> <span class="n">ice</span><span class="p">,</span> <span class="ow">and</span> <span class="n">runoff</span> <span class="ow">is</span> <span class="n">computed</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Ocean</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">coupler</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ocean</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Land</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">coupler</span> <span class="n">to</span> <span class="n">the</span> <span class="n">land</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Ice</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">coupler</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ice</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Runoff</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">coupler</span> <span class="n">to</span> <span class="n">the</span> <span class="n">ice</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">ice</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">run</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">land</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">run</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">runoff</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">run</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">ocean</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">run</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">ocean</span> <span class="n">inputs</span> <span class="n">are</span> <span class="n">accumulated</span><span class="p">,</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">atmosphere</span><span class="o">/</span><span class="n">ocean</span> <span class="n">fluxes</span> <span class="n">are</span>
  <span class="n">computed</span> <span class="n">on</span> <span class="n">the</span> <span class="n">coupler</span> <span class="n">pes</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">results</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">previous</span>
  <span class="n">atmosphere</span> <span class="ow">and</span> <span class="n">ocean</span> <span class="n">coupled</span> <span class="n">timestep</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Land</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">land</span> <span class="n">pes</span> <span class="n">to</span> <span class="n">the</span> <span class="n">coupler</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Land</span> <span class="n">ice</span> <span class="nb">input</span> <span class="ow">is</span> <span class="n">computed</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Land</span> <span class="n">ice</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">coupler</span> <span class="n">to</span> <span class="n">the</span> <span class="n">land</span> <span class="n">ice</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">River</span> <span class="n">output</span> <span class="p">(</span><span class="n">runoff</span><span class="p">)</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">runoff</span> <span class="n">pes</span> <span class="n">to</span> <span class="n">the</span> <span class="n">coupler</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Ice</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">ice</span> <span class="n">pes</span> <span class="n">to</span> <span class="n">the</span> <span class="n">coupler</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Coupler</span> <span class="n">fractions</span> <span class="n">are</span> <span class="n">updated</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Atmospheric</span> <span class="n">forcing</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">computed</span> <span class="n">on</span> <span class="n">the</span> <span class="n">coupler</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Atmospheric</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">coupler</span> <span class="n">pes</span> <span class="n">to</span> <span class="n">the</span> <span class="n">atmosphere</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">atmosphere</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">run</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">land</span> <span class="n">ice</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">run</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Land</span> <span class="n">ice</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">land</span> <span class="n">ice</span> <span class="n">pes</span> <span class="n">to</span> <span class="n">the</span> <span class="n">coupler</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Atmospheric</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">atmosphere</span> <span class="n">pes</span> <span class="n">to</span> <span class="n">the</span> <span class="n">coupler</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">Ocean</span> <span class="n">data</span> <span class="ow">is</span> <span class="n">rearranged</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">ocean</span> <span class="n">pes</span> <span class="n">to</span> <span class="n">the</span> <span class="n">coupler</span> <span class="n">pes</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">loop</span> <span class="n">returns</span>

 <span class="n">Within</span> <span class="n">this</span> <span class="n">loop</span><span class="p">,</span> <span class="k">as</span> <span class="n">much</span> <span class="k">as</span> <span class="n">possible</span><span class="p">,</span> <span class="n">coupler</span> <span class="n">work</span> <span class="n">associated</span>
 <span class="k">with</span> <span class="n">mapping</span> <span class="n">data</span><span class="p">,</span> <span class="n">merging</span> <span class="n">fields</span><span class="p">,</span> <span class="n">diagnosing</span><span class="p">,</span> <span class="n">applying</span> <span class="n">area</span> <span class="n">corrections</span><span class="p">,</span>
 <span class="ow">and</span> <span class="n">computing</span> <span class="n">fluxes</span> <span class="ow">is</span> <span class="n">overlapped</span> <span class="k">with</span> <span class="n">component</span> <span class="n">work</span><span class="o">.</span>
</pre></div>
</div>
<p>The land ice model interaction is slightly different.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">The</span> <span class="n">land</span> <span class="n">ice</span> <span class="n">model</span> <span class="ow">is</span> <span class="n">run</span> <span class="n">on</span> <span class="n">the</span> <span class="n">land</span> <span class="n">grid</span>
<span class="o">-</span> <span class="n">Land</span> <span class="n">model</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">the</span> <span class="n">land</span> <span class="n">ice</span> <span class="n">model</span> <span class="n">every</span> <span class="n">land</span> <span class="n">coupling</span> <span class="n">period</span><span class="o">.</span>
<span class="o">-</span> <span class="n">The</span> <span class="n">driver</span> <span class="n">accumluates</span> <span class="n">this</span> <span class="n">data</span><span class="p">,</span> <span class="n">interpolates</span> <span class="n">the</span> <span class="n">data</span> <span class="n">to</span> <span class="n">the</span> <span class="n">land</span> <span class="n">ice</span> <span class="n">grid</span><span class="p">,</span>
  <span class="ow">and</span> <span class="n">the</span> <span class="n">land</span> <span class="n">ice</span> <span class="n">model</span> <span class="n">advances</span> <span class="n">the</span> <span class="n">land</span> <span class="n">ice</span> <span class="n">model</span> <span class="n">about</span> <span class="n">once</span> <span class="n">a</span> <span class="n">year</span><span class="o">.</span>
</pre></div>
</div>
<p>The runoff coupling should be coupled at a frequency between the land coupling and ocean coupling frequencies. The runoff model runs at the same time as the land and sea ice models when it runs.</p>
<p>The current driver sequencing has been developed over nearly two decades, and it plays a critical role in conserving mass and heat, minimizing lags, and providing stability in the system.
The above description is consistent with the concurrency limitations described <a class="reference external" href="http://www.cesm.ucar.edu/models/cesm2.0/cpl7/doc.new/x32.html#design_seq">here</a>.
Just to reiterate, the land, runoff, and sea ice models will always run before the atmospheric model, and the coupler and ocean models are able to run concurrently with all other components.
The coupling between the atmosphere, land, sea ice, and atmosphere/ocean flux computation incurs no lags but the coupling to the ocean state is lagged by one ocean coupling period in the system.
Mass and heat are conserved in the system with more description <a class="reference external" href="http://www.cesm.ucar.edu/models/cesm2.0/cpl7/doc.new/x168.html">here</a>.</p>
<p>It is possible to reduce the ocean lag in the system.
A driver namelist variable, <code class="docutils literal"><span class="pre">ocean_tight_coupling</span></code>, moves the step where ocean data is rearranged from the ocean pes to the coupler pes from the end of the loop to before the atmosphere/ocean flux computation.
If ocean_tight_coupling is set to true, then the ocean lag is reduced by one atmosphere coupling period, but the ability of the ocean model to run concurrently with the atmosphere model is also reduced or eliminated.
This flag is most useful when the ocean coupling frequency matches the other components.</p>
</div>
<div class="section" id="coupling-frequency">
<h2>3.1.3. Coupling Frequency<a class="headerlink" href="#coupling-frequency" title="Permalink to this headline">¶</a></h2>
<p>In the current implementation, the coupling period must be identical for the atmosphere, sea ice, and land components.
The ocean coupling period can be the same or greater.
The runoff coupling period should be between or the same as the land and ocean coupling period.
All coupling periods must be multiple integers of the smallest coupling period and will evenly divide the NCPL_BASE_PERIOD, typically one day, set in env_run.xml.
The coupling periods are set using the NCPL env variables in env_run.xml.</p>
<p>The coupling periods are set in the driver namelist for each component via variables called something like atm_cpl_dt and atm_cpl_offset.
The units of these inputs are seconds.
The coupler template file derives these values from CIME script variable names like ATM_NCPL which is the coupling frequency per day.
The *_cpl_dt input specifies the coupling period in seconds and the *_cpl_offset input specifies the temporal offset of the coupling time relative to initial time.
An example of an offset might be a component that couples every six hours.
That would normally be on the 6th, 12th, 18th, and 24th hour of every day.
An offset of 3600 seconds would change the coupling to the 1st, 7th, 13th, and 19th hour of every day.
The offsets cannot be larger than the coupling period and the sign of the offsets is such that a positive offset shifts the alarm time forward by that number of seconds.
The offsets are of limited use right now because of the limitations of the relative coupling frequencies.</p>
<p>Offsets play an important role in supporting concurrency.
There is an offset of the smallest coupling period automatically introduced in every coupling run alarm for each component clock.
This is only mentioned because it is an important but subtle point of the implementation and changing the coupling offset could have an impact on concurrency performance.
Without this explicit automatic offset, the component run alarms would trigger at the end of the coupling period.
This is fine for components that are running at the shortest coupling period, but will limit the ability of models to run concurrently for models that couple at longer periods.
What is really required for concurrency is that the run alarm be triggered as early as possible and that the data not be copied from that component to the coupler pes until the coupling period has ended.
The detailed implementation of this feature is documented in the seq_timemgr_mod.
90 file and the impact of it for the ocean coupling is implemented in the ccsm_driver.F90 code via use of the ocnrun_alarm and ocnnext_alarm variables.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="grids.html" title="3.2. Grids"
             >next</a> |</li>
        <li class="right" >
          <a href="implementation.html" title="3. Implementation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">on  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >CIME Driver/Coupler</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="implementation.html" >3. Implementation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Mariana Vertenstein, Rob Jacob, Jim Edwards, Jim Foucar, Alice Bertini.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>