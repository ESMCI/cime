! DON'T MODIFY THIS FILE, ALL YOUR CHANGES WILL BE LOST
! This file is generated by ../../../tests/general/util/pio_tf_f90gen.pl
! from /home/ed/tmp/ParallelIO/tests/general/ncdf_fail.F90.in

MODULE ncdf_fail_tgv   ! ncdf_fail.F90.in:1
  use pio_tutil   ! ncdf_fail.F90.in:2
  implicit none   ! ncdf_fail.F90.in:3


  ! tgv = test global vars
  character(len=PIO_TF_MAX_STR_LEN), parameter :: tgv_fname = "pio_ncdf_test_file.nc"   ! ncdf_fail.F90.in:6
  integer :: tgv_iotype   ! ncdf_fail.F90.in:7
END MODULE ncdf_fail_tgv   ! ncdf_fail.F90.in:8


SUBROUTINE test_clob_then_no_clob
  USE pio_tutil
   ! ncdf_fail.F90.in:10
  use ncdf_fail_tgv   ! ncdf_fail.F90.in:11
  Implicit none   ! ncdf_fail.F90.in:12
  type(file_desc_t) :: pio_file   ! ncdf_fail.F90.in:13
  character(len=PIO_TF_MAX_STR_LEN), parameter :: clob_fname = "pio_clob_test_file.nc"   ! ncdf_fail.F90.in:14
  integer :: ret   ! ncdf_fail.F90.in:15


  ret = PIO_createfile(pio_tf_iosystem_, pio_file, tgv_iotype, clob_fname, PIO_CLOBBER)   ! ncdf_fail.F90.in:17
  
  IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: PIO Function failed:",&
         "Failed to create:" // trim(clob_fname),&
        ":", __FILE__, ":", __LINE__,&
        "(ncdf_fail.F90.in:18)"
    END IF
    RETURN
  END IF   ! ncdf_fail.F90.in:18


  call PIO_closefile(pio_file)   ! ncdf_fail.F90.in:20


  ret = PIO_createfile(pio_tf_iosystem_, pio_file, tgv_iotype, clob_fname, PIO_NOCLOBBER)   ! ncdf_fail.F90.in:22
  
  IF (.NOT. (PIO_TF_Passert_(ret /= PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Assertion failed :",&
         "Create file with clobber then no clobber did not fail as expected",&
         ":", __FILE__, ":", __LINE__,&
        "(ncdf_fail.F90.in:23)"
    END IF
    RETURN
  END IF   ! ncdf_fail.F90.in:23


  ! No close since createfile should fail
  call PIO_deletefile(pio_tf_iosystem_, clob_fname)   ! ncdf_fail.F90.in:26


END SUBROUTINE test_clob_then_no_clob   ! ncdf_fail.F90.in:28


SUBROUTINE test_redef_with_no_write
  USE pio_tutil
   ! ncdf_fail.F90.in:30
  use ncdf_fail_tgv   ! ncdf_fail.F90.in:31
  Implicit none   ! ncdf_fail.F90.in:32
  type(file_desc_t) :: pio_file   ! ncdf_fail.F90.in:33
  integer :: ret   ! ncdf_fail.F90.in:34


  ret = PIO_openfile(pio_tf_iosystem_, pio_file, tgv_iotype, tgv_fname, PIO_nowrite)   ! ncdf_fail.F90.in:36
  
  IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: PIO Function failed:",&
         "Failed to open:" // trim(tgv_fname),&
        ":", __FILE__, ":", __LINE__,&
        "(ncdf_fail.F90.in:37)"
    END IF
    RETURN
  END IF   ! ncdf_fail.F90.in:37


  ! A simple redef and then enddef
  ret = PIO_redef(pio_file)   ! ncdf_fail.F90.in:40
  
  IF (.NOT. (PIO_TF_Passert_(ret /= PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Assertion failed :",&
         "Redef with nowrite did not fail as expected",&
         ":", __FILE__, ":", __LINE__,&
        "(ncdf_fail.F90.in:41)"
    END IF
    RETURN
  END IF   ! ncdf_fail.F90.in:41


  ! No enddef because redef is expected to fail
  call PIO_closefile(pio_file)   ! ncdf_fail.F90.in:44


END SUBROUTINE test_redef_with_no_write   ! ncdf_fail.F90.in:46


SUBROUTINE test_redef_twice
  USE pio_tutil
   ! ncdf_fail.F90.in:48
  use ncdf_fail_tgv   ! ncdf_fail.F90.in:49
  Implicit none   ! ncdf_fail.F90.in:50
  type(file_desc_t) :: pio_file   ! ncdf_fail.F90.in:51
  integer :: ret   ! ncdf_fail.F90.in:52


  ret = PIO_openfile(pio_tf_iosystem_, pio_file, tgv_iotype, tgv_fname, PIO_write)   ! ncdf_fail.F90.in:54
  
  IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: PIO Function failed:",&
         "Failed to open:" // trim(tgv_fname),&
        ":", __FILE__, ":", __LINE__,&
        "(ncdf_fail.F90.in:55)"
    END IF
    RETURN
  END IF   ! ncdf_fail.F90.in:55


  ! A simple redef and then enddef
  ret = PIO_redef(pio_file)   ! ncdf_fail.F90.in:58
  
  IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: PIO Function failed:",&
         "Failed to enter redef mode" // trim(tgv_fname),&
        ":", __FILE__, ":", __LINE__,&
        "(ncdf_fail.F90.in:59)"
    END IF
    RETURN
  END IF   ! ncdf_fail.F90.in:59


  ret = PIO_redef(pio_file)   ! ncdf_fail.F90.in:61
  
  IF (.NOT. (PIO_TF_Passert_(ret /= PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Assertion failed :",&
         "Entering redef twice did not fail as expected",&
         ":", __FILE__, ":", __LINE__,&
        "(ncdf_fail.F90.in:62)"
    END IF
    RETURN
  END IF   ! ncdf_fail.F90.in:62


  ret = PIO_enddef(pio_file)   ! ncdf_fail.F90.in:64
  
  IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: PIO Function failed:",&
         "Failed to end redef mode" // trim(tgv_fname),&
        ":", __FILE__, ":", __LINE__,&
        "(ncdf_fail.F90.in:65)"
    END IF
    RETURN
  END IF   ! ncdf_fail.F90.in:65


  call PIO_closefile(pio_file)   ! ncdf_fail.F90.in:67


END SUBROUTINE test_redef_twice   ! ncdf_fail.F90.in:69


SUBROUTINE PIO_TF_Test_driver_
  USE pio_tutil
   ! ncdf_fail.F90.in:71
  use ncdf_fail_tgv   ! ncdf_fail.F90.in:72
  Implicit none   ! ncdf_fail.F90.in:73
  type(file_desc_t) :: pio_file   ! ncdf_fail.F90.in:74
  integer :: ret, i   ! ncdf_fail.F90.in:75
  ! iotypes = valid NC types
  integer, dimension(:), allocatable :: iotypes   ! ncdf_fail.F90.in:77
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! ncdf_fail.F90.in:78
  integer :: num_iotypes   ! ncdf_fail.F90.in:79


  num_iotypes = 0   ! ncdf_fail.F90.in:81
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! ncdf_fail.F90.in:82
  do i=1,num_iotypes   ! ncdf_fail.F90.in:83
    tgv_iotype = iotypes(i)   ! ncdf_fail.F90.in:84
    ret = PIO_createfile(pio_tf_iosystem_, pio_file, tgv_iotype, tgv_fname)   ! ncdf_fail.F90.in:85
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
                "Failed to create:"//trim(iotype_descs(i))//":"//trim(tgv_fname),&
          ":", __FILE__, ":", __LINE__,&
          "(ncdf_fail.F90.in:87)"
      END IF
      RETURN
    END IF   ! ncdf_fail.F90.in:87


    call PIO_closefile(pio_file)   ! ncdf_fail.F90.in:89


    ! Make sure that global variables are set correctly before running the tests
    
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: Running AUTO tests: ", trim(iotype_descs(i))
      END IF
      pio_tf_retval_utest_ = 0
      pio_tf_tmp_log_str_="test_clob_then_no_clob"//"("//trim(iotype_descs(i))//")"
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: Starting test_clob_then_no_clob"
      END IF
      CALL test_clob_then_no_clob()
      IF (pio_tf_retval_utest_ /= 0) THEN
        pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
      END IF
      IF (pio_tf_world_rank_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
            pio_tf_tmp_log_str_,&
            "---------","PASSED"
        ELSE
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
            pio_tf_tmp_log_str_,&
            "---------","FAILED"
        END IF
      END IF
      pio_tf_retval_utest_ = 0
      pio_tf_tmp_log_str_="test_redef_with_no_write"//"("//trim(iotype_descs(i))//")"
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: Starting test_redef_with_no_write"
      END IF
      CALL test_redef_with_no_write()
      IF (pio_tf_retval_utest_ /= 0) THEN
        pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
      END IF
      IF (pio_tf_world_rank_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
            pio_tf_tmp_log_str_,&
            "---------","PASSED"
        ELSE
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
            pio_tf_tmp_log_str_,&
            "---------","FAILED"
        END IF
      END IF
      pio_tf_retval_utest_ = 0
      pio_tf_tmp_log_str_="test_redef_twice"//"("//trim(iotype_descs(i))//")"
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: Starting test_redef_twice"
      END IF
      CALL test_redef_twice()
      IF (pio_tf_retval_utest_ /= 0) THEN
        pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
      END IF
      IF (pio_tf_world_rank_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 3:",&
            pio_tf_tmp_log_str_,&
            "---------","PASSED"
        ELSE
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 3:",&
            pio_tf_tmp_log_str_,&
            "---------","FAILED"
        END IF
      END IF
   ! ncdf_fail.F90.in:92


    call PIO_deletefile(pio_tf_iosystem_, tgv_fname)   ! ncdf_fail.F90.in:94
  end do   ! ncdf_fail.F90.in:95
  if(allocated(iotypes)) then   ! ncdf_fail.F90.in:96
    deallocate(iotypes)   ! ncdf_fail.F90.in:97
    deallocate(iotype_descs)   ! ncdf_fail.F90.in:98
  end if   ! ncdf_fail.F90.in:99



END SUBROUTINE PIO_TF_Test_driver_   ! ncdf_fail.F90.in:101


  PROGRAM PIO_TF_Test_main_
    USE pio_tutil
    IMPLICIT NONE
    INTEGER, PARAMETER :: NREARRS = 2
    INTEGER :: rearrs(NREARRS) = (/pio_rearr_subset,pio_rearr_box/)
    CHARACTER(LEN=PIO_TF_MAX_STR_LEN) :: rearrs_info(NREARRS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)
    INTEGER i, ierr

    pio_tf_nerrs_total_=0
    pio_tf_retval_utest_=0
    CALL MPI_Init(ierr)
    DO i=1,SIZE(rearrs)
      CALL PIO_TF_Init_(rearrs(i))
      IF (pio_tf_world_rank_ == 0) THEN
        WRITE(*,*) "PIO_TF: Testing : ", trim(rearrs_info(i))
      END IF
      CALL PIO_TF_Test_driver_()
      CALL PIO_TF_Finalize_()
    END DO
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_nerrs_total_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "All tests", "---------", "PASSED"
        ELSE
          pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "Test driver", "---------", "FAILED"
        END IF
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT2) "PIO_TF:[",&
          pio_tf_nerrs_total_,"] Tests",&
          "----- FAILED"
      END IF
    END IF
    CALL MPI_Finalize(ierr)
    IF (pio_tf_nerrs_total_ /= 0) THEN
      STOP 99
    END IF
  END PROGRAM
