! DON'T MODIFY THIS FILE, ALL YOUR CHANGES WILL BE LOST
! This file is generated by ../../../tests/general/util/pio_tf_f90gen.pl
! from /home/ed/tmp/ParallelIO/tests/general/pio_file_fail.F90.in

# 1 "pio_file_fail.F90.in"
SUBROUTINE create_file_always_fail(iotype, filename)
  USE pio_tutil
   ! pio_file_fail.F90.in:1
  implicit none   ! pio_file_fail.F90.in:2
  integer,  intent(in)  :: iotype   ! pio_file_fail.F90.in:3
  character(len=PIO_TF_MAX_STR_LEN),  intent(in)  :: filename   ! pio_file_fail.F90.in:4


  type(file_desc_t) :: pio_file   ! pio_file_fail.F90.in:6
  integer ierr   ! pio_file_fail.F90.in:7


  ! Original file creation
  ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotype, filename)   ! pio_file_fail.F90.in:10
  
  IF (.NOT. (PIO_TF_Passert_(ierr /= PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Assertion failed :",&
         "PIO_createfile did not fail as expected",&
         ":", __FILE__, ":", __LINE__,&
        "(pio_file_fail.F90.in:11)"
    END IF
    RETURN
  END IF   ! pio_file_fail.F90.in:11


END SUBROUTINE create_file_always_fail   ! pio_file_fail.F90.in:13


# 15 "pio_file_fail.F90.in"
SUBROUTINE open_file_always_fail(iotype, filename)
  USE pio_tutil
   ! pio_file_fail.F90.in:15
  implicit none   ! pio_file_fail.F90.in:16
  integer,  intent(in)  :: iotype   ! pio_file_fail.F90.in:17
  character(len=PIO_TF_MAX_STR_LEN),  intent(in)  :: filename   ! pio_file_fail.F90.in:18


  type(file_desc_t) :: pio_file   ! pio_file_fail.F90.in:20
  integer ierr   ! pio_file_fail.F90.in:21


  ! Test opening of file
  ierr = PIO_openfile(pio_tf_iosystem_, pio_file, iotype, filename, PIO_nowrite)   ! pio_file_fail.F90.in:24
  
  IF (.NOT. (PIO_TF_Passert_(ierr /= PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Assertion failed :",&
         "PIO_openfile did not fail as expected",&
         ":", __FILE__, ":", __LINE__,&
        "(pio_file_fail.F90.in:25)"
    END IF
    RETURN
  END IF   ! pio_file_fail.F90.in:25


END SUBROUTINE open_file_always_fail   ! pio_file_fail.F90.in:27


SUBROUTINE PIO_TF_Test_driver_
  USE pio_tutil
   ! pio_file_fail.F90.in:29
  implicit none   ! pio_file_fail.F90.in:30
  character(len=PIO_TF_MAX_STR_LEN) :: dummy_file   ! pio_file_fail.F90.in:31
  integer :: i   ! pio_file_fail.F90.in:32
  ! uiotypes = undefined nc io types
  integer, dimension(:), allocatable :: uiotypes   ! pio_file_fail.F90.in:34
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: uiotype_descs   ! pio_file_fail.F90.in:35
  integer :: num_uiotypes   ! pio_file_fail.F90.in:36


  num_uiotypes = 0   ! pio_file_fail.F90.in:38
  call PIO_TF_Get_undef_iotypes(uiotypes, uiotype_descs, num_uiotypes)    ! pio_file_fail.F90.in:39
  dummy_file = "test_pio_file_fail.testfile"   ! pio_file_fail.F90.in:40
  do i=1,num_uiotypes   ! pio_file_fail.F90.in:41
    
    pio_tf_retval_utest_ = 0
    pio_tf_tmp_log_str_="create_file_always_fail"//"("// trim(uiotype_descs(i))//")"
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting ",&
        pio_tf_tmp_log_str_
    END IF
    CALL create_file_always_fail(uiotypes(i), dummy_file)
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          pio_tf_tmp_log_str_,&
          "--------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          pio_tf_tmp_log_str_,&
          "--------", "FAILED"
      END IF
    END IF   ! pio_file_fail.F90.in:42
    
    pio_tf_retval_utest_ = 0
    pio_tf_tmp_log_str_="open_file_always_fail"//"("// trim(uiotype_descs(i))//")"
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting ",&
        pio_tf_tmp_log_str_
    END IF
    CALL open_file_always_fail(uiotypes(i), dummy_file)
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          pio_tf_tmp_log_str_,&
          "--------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          pio_tf_tmp_log_str_,&
          "--------", "FAILED"
      END IF
    END IF   ! pio_file_fail.F90.in:43
  end do   ! pio_file_fail.F90.in:44
  if(allocated(uiotypes)) then   ! pio_file_fail.F90.in:45
    deallocate(uiotypes)   ! pio_file_fail.F90.in:46
    deallocate(uiotype_descs)   ! pio_file_fail.F90.in:47
  end if   ! pio_file_fail.F90.in:48



END SUBROUTINE PIO_TF_Test_driver_   ! pio_file_fail.F90.in:50




  PROGRAM PIO_TF_Test_main_
    USE pio_tutil
    IMPLICIT NONE
    INTEGER, PARAMETER :: NREARRS = 2
    INTEGER :: rearrs(NREARRS) = (/pio_rearr_subset,pio_rearr_box/)
    CHARACTER(LEN=PIO_TF_MAX_STR_LEN) :: rearrs_info(NREARRS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)
    INTEGER i, ierr

    pio_tf_nerrs_total_=0
    pio_tf_retval_utest_=0
    CALL MPI_Init(ierr)
    DO i=1,SIZE(rearrs)
      CALL PIO_TF_Init_(rearrs(i))
      IF (pio_tf_world_rank_ == 0) THEN
        WRITE(*,*) "PIO_TF: Testing : ", trim(rearrs_info(i))
      END IF
      CALL PIO_TF_Test_driver_()
      CALL PIO_TF_Finalize_()
    END DO
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_nerrs_total_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "All tests", "---------", "PASSED"
        ELSE
          pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "Test driver", "---------", "FAILED"
        END IF
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT2) "PIO_TF:[",&
          pio_tf_nerrs_total_,"] Tests",&
          "----- FAILED"
      END IF
    END IF
    CALL MPI_Finalize(ierr)
    IF (pio_tf_nerrs_total_ /= 0) THEN
      STOP 99
    END IF
  END PROGRAM
