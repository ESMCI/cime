! DON'T MODIFY THIS FILE, ALL YOUR CHANGES WILL BE LOST
! This file is generated by ../../../tests/general/util/pio_tf_f90gen.pl
! from /home/ed/tmp/ParallelIO/tests/general/pio_file_simple_tests.F90.in

# 1 "pio_file_simple_tests.F90.in"
SUBROUTINE create_file_no_opts(iotype, filename)
  USE pio_tutil
   ! pio_file_simple_tests.F90.in:1
  implicit none   ! pio_file_simple_tests.F90.in:2
  integer,  intent(in)  :: iotype   ! pio_file_simple_tests.F90.in:3
  character(len=PIO_TF_MAX_STR_LEN),  intent(in)  :: filename   ! pio_file_simple_tests.F90.in:4


  type(file_desc_t) :: pio_file   ! pio_file_simple_tests.F90.in:6
  integer ierr   ! pio_file_simple_tests.F90.in:7


  ierr = PIO_createfile(pio_tf_iosystem_, pio_file, iotype, filename)   ! pio_file_simple_tests.F90.in:9
  
  IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: PIO Function failed:",&
         "Could not create " // trim(filename),&
        ":", __FILE__, ":", __LINE__,&
        "(pio_file_simple_tests.F90.in:10)"
    END IF
    RETURN
  END IF   ! pio_file_simple_tests.F90.in:10


  ! netcdf files need to end define mode before closing
  if (PIO_TF_Is_netcdf(iotype)) then   ! pio_file_simple_tests.F90.in:13
    ierr = PIO_enddef(pio_file)   ! pio_file_simple_tests.F90.in:14
    
    IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Could not end define mode: " // trim(filename),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_file_simple_tests.F90.in:15)"
      END IF
      RETURN
    END IF   ! pio_file_simple_tests.F90.in:15
  end if   ! pio_file_simple_tests.F90.in:16


  call PIO_closefile(pio_file)   ! pio_file_simple_tests.F90.in:18


END SUBROUTINE create_file_no_opts   ! pio_file_simple_tests.F90.in:20


# 22 "pio_file_simple_tests.F90.in"
SUBROUTINE open_file_no_write(iotype, filename)
  USE pio_tutil
   ! pio_file_simple_tests.F90.in:22
  implicit none   ! pio_file_simple_tests.F90.in:23
  integer,  intent(in)  :: iotype   ! pio_file_simple_tests.F90.in:24
  character(len=PIO_TF_MAX_STR_LEN),  intent(in)  :: filename   ! pio_file_simple_tests.F90.in:25


  type(file_desc_t) :: pio_file   ! pio_file_simple_tests.F90.in:27
  integer ierr   ! pio_file_simple_tests.F90.in:28


  ! Test opening of file
  ierr = PIO_openfile(pio_tf_iosystem_, pio_file, iotype, filename, PIO_nowrite)   ! pio_file_simple_tests.F90.in:31
  
  IF (.NOT. (PIO_TF_Passert_((ierr) == PIO_NOERR, pio_tf_comm_))) THEN
    pio_tf_retval_utest_ = -1
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: PIO Function failed:",&
         "Could not open " // trim(filename),&
        ":", __FILE__, ":", __LINE__,&
        "(pio_file_simple_tests.F90.in:32)"
    END IF
    RETURN
  END IF   ! pio_file_simple_tests.F90.in:32


  ! Close file
  call PIO_closefile(pio_file)   ! pio_file_simple_tests.F90.in:35


END SUBROUTINE open_file_no_write   ! pio_file_simple_tests.F90.in:37


# 39 "pio_file_simple_tests.F90.in"
SUBROUTINE delete_file(filename)
  USE pio_tutil
   ! pio_file_simple_tests.F90.in:39
  implicit none   ! pio_file_simple_tests.F90.in:40
  character(len=PIO_TF_MAX_STR_LEN),  intent(in)  :: filename   ! pio_file_simple_tests.F90.in:41


  call PIO_deletefile(pio_tf_iosystem_, filename)   ! pio_file_simple_tests.F90.in:43
END SUBROUTINE delete_file   ! pio_file_simple_tests.F90.in:44


SUBROUTINE PIO_TF_Test_driver_
  USE pio_tutil
   ! pio_file_simple_tests.F90.in:46
  implicit none   ! pio_file_simple_tests.F90.in:47
  character(len=PIO_TF_MAX_STR_LEN) :: dummy_file   ! pio_file_simple_tests.F90.in:48
  integer :: i   ! pio_file_simple_tests.F90.in:49
  ! iotypes = valid io types
  integer, dimension(:), allocatable :: iotypes   ! pio_file_simple_tests.F90.in:51
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_file_simple_tests.F90.in:52
  integer :: num_iotypes   ! pio_file_simple_tests.F90.in:53


  num_iotypes = 0   ! pio_file_simple_tests.F90.in:55
  call PIO_TF_Get_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_file_simple_tests.F90.in:56
  dummy_file = "test_pio_file_simple_tests.testfile"   ! pio_file_simple_tests.F90.in:57
  do i=1,num_iotypes   ! pio_file_simple_tests.F90.in:58
    
    pio_tf_retval_utest_ = 0
    pio_tf_tmp_log_str_="create_file_no_opts"//"("// trim(iotype_descs(i))//")"
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting ",&
        pio_tf_tmp_log_str_
    END IF
    CALL create_file_no_opts(iotypes(i), dummy_file)
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          pio_tf_tmp_log_str_,&
          "--------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          pio_tf_tmp_log_str_,&
          "--------", "FAILED"
      END IF
    END IF   ! pio_file_simple_tests.F90.in:59
    
    pio_tf_retval_utest_ = 0
    pio_tf_tmp_log_str_="open_file_no_write"//"("// trim(iotype_descs(i))//")"
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting ",&
        pio_tf_tmp_log_str_
    END IF
    CALL open_file_no_write(iotypes(i), dummy_file)
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          pio_tf_tmp_log_str_,&
          "--------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          pio_tf_tmp_log_str_,&
          "--------", "FAILED"
      END IF
    END IF   ! pio_file_simple_tests.F90.in:60
    
    pio_tf_retval_utest_ = 0
    pio_tf_tmp_log_str_="delete_file"//"("// trim(iotype_descs(i))//")"
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting ",&
        pio_tf_tmp_log_str_
    END IF
    CALL delete_file(dummy_file)
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 3:",&
          pio_tf_tmp_log_str_,&
          "--------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 3:",&
          pio_tf_tmp_log_str_,&
          "--------", "FAILED"
      END IF
    END IF   ! pio_file_simple_tests.F90.in:61
  end do   ! pio_file_simple_tests.F90.in:62
  if(allocated(iotypes)) then   ! pio_file_simple_tests.F90.in:63
    deallocate(iotypes)   ! pio_file_simple_tests.F90.in:64
    deallocate(iotype_descs)   ! pio_file_simple_tests.F90.in:65
  end if   ! pio_file_simple_tests.F90.in:66



END SUBROUTINE PIO_TF_Test_driver_   ! pio_file_simple_tests.F90.in:68


  PROGRAM PIO_TF_Test_main_
    USE pio_tutil
    IMPLICIT NONE
    INTEGER, PARAMETER :: NREARRS = 2
    INTEGER :: rearrs(NREARRS) = (/pio_rearr_subset,pio_rearr_box/)
    CHARACTER(LEN=PIO_TF_MAX_STR_LEN) :: rearrs_info(NREARRS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)
    INTEGER i, ierr

    pio_tf_nerrs_total_=0
    pio_tf_retval_utest_=0
    CALL MPI_Init(ierr)
    DO i=1,SIZE(rearrs)
      CALL PIO_TF_Init_(rearrs(i))
      IF (pio_tf_world_rank_ == 0) THEN
        WRITE(*,*) "PIO_TF: Testing : ", trim(rearrs_info(i))
      END IF
      CALL PIO_TF_Test_driver_()
      CALL PIO_TF_Finalize_()
    END DO
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_nerrs_total_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "All tests", "---------", "PASSED"
        ELSE
          pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "Test driver", "---------", "FAILED"
        END IF
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT2) "PIO_TF:[",&
          pio_tf_nerrs_total_,"] Tests",&
          "----- FAILED"
      END IF
    END IF
    CALL MPI_Finalize(ierr)
    IF (pio_tf_nerrs_total_ /= 0) THEN
      STOP 99
    END IF
  END PROGRAM
