! DON'T MODIFY THIS FILE, ALL YOUR CHANGES WILL BE LOST
! This file is generated by ../../../tests/general/util/pio_tf_f90gen.pl
! from /home/ed/tmp/ParallelIO/tests/general/pio_iosystem_tests.F90.in

! Split comm world into two comms (one with even procs and the other
! with odd procs
SUBROUTINE split_world_odd_even(new_comm, new_rank, new_size, is_even)   ! pio_iosystem_tests.F90.in:3
  use mpi   ! pio_iosystem_tests.F90.in:4
  use pio_tutil   ! pio_iosystem_tests.F90.in:5
  implicit none   ! pio_iosystem_tests.F90.in:6
  integer, intent(inout) :: new_comm   ! pio_iosystem_tests.F90.in:7
  integer, intent(inout) :: new_rank   ! pio_iosystem_tests.F90.in:8
  integer, intent(inout) :: new_size   ! pio_iosystem_tests.F90.in:9
  logical, intent(inout) :: is_even   ! pio_iosystem_tests.F90.in:10


  integer :: ierr   ! pio_iosystem_tests.F90.in:12
  integer :: color   ! pio_iosystem_tests.F90.in:13


  new_comm = MPI_COMM_NULL   ! pio_iosystem_tests.F90.in:15
  new_rank = 0   ! pio_iosystem_tests.F90.in:16
  new_size = 0   ! pio_iosystem_tests.F90.in:17


  if(mod(pio_tf_world_rank_, 2) == 0) then   ! pio_iosystem_tests.F90.in:19
    is_even = .true.   ! pio_iosystem_tests.F90.in:20
    color = 1   ! pio_iosystem_tests.F90.in:21
  else   ! pio_iosystem_tests.F90.in:22
    is_even = .false.   ! pio_iosystem_tests.F90.in:23
    color = 0   ! pio_iosystem_tests.F90.in:24
  end if   ! pio_iosystem_tests.F90.in:25


  call MPI_Comm_split(pio_tf_comm_, color, 0, new_comm, ierr)   ! pio_iosystem_tests.F90.in:27


  call MPI_Comm_rank(new_comm, new_rank, ierr)   ! pio_iosystem_tests.F90.in:29
  call MPI_Comm_size(new_comm, new_size, ierr)   ! pio_iosystem_tests.F90.in:30
END SUBROUTINE split_world_odd_even   ! pio_iosystem_tests.F90.in:31


SUBROUTINE split_world_only_even(new_comm, new_rank, new_size, is_even)   ! pio_iosystem_tests.F90.in:33
  use mpi   ! pio_iosystem_tests.F90.in:34
  use pio_tutil   ! pio_iosystem_tests.F90.in:35
  implicit none   ! pio_iosystem_tests.F90.in:36
  integer, intent(inout) :: new_comm   ! pio_iosystem_tests.F90.in:37
  integer, intent(inout) :: new_rank   ! pio_iosystem_tests.F90.in:38
  integer, intent(inout) :: new_size   ! pio_iosystem_tests.F90.in:39
  logical, intent(inout) :: is_even   ! pio_iosystem_tests.F90.in:40


  integer :: ierr   ! pio_iosystem_tests.F90.in:42
  integer :: color   ! pio_iosystem_tests.F90.in:43


  new_comm = MPI_COMM_NULL   ! pio_iosystem_tests.F90.in:45
  new_rank = 0   ! pio_iosystem_tests.F90.in:46
  new_size = 0   ! pio_iosystem_tests.F90.in:47


  if(mod(pio_tf_world_rank_, 2) == 0) then   ! pio_iosystem_tests.F90.in:49
    is_even = .true.   ! pio_iosystem_tests.F90.in:50
    color = 1   ! pio_iosystem_tests.F90.in:51
  else   ! pio_iosystem_tests.F90.in:52
    is_even = .false.   ! pio_iosystem_tests.F90.in:53
    color = MPI_UNDEFINED   ! pio_iosystem_tests.F90.in:54
  end if   ! pio_iosystem_tests.F90.in:55


  call MPI_Comm_split(pio_tf_comm_, color, 0, new_comm, ierr)   ! pio_iosystem_tests.F90.in:57


  if(new_comm /= MPI_COMM_NULL) then   ! pio_iosystem_tests.F90.in:59
    call MPI_Comm_rank(new_comm, new_rank, ierr)   ! pio_iosystem_tests.F90.in:60
    call MPI_Comm_size(new_comm, new_size, ierr)   ! pio_iosystem_tests.F90.in:61
  end if   ! pio_iosystem_tests.F90.in:62
END SUBROUTINE split_world_only_even   ! pio_iosystem_tests.F90.in:63


! Create a file with a global attribute (filename)
SUBROUTINE create_file(comm, iosys, iotype, fname, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:66
    use pio_tutil   ! pio_iosystem_tests.F90.in:67
    implicit none   ! pio_iosystem_tests.F90.in:68


    integer, intent(in) :: comm   ! pio_iosystem_tests.F90.in:70
    type(iosystem_desc_t), intent(inout) :: iosys   ! pio_iosystem_tests.F90.in:71
    integer, intent(in) :: iotype   ! pio_iosystem_tests.F90.in:72
    character(len=*), intent(in) :: fname   ! pio_iosystem_tests.F90.in:73
    character(len=*), intent(in) :: attname   ! pio_iosystem_tests.F90.in:74
    character(len=*), intent(in) :: dimname   ! pio_iosystem_tests.F90.in:75
    integer, intent(inout) :: ret   ! pio_iosystem_tests.F90.in:76


    type(file_desc_t) :: pio_file   ! pio_iosystem_tests.F90.in:78
    integer :: pio_dim   ! pio_iosystem_tests.F90.in:79
    type(var_desc_t) :: pio_var   ! pio_iosystem_tests.F90.in:80


    ret = PIO_createfile(iosys, pio_file, iotype, fname, PIO_CLOBBER)   ! pio_iosystem_tests.F90.in:82
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to create dummy file :" // trim(fname),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:83)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:83


    ret = PIO_def_dim(pio_file, dimname, PIO_TF_MAX_STR_LEN, pio_dim)   ! pio_iosystem_tests.F90.in:85
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define dim "// trim(dimname) // "in file :" // trim(fname),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:86)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:86


    ret = PIO_def_var(pio_file, attname, PIO_char, (/pio_dim/), pio_var)   ! pio_iosystem_tests.F90.in:88
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to define var " // trim(attname) // " in file :" // trim(fname),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:89)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:89


    ret = PIO_put_att(pio_file, pio_var, attname, fname)   ! pio_iosystem_tests.F90.in:91
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to put att " // trim(attname) // " in file :" // trim(fname),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:92)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:92


    call PIO_closefile(pio_file)   ! pio_iosystem_tests.F90.in:94
END SUBROUTINE create_file   ! pio_iosystem_tests.F90.in:95


! Check the contents of file : Check the
! global attribute 'filename' (should be equal to the
! name of the file, fname)
SUBROUTINE check_file(comm, iosys, iotype, pio_file, fname, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:100
    use pio_tutil   ! pio_iosystem_tests.F90.in:101
    implicit none   ! pio_iosystem_tests.F90.in:102


    integer, intent(in) :: comm   ! pio_iosystem_tests.F90.in:104
    type(iosystem_desc_t), intent(inout) :: iosys   ! pio_iosystem_tests.F90.in:105
    integer, intent(in) :: iotype   ! pio_iosystem_tests.F90.in:106
    type(file_desc_t), intent(inout) :: pio_file   ! pio_iosystem_tests.F90.in:107
    character(len=*), intent(in) :: fname   ! pio_iosystem_tests.F90.in:108
    character(len=*), intent(in) :: attname   ! pio_iosystem_tests.F90.in:109
    character(len=*), intent(in) :: dimname   ! pio_iosystem_tests.F90.in:110
    integer, intent(inout) :: ret   ! pio_iosystem_tests.F90.in:111


    integer :: pio_dim   ! pio_iosystem_tests.F90.in:113
    type(var_desc_t) :: pio_var   ! pio_iosystem_tests.F90.in:114
    character(len=PIO_TF_MAX_STR_LEN) :: val   ! pio_iosystem_tests.F90.in:115


    ret = PIO_inq_dimid(pio_file, dimname, pio_dim)   ! pio_iosystem_tests.F90.in:117
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to find dim "// trim(dimname) // "in file :" // trim(fname),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:118)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:118


    ret = PIO_inq_varid(pio_file, attname, pio_var)   ! pio_iosystem_tests.F90.in:120
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to find var " // trim(attname) // " in file :" // trim(fname),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:121)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:121


    ret = PIO_get_att(pio_file, pio_var, attname, val)   ! pio_iosystem_tests.F90.in:123
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to get att " // trim(attname) // " in file :" // trim(fname),&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:124)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:124


    PRINT *, "val = ", trim(val), ", fname =", trim(fname)   ! pio_iosystem_tests.F90.in:126
    
    IF (.NOT. (PIO_TF_Passert_(val .eq. fname,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: Assertion failed :",&
           "Attribute value is not the expected value",&
           ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:127)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:127
END SUBROUTINE check_file   ! pio_iosystem_tests.F90.in:128


! Open and check the contents of file : open it and check the
! global attribute 'filename' (should be equal to the
! name of the file, fname)
SUBROUTINE open_and_check_file(comm, iosys, iotype, pio_file, fname, &
                      attname, dimname, disable_fclose, ret)   ! pio_iosystem_tests.F90.in:134
    use pio_tutil   ! pio_iosystem_tests.F90.in:135
    implicit none   ! pio_iosystem_tests.F90.in:136


    integer, intent(in) :: comm   ! pio_iosystem_tests.F90.in:138
    type(iosystem_desc_t), intent(inout) :: iosys   ! pio_iosystem_tests.F90.in:139
    integer, intent(in) :: iotype   ! pio_iosystem_tests.F90.in:140
    type(file_desc_t), intent(inout) :: pio_file   ! pio_iosystem_tests.F90.in:141
    character(len=*), intent(in) :: fname   ! pio_iosystem_tests.F90.in:142
    character(len=*), intent(in) :: attname   ! pio_iosystem_tests.F90.in:143
    character(len=*), intent(in) :: dimname   ! pio_iosystem_tests.F90.in:144
    logical, intent(in) :: disable_fclose   ! pio_iosystem_tests.F90.in:145
    integer, intent(inout) :: ret   ! pio_iosystem_tests.F90.in:146


    ret = PIO_openfile(iosys, pio_file, iotype, fname, PIO_write)   ! pio_iosystem_tests.F90.in:148
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to open:" // fname,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:149)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:149


    call check_file(comm, iosys, iotype, pio_file, fname, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:151
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR,  comm))) THEN
      call MPI_COMM_RANK( comm, pio_tf_tmp_comm_rank_, pio_tf_retval_utest_)
      pio_tf_retval_utest_ = -1
      IF (pio_tf_tmp_comm_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Checking contents of file failed:" // fname,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:152)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:152


    if(.not. disable_fclose) then   ! pio_iosystem_tests.F90.in:154
      call PIO_closefile(pio_file)   ! pio_iosystem_tests.F90.in:155
    end if   ! pio_iosystem_tests.F90.in:156
END SUBROUTINE open_and_check_file   ! pio_iosystem_tests.F90.in:157


! Create a file with one iosystem - with all procs, and open/read with
! another iosystem - subset (odd/even) of procs
SUBROUTINE two_iosystems_odd_even
  USE pio_tutil
   ! pio_iosystem_tests.F90.in:161
  implicit none   ! pio_iosystem_tests.F90.in:162


  character(len=PIO_TF_MAX_STR_LEN), target :: fname1 = "pio_iosys_test_file1.nc"   ! pio_iosystem_tests.F90.in:164
  character(len=PIO_TF_MAX_STR_LEN), target :: fname2 = "pio_iosys_test_file2.nc"   ! pio_iosystem_tests.F90.in:165
  character(len=PIO_TF_MAX_STR_LEN), parameter :: attname = "filename"   ! pio_iosystem_tests.F90.in:166
  character(len=PIO_TF_MAX_STR_LEN), parameter :: dimname = "filename_dim"   ! pio_iosystem_tests.F90.in:167
  character(len=PIO_TF_MAX_STR_LEN), pointer :: fname   ! pio_iosystem_tests.F90.in:168
  integer, dimension(:), allocatable :: iotypes   ! pio_iosystem_tests.F90.in:169
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_iosystem_tests.F90.in:170
  integer :: i, num_iotypes = 0   ! pio_iosystem_tests.F90.in:171
  type(file_desc_t) :: pio_file   ! pio_iosystem_tests.F90.in:172


  type(iosystem_desc_t) :: odd_even_iosys   ! pio_iosystem_tests.F90.in:174
  integer :: odd_even_comm, odd_even_comm_rank, odd_even_comm_size   ! pio_iosystem_tests.F90.in:175
  logical :: is_even   ! pio_iosystem_tests.F90.in:176
  integer :: ret   ! pio_iosystem_tests.F90.in:177


  ! Split world to odd and even procs
  call split_world_odd_even(odd_even_comm, odd_even_comm_rank, odd_even_comm_size, is_even)   ! pio_iosystem_tests.F90.in:180


  call PIO_init(odd_even_comm_rank, odd_even_comm, odd_even_comm_size, &
                1, &! Num aggregators
                1, &! Stride
                PIO_rearr_subset, odd_even_iosys, base=0)   ! pio_iosystem_tests.F90.in:185
  call PIO_seterrorhandling(odd_even_iosys, PIO_BCAST_ERROR)   ! pio_iosystem_tests.F90.in:186


  ! Open two different files and close it with two different iosystems
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_iosystem_tests.F90.in:189
  do i=1,num_iotypes   ! pio_iosystem_tests.F90.in:190

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : ", iotype_descs(i)
      END IF
    END IF   ! pio_iosystem_tests.F90.in:191
    ! Create two files to be opened later - world - all procs
    call create_file(pio_tf_comm_, pio_tf_iosystem_, iotypes(i), &
                      fname1, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:194
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to create file :" // fname1,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:195)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:195


    call create_file(pio_tf_comm_, pio_tf_iosystem_, iotypes(i), &
                      fname2, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:198
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to create file :" // fname2,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:199)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:199


    ! Open file1 from odd processes and file2 from even processes
    if(is_even) then   ! pio_iosystem_tests.F90.in:202
      fname => fname1   ! pio_iosystem_tests.F90.in:203
    else   ! pio_iosystem_tests.F90.in:204
      fname => fname2   ! pio_iosystem_tests.F90.in:205
    end if   ! pio_iosystem_tests.F90.in:206


    call open_and_check_file(odd_even_comm, odd_even_iosys, iotypes(i), &
                    pio_file, fname, attname, dimname, .false., ret)   ! pio_iosystem_tests.F90.in:209
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Checking contents of file failed :" // fname,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:210)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:210
  end do   ! pio_iosystem_tests.F90.in:211


  call PIO_finalize(odd_even_iosys, ret)   ! pio_iosystem_tests.F90.in:213
  call MPI_Comm_free(odd_even_comm, ret)   ! pio_iosystem_tests.F90.in:214
  if(allocated(iotypes)) then   ! pio_iosystem_tests.F90.in:215
    deallocate(iotypes)   ! pio_iosystem_tests.F90.in:216
    deallocate(iotype_descs)   ! pio_iosystem_tests.F90.in:217
  end if   ! pio_iosystem_tests.F90.in:218
END SUBROUTINE two_iosystems_odd_even   ! pio_iosystem_tests.F90.in:219


! Create a file with one iosystem - with all procs, and open/read with
! two iosystems - (1) with all procs (2) subset (even) of procs
SUBROUTINE two_iosystems_even_all
  USE pio_tutil
   ! pio_iosystem_tests.F90.in:223
  implicit none   ! pio_iosystem_tests.F90.in:224


  character(len=PIO_TF_MAX_STR_LEN), target :: fname1 = "pio_iosys_test_file1.nc"   ! pio_iosystem_tests.F90.in:226
  character(len=PIO_TF_MAX_STR_LEN), target :: fname2 = "pio_iosys_test_file2.nc"   ! pio_iosystem_tests.F90.in:227
  character(len=PIO_TF_MAX_STR_LEN), parameter :: attname = "filename"   ! pio_iosystem_tests.F90.in:228
  character(len=PIO_TF_MAX_STR_LEN), parameter :: dimname = "filename_dim"   ! pio_iosystem_tests.F90.in:229
  character(len=PIO_TF_MAX_STR_LEN), pointer :: fname   ! pio_iosystem_tests.F90.in:230
  integer, dimension(:), allocatable :: iotypes   ! pio_iosystem_tests.F90.in:231
  character(len=PIO_TF_MAX_STR_LEN), dimension(:), allocatable :: iotype_descs   ! pio_iosystem_tests.F90.in:232
  integer :: i, num_iotypes = 0   ! pio_iosystem_tests.F90.in:233
  type(file_desc_t) :: pio_file1, pio_file2   ! pio_iosystem_tests.F90.in:234


  type(iosystem_desc_t) :: odd_even_iosys   ! pio_iosystem_tests.F90.in:236
  integer :: odd_even_comm, odd_even_comm_rank, odd_even_comm_size   ! pio_iosystem_tests.F90.in:237
  logical :: is_even   ! pio_iosystem_tests.F90.in:238
  logical :: disable_fclose = .true.   ! pio_iosystem_tests.F90.in:239
  integer :: ret   ! pio_iosystem_tests.F90.in:240


  ! Split world to odd and even procs
  call split_world_only_even(odd_even_comm, odd_even_comm_rank, odd_even_comm_size, is_even)   ! pio_iosystem_tests.F90.in:243


  if(is_even) then   ! pio_iosystem_tests.F90.in:245
    call PIO_init(odd_even_comm_rank, odd_even_comm, odd_even_comm_size, &
                  1, &! Num aggregators
                  1, &! Stride
                  PIO_rearr_subset, odd_even_iosys, base=0)   ! pio_iosystem_tests.F90.in:249
    call PIO_seterrorhandling(odd_even_iosys, PIO_BCAST_ERROR)   ! pio_iosystem_tests.F90.in:250
  end if   ! pio_iosystem_tests.F90.in:251


  ! Open two different files and close it with two different iosystems
  call PIO_TF_Get_nc_iotypes(iotypes, iotype_descs, num_iotypes)   ! pio_iosystem_tests.F90.in:254
  do i=1,num_iotypes   ! pio_iosystem_tests.F90.in:255

    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_log_level_ >= 0) THEN
        WRITE(*,"(A)",ADVANCE="NO") "PIO_TF: "
        WRITE(*,*)  "Testing : ", iotype_descs(i)
      END IF
    END IF   ! pio_iosystem_tests.F90.in:256
    ! Create two files to be opened later - world - all procs
    call create_file(pio_tf_comm_, pio_tf_iosystem_, iotypes(i), &
                      fname1, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:259
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to create file :" // fname1,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:260)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:260


    call create_file(pio_tf_comm_, pio_tf_iosystem_, iotypes(i), &
                      fname2, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:263
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Failed to create file :" // fname2,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:264)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:264


    ! Open file1 from all even processes and file2 from all odd processes
    ! - PIO called from all processes with the odd_even_iosys
    if(is_even) then   ! pio_iosystem_tests.F90.in:268
      call open_and_check_file(odd_even_comm, odd_even_iosys, iotypes(i), &
                    pio_file1, fname1, attname, dimname, disable_fclose, ret)   ! pio_iosystem_tests.F90.in:270
      PRINT *, "file1,", trim(fname1), "fh: ", pio_file1%fh   ! pio_iosystem_tests.F90.in:271
    end if   ! pio_iosystem_tests.F90.in:272
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Checking contents of file failed :" // fname1,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:273)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:273


    call open_and_check_file(pio_tf_comm_, pio_tf_iosystem_, iotypes(i), &
                    pio_file2, fname2, attname, dimname, disable_fclose, ret)   ! pio_iosystem_tests.F90.in:276
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Checking contents of file failed :" // fname2,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:277)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:277
    PRINT *, "file2,", trim(fname2), "fh: ", pio_file2%fh   ! pio_iosystem_tests.F90.in:278


    ! Check contents of the files again
    ! - PIO called from odd and even processes separately with odd_even_iosys
    if(is_even) then   ! pio_iosystem_tests.F90.in:282
      call check_file(odd_even_comm, odd_even_iosys, iotypes(i), pio_file1, &
                      fname1, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:284
      !call PIO_closefile(pio_file1)
    end if   ! pio_iosystem_tests.F90.in:286
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Checking contents of file failed :" // fname1,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:287)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:287


    call check_file(pio_tf_comm_, pio_tf_iosystem_, iotypes(i), pio_file2, &
                    fname2, attname, dimname, ret)   ! pio_iosystem_tests.F90.in:290
    
    IF (.NOT. (PIO_TF_Passert_((ret) == PIO_NOERR, pio_tf_comm_))) THEN
      pio_tf_retval_utest_ = -1
      IF (pio_tf_world_rank_ == 0) THEN
        PRINT *, "PIO_TF: PIO Function failed:",&
           "Checking contents of file failed :" // fname2,&
          ":", __FILE__, ":", __LINE__,&
          "(pio_iosystem_tests.F90.in:291)"
      END IF
      RETURN
    END IF   ! pio_iosystem_tests.F90.in:291


    if(disable_fclose) then   ! pio_iosystem_tests.F90.in:293
      if(is_even) then   ! pio_iosystem_tests.F90.in:294
        call PIO_closefile(pio_file1)   ! pio_iosystem_tests.F90.in:295
      end if   ! pio_iosystem_tests.F90.in:296
      call PIO_closefile(pio_file2)   ! pio_iosystem_tests.F90.in:297
    end if   ! pio_iosystem_tests.F90.in:298
  end do   ! pio_iosystem_tests.F90.in:299


  if(is_even) then   ! pio_iosystem_tests.F90.in:301
    call PIO_finalize(odd_even_iosys, ret)   ! pio_iosystem_tests.F90.in:302
    call MPI_Comm_free(odd_even_comm, ret)   ! pio_iosystem_tests.F90.in:303
  end if   ! pio_iosystem_tests.F90.in:304
  if(allocated(iotypes)) then   ! pio_iosystem_tests.F90.in:305
    deallocate(iotypes)   ! pio_iosystem_tests.F90.in:306
    deallocate(iotype_descs)   ! pio_iosystem_tests.F90.in:307
  end if   ! pio_iosystem_tests.F90.in:308
END SUBROUTINE two_iosystems_even_all   ! pio_iosystem_tests.F90.in:309


  SUBROUTINE PIO_TF_Test_driver_
    USE pio_tutil
    IMPLICIT NONE
    pio_tf_retval_utest_ = 0
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting two_iosystems_odd_even"
    END IF
    CALL two_iosystems_odd_even()
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          "two_iosystems_odd_even","-----------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 1:",&
          "two_iosystems_odd_even","-----------", "FAILED"
      END IF
    END IF
    pio_tf_retval_utest_ = 0
    IF (pio_tf_world_rank_ == 0) THEN
      PRINT *, "PIO_TF: Starting two_iosystems_even_all"
    END IF
    CALL two_iosystems_even_all()
    IF (pio_tf_retval_utest_ /= 0) THEN
      pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
    END IF
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_retval_utest_ == 0) THEN
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          "two_iosystems_even_all","-----------", "PASSED"
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF:Test 2:",&
          "two_iosystems_even_all","-----------", "FAILED"
      END IF
    END IF
  END SUBROUTINE PIO_TF_Test_driver_


  PROGRAM PIO_TF_Test_main_
    USE pio_tutil
    IMPLICIT NONE
    INTEGER, PARAMETER :: NREARRS = 2
    INTEGER :: rearrs(NREARRS) = (/pio_rearr_subset,pio_rearr_box/)
    CHARACTER(LEN=PIO_TF_MAX_STR_LEN) :: rearrs_info(NREARRS) = (/"PIO_REARR_SUBSET","PIO_REARR_BOX   "/)
    INTEGER i, ierr

    pio_tf_nerrs_total_=0
    pio_tf_retval_utest_=0
    CALL MPI_Init(ierr)
    DO i=1,SIZE(rearrs)
      CALL PIO_TF_Init_(rearrs(i))
      IF (pio_tf_world_rank_ == 0) THEN
        WRITE(*,*) "PIO_TF: Testing : ", trim(rearrs_info(i))
      END IF
      CALL PIO_TF_Test_driver_()
      CALL PIO_TF_Finalize_()
    END DO
    IF (pio_tf_world_rank_ == 0) THEN
      IF (pio_tf_nerrs_total_ == 0) THEN
        IF (pio_tf_retval_utest_ == 0) THEN
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "All tests", "---------", "PASSED"
        ELSE
          pio_tf_nerrs_total_ = pio_tf_nerrs_total_ + 1
          WRITE(*,PIO_TF_TEST_RES_FMT) "PIO_TF: ",&
           "Test driver", "---------", "FAILED"
        END IF
      ELSE
        WRITE(*,PIO_TF_TEST_RES_FMT2) "PIO_TF:[",&
          pio_tf_nerrs_total_,"] Tests",&
          "----- FAILED"
      END IF
    END IF
    CALL MPI_Finalize(ierr)
    IF (pio_tf_nerrs_total_ /= 0) THEN
      STOP 99
    END IF
  END PROGRAM
