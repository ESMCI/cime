

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIME.SystemTests.system_tests_common &mdash; CIME master documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=30d551ce"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CIME
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../what_cime/index.html">What is CIME?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html">Using the Case Control System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html#configuring-the-case-control-system">Configuring the Case Control System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_cpl/index.html">Building a Coupled Model with CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_tools/index.html">Miscellaneous Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_user/index.html">User Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xml_files/index.html">XML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CIME_api/modules.html">CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_api/modules.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CIME</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">CIME.SystemTests.system_tests_common</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CIME.SystemTests.system_tests_common</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base class for CIME system tests</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">CIME.XML.standard_module_setup</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_run</span> <span class="kn">import</span> <span class="n">EnvRun</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_test</span> <span class="kn">import</span> <span class="n">EnvTest</span>
<span class="kn">from</span> <span class="nn">CIME.status</span> <span class="kn">import</span> <span class="n">append_testlog</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_model</span><span class="p">,</span>
    <span class="n">safe_copy</span><span class="p">,</span>
    <span class="n">get_timestamp</span><span class="p">,</span>
    <span class="n">CIMEError</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
    <span class="n">get_current_commit</span><span class="p">,</span>
    <span class="n">SharedArea</span><span class="p">,</span>
    <span class="n">is_comp_standalone</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">CIME.test_status</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">CIME.hist_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">copy_histfiles</span><span class="p">,</span>
    <span class="n">compare_test</span><span class="p">,</span>
    <span class="n">generate_teststatus</span><span class="p">,</span>
    <span class="n">compare_baseline</span><span class="p">,</span>
    <span class="n">get_ts_synopsis</span><span class="p">,</span>
    <span class="n">generate_baseline</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">CIME.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">CIME.provenance</span> <span class="kn">import</span> <span class="n">save_test_time</span><span class="p">,</span> <span class="n">get_test_success</span>
<span class="kn">from</span> <span class="nn">CIME.locked_files</span> <span class="kn">import</span> <span class="n">LOCKED_DIR</span><span class="p">,</span> <span class="n">lock_file</span><span class="p">,</span> <span class="n">is_locked</span>
<span class="kn">from</span> <span class="nn">CIME.baselines.performance</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_latest_cpl_logs</span><span class="p">,</span>
    <span class="n">perf_get_memory_list</span><span class="p">,</span>
    <span class="n">perf_compare_memory_baseline</span><span class="p">,</span>
    <span class="n">perf_compare_throughput_baseline</span><span class="p">,</span>
    <span class="n">perf_write_baseline</span><span class="p">,</span>
    <span class="n">load_coupler_customization</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">CIME.build</span> <span class="k">as</span> <span class="nn">build</span>

<span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">traceback</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ExitStack</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Name of directory under the run directory in which init-generated files are placed</span>
<span class="n">INIT_GENERATED_FILES_DIRNAME</span> <span class="o">=</span> <span class="s2">&quot;init_generated_files&quot;</span>


<div class="viewcode-block" id="fix_single_exe_case">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.fix_single_exe_case">[docs]</a>
<span class="k">def</span> <span class="nf">fix_single_exe_case</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixes cases created with --single-exe.</span>

<span class="sd">    When tests are created using --single-exe, the test_scheduler will set</span>
<span class="sd">    `BUILD_COMPLETE` to True, but some tests require calls to `case.case_setup`</span>
<span class="sd">    which can resets `BUILD_COMPLETE` to false. This function will check if a</span>
<span class="sd">    case was created with `--single-exe` and ensure `BUILD_COMPLETE` is True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True when case required modification otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_single_exe_case</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
            <span class="c1"># enter context if case is still read-only, entering the context</span>
            <span class="c1"># multiple times can cause side effects for later calls to</span>
            <span class="c1"># `set_value` when it&#39;s assumed the cause is writeable.</span>
            <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">_read_only_mode</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

            <span class="k">case</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;BUILD_COMPLETE&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="is_single_exe_case">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.is_single_exe_case">[docs]</a>
<span class="k">def</span> <span class="nf">is_single_exe_case</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determines if the case was created with the --single-exe option.</span>

<span class="sd">    If `CASEROOT` is not part of `EXEROOT` and the `TEST` variable is True,</span>
<span class="sd">    then its safe to assume the case was created with `./create_test`</span>
<span class="sd">    and the `--single-exe` option.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True when the case was created with `--single-exe` otherwise false.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">caseroot</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span>

    <span class="n">exeroot</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;EXEROOT&quot;</span><span class="p">)</span>

    <span class="n">test</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TEST&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">caseroot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exeroot</span> <span class="ow">and</span> <span class="n">test</span></div>



<div class="viewcode-block" id="SystemTestsCommon">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon">[docs]</a>
<span class="k">class</span> <span class="nc">SystemTestsCommon</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initialize a CIME system test object, if the locked env_run.orig.xml</span>
<span class="sd">        does not exist copy the current env_run.xml file.  If it does exist restore values</span>
<span class="sd">        changed in a previous run of the test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="o">=</span> <span class="n">case</span>
        <span class="n">caseroot</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span> <span class="o">=</span> <span class="n">caseroot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span> <span class="o">=</span> <span class="n">caseroot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runstatus</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_casebaseid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEBASEID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span> <span class="o">=</span> <span class="n">TestStatus</span><span class="p">(</span><span class="n">test_dir</span><span class="o">=</span><span class="n">caseroot</span><span class="p">,</span> <span class="n">test_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_casebaseid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_environment</span><span class="p">(</span><span class="n">caseroot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_locked_files</span><span class="p">(</span><span class="n">caseroot</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skip_pnl</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;med&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMP_INTERFACE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;nuopc&quot;</span> <span class="k">else</span> <span class="s2">&quot;cpl&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ninja</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_separate_builds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_num_cmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rest_n</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_set_restart_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stop_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_N&quot;</span><span class="p">)</span>
        <span class="n">stop_option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_OPTION&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;REST_OPTION&quot;</span><span class="p">,</span> <span class="n">stop_option</span><span class="p">)</span>
        <span class="c1"># We need to make sure the run is long enough and to set REST_N to a</span>
        <span class="c1"># value that makes sense for all components</span>
        <span class="n">maxncpl</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">minncpl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="s2">&quot;CPL&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">compname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMP_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>

            <span class="c1"># ignore stub components in this test.</span>
            <span class="k">if</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;s</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="n">ncpl</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_NCPL&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">ncpl</span> <span class="ow">and</span> <span class="n">maxncpl</span> <span class="o">&gt;</span> <span class="n">ncpl</span><span class="p">:</span>
                <span class="n">maxncpl</span> <span class="o">=</span> <span class="n">ncpl</span>
            <span class="k">if</span> <span class="n">ncpl</span> <span class="ow">and</span> <span class="n">minncpl</span> <span class="o">&lt;</span> <span class="n">ncpl</span><span class="p">:</span>
                <span class="n">minncpl</span> <span class="o">=</span> <span class="n">ncpl</span>

        <span class="n">ncpl_base_period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;NCPL_BASE_PERIOD&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncpl_base_period</span> <span class="o">==</span> <span class="s2">&quot;hour&quot;</span><span class="p">:</span>
            <span class="n">coupling_secs</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">/</span> <span class="n">maxncpl</span>
            <span class="n">timestep</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">/</span> <span class="n">minncpl</span>
        <span class="k">elif</span> <span class="n">ncpl_base_period</span> <span class="o">==</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span>
            <span class="n">coupling_secs</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">/</span> <span class="n">maxncpl</span>
            <span class="n">timestep</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">/</span> <span class="n">minncpl</span>
        <span class="k">elif</span> <span class="n">ncpl_base_period</span> <span class="o">==</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span>
            <span class="n">coupling_secs</span> <span class="o">=</span> <span class="mi">31536000</span> <span class="o">/</span> <span class="n">maxncpl</span>
            <span class="n">timestep</span> <span class="o">=</span> <span class="mi">31536000</span> <span class="o">/</span> <span class="n">minncpl</span>
        <span class="k">elif</span> <span class="n">ncpl_base_period</span> <span class="o">==</span> <span class="s2">&quot;decade&quot;</span><span class="p">:</span>
            <span class="n">coupling_secs</span> <span class="o">=</span> <span class="mi">315360000</span> <span class="o">/</span> <span class="n">maxncpl</span>
            <span class="n">timestep</span> <span class="o">=</span> <span class="mi">315360000</span> <span class="o">/</span> <span class="n">minncpl</span>

        <span class="c1"># Convert stop_n to units of coupling intervals</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">stop_option</span> <span class="o">==</span> <span class="s2">&quot;nsteps&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">timestep</span>
        <span class="k">elif</span> <span class="n">stop_option</span> <span class="o">==</span> <span class="s2">&quot;nminutes&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="k">elif</span> <span class="n">stop_option</span> <span class="o">==</span> <span class="s2">&quot;nhours&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">3600</span>
        <span class="k">elif</span> <span class="n">stop_option</span> <span class="o">==</span> <span class="s2">&quot;ndays&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">86400</span>
        <span class="k">elif</span> <span class="n">stop_option</span> <span class="o">==</span> <span class="s2">&quot;nyears&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">315360000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;stop_option </span><span class="si">{</span><span class="n">stop_option</span><span class="si">}</span><span class="s2"> not available for this test&quot;</span><span class="p">)</span>

        <span class="n">stop_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stop_n</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">//</span> <span class="n">coupling_secs</span><span class="p">)</span>
        <span class="n">rest_n</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">stop_n</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">coupling_secs</span> <span class="o">/</span> <span class="n">factor</span><span class="p">)</span>

        <span class="n">expect</span><span class="p">(</span><span class="n">stop_n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Bad STOP_N: </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stop_n</span><span class="p">))</span>

        <span class="n">expect</span><span class="p">(</span><span class="n">stop_n</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ERROR: stop_n value </span><span class="si">{:d}</span><span class="s2"> too short&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stop_n</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;doing an </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> initial test with restart file at </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">stop_n</span><span class="p">),</span> <span class="n">stop_option</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rest_n</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;REST_N&quot;</span><span class="p">,</span> <span class="n">rest_n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rest_n</span>

    <span class="k">def</span> <span class="nf">_init_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caseroot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do initializations of environment variables that are needed in __init__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Needed for sh scripts</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseroot</span>

    <span class="k">def</span> <span class="nf">_init_locked_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caseroot</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the locked env_run.orig.xml does not exist, copy the current</span>
<span class="sd">        env_run.xml file. If it does exist, restore values changed in a previous</span>
<span class="sd">        run of the test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked</span><span class="p">(</span><span class="s2">&quot;env_run.orig.xml&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compare_env_run</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">caseroot</span><span class="p">,</span> <span class="s2">&quot;env_run.xml&quot;</span><span class="p">)):</span>
            <span class="n">lock_file</span><span class="p">(</span><span class="s2">&quot;env_run.xml&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="p">,</span> <span class="n">newname</span><span class="o">=</span><span class="s2">&quot;env_run.orig.xml&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resetup_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-setup this case. This is necessary if user is re-running an already-run</span>
<span class="sd">        phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We never want to re-setup if we&#39;re doing the resubmitted run</span>
        <span class="n">phase_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">phase_comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_comment</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">rerunning</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">phase_status</span> <span class="o">!=</span> <span class="n">TEST_PEND_STATUS</span> <span class="ow">or</span> <span class="n">phase_comment</span> <span class="o">==</span> <span class="n">TEST_RERUN_COMMENT</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;IS_FIRST_RUN&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rerunning</span><span class="p">):</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Resetting case due to detected re-run of phase </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">set_initial_test_values</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">case_setup</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fix_single_exe_case</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>

<div class="viewcode-block" id="SystemTestsCommon.build">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.build">[docs]</a>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ninja</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">separate_builds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_submit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do NOT override this method, this method is the framework that</span>
<span class="sd">        controls the build phase. build_phase is the extension point</span>
<span class="sd">        that subclasses should use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ninja</span> <span class="o">=</span> <span class="n">ninja</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_separate_builds</span> <span class="o">=</span> <span class="n">separate_builds</span>

        <span class="n">was_run_pend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">current_is</span><span class="p">(</span><span class="n">RUN_PHASE</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_bool</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">SHAREDLIB_BUILD_PHASE</span><span class="p">,</span> <span class="ow">not</span> <span class="n">model_only</span><span class="p">),</span>
            <span class="p">(</span><span class="n">MODEL_BUILD_PHASE</span><span class="p">,</span> <span class="ow">not</span> <span class="n">sharedlib_only</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">phase_bool</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resetup_case</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>

                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span>
                        <span class="n">sharedlib_only</span><span class="o">=</span><span class="p">(</span><span class="n">phase_name</span> <span class="o">==</span> <span class="n">SHAREDLIB_BUILD_PHASE</span><span class="p">),</span>
                        <span class="n">model_only</span><span class="o">=</span><span class="p">(</span><span class="n">phase_name</span> <span class="o">==</span> <span class="n">MODEL_BUILD_PHASE</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># We want KeyboardInterrupts to generate FAIL status</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CIMEError</span><span class="p">):</span>
                        <span class="c1"># Don&#39;t want to print stacktrace for a build failure since that</span>
                        <span class="c1"># is not a CIME/infrastructure problem.</span>
                        <span class="n">excmsg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">excmsg</span> <span class="o">=</span> <span class="s2">&quot;Exception during build:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="p">)</span>

                    <span class="n">append_testlog</span><span class="p">(</span><span class="n">excmsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>
                    <span class="k">raise</span>

                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">time_taken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                            <span class="n">phase_name</span><span class="p">,</span>
                            <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span>
                            <span class="n">comments</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time=</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time_taken</span><span class="p">))),</span>
                        <span class="p">)</span>

        <span class="c1"># Building model while job is queued and awaiting run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">skip_submit</span>
            <span class="ow">and</span> <span class="n">was_run_pend</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">current_is</span><span class="p">(</span><span class="n">SUBMIT_PHASE</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">SUBMIT_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">success</span></div>


<div class="viewcode-block" id="SystemTestsCommon.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the default build phase implementation, it just does an individual build.</span>
<span class="sd">        This is the subclass&#39; extension point if they need to define a custom build</span>
<span class="sd">        phase.</span>

<span class="sd">        PLEASE THROW EXCEPTION ON FAIL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_indv</span><span class="p">(</span><span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>


<div class="viewcode-block" id="SystemTestsCommon.build_indv">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.build_indv">[docs]</a>
    <span class="k">def</span> <span class="nf">build_indv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an individual build</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MODEL&quot;</span><span class="p">)</span>
        <span class="n">build</span><span class="o">.</span><span class="n">case_build</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span>
            <span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span>
            <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span>
            <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">,</span>
            <span class="n">save_build_provenance</span><span class="o">=</span><span class="ow">not</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;cesm&quot;</span><span class="p">,</span>
            <span class="n">ninja</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ninja</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">,</span>
            <span class="n">separate_builds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_user_separate_builds</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;build_indv complete&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SystemTestsCommon.clean_build">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.clean_build">[docs]</a>
    <span class="k">def</span> <span class="nf">clean_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">)]</span>
        <span class="n">build</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">cleanlist</span><span class="o">=</span><span class="n">comps</span><span class="p">)</span></div>


<div class="viewcode-block" id="SystemTestsCommon.run">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_pnl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do NOT override this method, this method is the framework that controls</span>
<span class="sd">        the run phase. run_phase is the extension point that subclasses should use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skip_pnl</span> <span class="o">=</span> <span class="n">skip_pnl</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resetup_case</span><span class="p">(</span><span class="n">RUN_PHASE</span><span class="p">)</span>
            <span class="n">do_baseline_ops</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">RUN_PHASE</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>

            <span class="c1"># We do not want to do multiple repetitions of baseline operations for</span>
            <span class="c1"># multi-submit tests. We just want to do them upon the final submission.</span>
            <span class="c1"># Other submissions will need to mark those phases as PEND to ensure wait_for_tests</span>
            <span class="c1"># waits for them.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BATCH_SYSTEM&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="n">do_baseline_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RESUBMIT&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_phase</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;GENERATE_BASELINE&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">do_baseline_ops</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_phase_modifying_call</span><span class="p">(</span><span class="n">GENERATE_PHASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_baseline</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">GENERATE_PHASE</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPARE_BASELINE&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">do_baseline_ops</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_phase_modifying_call</span><span class="p">(</span><span class="n">BASELINE_PHASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_baseline</span><span class="p">)</span>
                    <span class="n">comp_standalone</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">is_comp_standalone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">comp_standalone</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_modifying_call</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_memory</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_modifying_call</span><span class="p">(</span>
                            <span class="n">THROUGHPUT_PHASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_throughput</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">BASELINE_PHASE</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">THROUGHPUT_PHASE</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_modifying_call</span><span class="p">(</span><span class="n">MEMLEAK_PHASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_memleak</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phase_modifying_call</span><span class="p">(</span><span class="n">STARCHIVE_PHASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_st_archive_case_test</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># We want KeyboardInterrupts to generate FAIL status</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">CIMEError</span><span class="p">):</span>
                <span class="c1"># Don&#39;t want to print stacktrace for a model failure since that</span>
                <span class="c1"># is not a CIME/infrastructure problem.</span>
                <span class="n">excmsg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">excmsg</span> <span class="o">=</span> <span class="s2">&quot;Exception during run:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="p">)</span>

            <span class="n">append_testlog</span><span class="p">(</span><span class="n">excmsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Writing the run status should be the very last thing due to wait_for_tests</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                    <span class="n">RUN_PHASE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time=</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time_taken</span><span class="p">)))</span>
                <span class="p">)</span>

            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">verbose_run_phase</span><span class="p">:</span>
                <span class="c1"># If run phase worked, remember the time it took in order to improve later walltime ests</span>
                <span class="n">baseline_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASELINE_ROOT&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">srcroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;SRCROOT&quot;</span><span class="p">)</span>
                    <span class="n">save_test_time</span><span class="p">(</span>
                        <span class="n">baseline_root</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_casebaseid</span><span class="p">,</span>
                        <span class="n">time_taken</span><span class="p">,</span>
                        <span class="n">get_current_commit</span><span class="p">(</span><span class="n">repo</span><span class="o">=</span><span class="n">srcroot</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># If overall things did not pass, offer the user some insight into what might have broken things</span>
                <span class="n">overall_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_overall_test_status</span><span class="p">(</span>
                    <span class="n">ignore_namelists</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">overall_status</span> <span class="o">!=</span> <span class="n">TEST_PASS_STATUS</span><span class="p">:</span>
                    <span class="n">srcroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;SRCROOT&quot;</span><span class="p">)</span>
                    <span class="n">worked_before</span><span class="p">,</span> <span class="n">last_pass</span><span class="p">,</span> <span class="n">last_fail_transition</span> <span class="o">=</span> <span class="n">get_test_success</span><span class="p">(</span>
                        <span class="n">baseline_root</span><span class="p">,</span> <span class="n">srcroot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_casebaseid</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">worked_before</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">last_pass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># commits between last_pass and now broke things</span>
                            <span class="n">stat</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span>
                                <span class="s2">&quot;git rev-list --first-parent </span><span class="si">{}</span><span class="s2">..</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">last_pass</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span>
                                <span class="p">),</span>
                                <span class="n">from_dir</span><span class="o">=</span><span class="n">srcroot</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">append_testlog</span><span class="p">(</span>
                                    <span class="s2">&quot;NEW FAIL: Potentially broken merges:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">out</span>
                                    <span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;Unable to list potentially broken merges: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">out</span><span class="p">,</span> <span class="n">err</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">last_pass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">last_fail_transition</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># commits between last_pass and last_fail_transition broke things</span>
                            <span class="n">stat</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span>
                                <span class="s2">&quot;git rev-list --first-parent </span><span class="si">{}</span><span class="s2">..</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">last_pass</span><span class="p">,</span> <span class="n">last_fail_transition</span>
                                <span class="p">),</span>
                                <span class="n">from_dir</span><span class="o">=</span><span class="n">srcroot</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">append_testlog</span><span class="p">(</span>
                                    <span class="s2">&quot;OLD FAIL: Potentially broken merges:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">out</span>
                                    <span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;Unable to list potentially broken merges: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">out</span><span class="p">,</span> <span class="n">err</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">baseline_store_teststatus</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                <span class="s2">&quot;GENERATE_BASELINE&quot;</span>
            <span class="p">):</span>
                <span class="n">baseline_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASELINE_ROOT&quot;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASEGEN_CASE&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">generate_teststatus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">baseline_dir</span><span class="p">)</span>

        <span class="c1"># We return success if the run phase worked; memleaks, diffs will NOT be taken into account</span>
        <span class="c1"># with this return value.</span>
        <span class="k">return</span> <span class="n">success</span></div>


<div class="viewcode-block" id="SystemTestsCommon.run_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.run_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the default run phase implementation, it just does an individual run.</span>
<span class="sd">        This is the subclass&#39; extension point if they need to define a custom run phase.</span>

<span class="sd">        PLEASE THROW AN EXCEPTION ON FAIL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_indv</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_get_caseroot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current CASEROOT value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span>

    <span class="k">def</span> <span class="nf">_set_active_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use for tests that have multiple cases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="o">=</span> <span class="n">case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">load_env</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SystemTestsCommon.run_indv">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.run_indv">[docs]</a>
    <span class="k">def</span> <span class="nf">run_indv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;base&quot;</span><span class="p">,</span>
        <span class="n">st_archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">submit_resubmits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_init_generated_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an individual run. Raises an EXCEPTION on fail.</span>

<span class="sd">        keep_init_generated_files: If False (the default), we remove the</span>
<span class="sd">        init_generated_files subdirectory of the run directory before running the case.</span>
<span class="sd">        This is usually what we want for tests, but some specific tests may want to leave</span>
<span class="sd">        this directory in place, so can set this variable to True to do so.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stop_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_N&quot;</span><span class="p">)</span>
        <span class="n">stop_option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_OPTION&quot;</span><span class="p">)</span>
        <span class="n">run_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUN_TYPE&quot;</span><span class="p">)</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">check_all_input_data</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">CIMEError</span><span class="p">:</span>
            <span class="n">caseroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CIMEError</span><span class="p">(</span>
                <span class="s2">&quot;Could not find all inputdata on any server, try &quot;</span>
                <span class="s2">&quot;manually running `./check_input_data --download &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;--verbose` from </span><span class="si">{</span><span class="n">caseroot</span><span class="si">!r}</span><span class="s2">.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">submit_resubmits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">do_resub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BATCH_SYSTEM&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_resub</span> <span class="o">=</span> <span class="n">submit_resubmits</span>

        <span class="c1"># remove any cprnc output leftover from previous runs</span>
        <span class="k">for</span> <span class="n">compout</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="s2">&quot;*.cprnc.out&quot;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">compout</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_init_generated_files</span><span class="p">:</span>
            <span class="c1"># remove all files in init_generated_files directory if it exists</span>
            <span class="n">init_generated_files_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">rundir</span><span class="p">,</span> <span class="n">INIT_GENERATED_FILES_DIRNAME</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">init_generated_files_dir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">init_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">init_generated_files_dir</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">init_file</span><span class="p">)</span>

        <span class="n">infostr</span> <span class="o">=</span> <span class="s2">&quot;doing an </span><span class="si">{:d}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> test&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stop_n</span><span class="p">,</span> <span class="n">stop_option</span><span class="p">,</span> <span class="n">run_type</span><span class="p">)</span>

        <span class="n">rest_option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;REST_OPTION&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rest_option</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span> <span class="ow">or</span> <span class="n">rest_option</span> <span class="o">==</span> <span class="s2">&quot;never&quot;</span><span class="p">:</span>
            <span class="n">infostr</span> <span class="o">+=</span> <span class="s2">&quot;, no restarts written&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rest_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;REST_N&quot;</span><span class="p">)</span>
            <span class="n">infostr</span> <span class="o">+=</span> <span class="s2">&quot;, with restarts every </span><span class="si">{:d}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rest_n</span><span class="p">,</span> <span class="n">rest_option</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">case_run</span><span class="p">(</span><span class="n">skip_pnl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_skip_pnl</span><span class="p">,</span> <span class="n">submit_resubmits</span><span class="o">=</span><span class="n">do_resub</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coupler_log_indicates_run_complete</span><span class="p">():</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Coupler did not indicate run passed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_component_compare_copy</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">st_archive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">case_st_archive</span><span class="p">(</span><span class="n">resubmit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_coupler_log_indicates_run_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newestcpllogfiles</span> <span class="o">=</span> <span class="n">get_latest_cpl_logs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Latest Coupler log file(s) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newestcpllogfiles</span><span class="p">))</span>
        <span class="c1"># Exception is raised if the file is not compressed</span>
        <span class="n">allgood</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newestcpllogfiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cpllog</span> <span class="ow">in</span> <span class="n">newestcpllogfiles</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;SUCCESSFUL TERMINATION&quot;</span> <span class="ow">in</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cpllog</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
                    <span class="n">allgood</span> <span class="o">=</span> <span class="n">allgood</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Probably want to be more specific here</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not compressed, assuming run failed </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cpllog</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">allgood</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_component_compare_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
        <span class="c1"># Only match .nc files</span>
        <span class="n">comments</span><span class="p">,</span> <span class="n">num_copied</span> <span class="o">=</span> <span class="n">copy_histfiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">match_suffix</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_num_cmp</span> <span class="o">=</span> <span class="n">num_copied</span>

        <span class="n">append_testlog</span><span class="p">(</span><span class="n">comments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_cprnc_output_tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_pattern</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>

        <span class="n">glob_pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">filename_pattern</span><span class="p">)</span>

        <span class="n">cprnc_logs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_pattern</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">cprnc_logs</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">cprnc_log_tail</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">20</span><span class="p">:]</span>

            <span class="n">cprnc_log_tail</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tail -n20 </span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">prepend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cprnc_log_tail</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prepend</span><span class="p">))</span>

            <span class="n">append_testlog</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cprnc_log_tail</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_component_compare_test</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">,</span> <span class="n">success_change</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_fieldlist_diffs</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return value is not generally checked, but is provided in case a custom</span>
<span class="sd">        run case needs indirection based on success.</span>
<span class="sd">        If success_change is True, success requires some files to be different.</span>
<span class="sd">        If ignore_fieldlist_diffs is True, then: If the two cases differ only in their</span>
<span class="sd">            field lists (i.e., all shared fields are bit-for-bit, but one case has some</span>
<span class="sd">            diagnostic fields that are missing from the other case), treat the two cases</span>
<span class="sd">            as identical.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="n">num_compared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_compare_test</span><span class="p">(</span>
            <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">,</span> <span class="n">ignore_fieldlist_diffs</span><span class="o">=</span><span class="n">ignore_fieldlist_diffs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">success_change</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">success</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expected_num_cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">num_compared</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_num_cmp</span> <span class="o">!=</span> <span class="n">num_compared</span>
        <span class="p">):</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;PASS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">comments</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">WARNING</span>
<span class="s2">Expected to compare </span><span class="si">{}</span><span class="s2"> hist files, but only compared </span><span class="si">{}</span><span class="s2">. It&#39;s possible</span>
<span class="s2">that the hist_file_extension entry in config_archive.xml is not correct</span>
<span class="s2">for some of your components.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expected_num_cmp</span><span class="p">,</span> <span class="n">num_compared</span>
            <span class="p">)</span>

        <span class="n">append_testlog</span><span class="p">(</span><span class="n">comments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>

        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;*.nc.</span><span class="si">{}</span><span class="s2">.cprnc.out&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix1</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;compared suffixes suffix1 </span><span class="si">{!r}</span><span class="s2"> suffix2 </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_cprnc_output_tail</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COMPARE_PHASE</span><span class="p">,</span> <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">),</span> <span class="n">status</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">success</span>

    <span class="k">def</span> <span class="nf">_do_compare_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">,</span> <span class="n">ignore_fieldlist_diffs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wraps the call to compare_test to facilitate replacement in unit</span>
<span class="sd">        tests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">compare_test</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">,</span> <span class="n">ignore_fieldlist_diffs</span><span class="o">=</span><span class="n">ignore_fieldlist_diffs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_st_archive_case_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">test_env_archive</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">STARCHIVE_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">STARCHIVE_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_phase_modifying_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures that unexpected exceptions from phases will result in a FAIL result</span>
<span class="sd">        in the TestStatus file for that phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">function</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Do NOT want to catch KeyboardInterrupt</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
            <span class="n">excmsg</span> <span class="o">=</span> <span class="s2">&quot;Exception during </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">phase</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">excmsg</span><span class="p">)</span>
            <span class="n">append_testlog</span><span class="p">(</span><span class="n">excmsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                    <span class="n">phase</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;exception&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_for_memleak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examine memory usage as recorded in the cpl log file and look for unexpected</span>
<span class="sd">        increases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_coupler_customization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>

        <span class="c1"># default to 0.1</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TEST_MEMLEAK_TOLERANCE&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">0.1</span>

        <span class="n">expect</span><span class="p">(</span><span class="n">tolerance</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;Bad value for memleak tolerance in test&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">memleak</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">perf_check_for_memory_leak</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">tolerance</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">memleak</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">perf_check_for_memory_leak</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">memleak</span><span class="p">:</span>
                <span class="n">append_testlog</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>

                <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_FAIL_STATUS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMLEAK_PHASE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>

<div class="viewcode-block" id="SystemTestsCommon.compare_env_run">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.compare_env_run">[docs]</a>
    <span class="k">def</span> <span class="nf">compare_env_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare env_run file to original and warn about differences</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">)</span>
        <span class="n">f1obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">)</span>
        <span class="n">f2obj</span> <span class="o">=</span> <span class="n">EnvRun</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOCKED_DIR</span><span class="p">,</span> <span class="s2">&quot;env_run.orig.xml&quot;</span><span class="p">),</span>
            <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">f1obj</span><span class="o">.</span><span class="n">compare_xml</span><span class="p">(</span><span class="n">f2obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">diffs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">expected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;  Resetting </span><span class="si">{}</span><span class="s2"> for test&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">f1obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">f2obj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;WARNING: Found difference in test </span><span class="si">{}</span><span class="s2">: case: </span><span class="si">{}</span><span class="s2"> original value </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">diffs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">diffs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="nf">_compare_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares current test memory usage to baseline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">below_tolerance</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">perf_compare_memory_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to compare memory usage baseline: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                    <span class="n">MEMCOMP_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">below_tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">append_testlog</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">below_tolerance</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TEST_FAIL_STATUS</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                            <span class="n">MEMCOMP_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span>
                        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_throughput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares current test throughput to baseline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">below_tolerance</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">perf_compare_throughput_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to compare throughput baseline: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                    <span class="n">THROUGHPUT_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">below_tolerance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">append_testlog</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">below_tolerance</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">THROUGHPUT_PHASE</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">THROUGHPUT_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">THROUGHPUT_PHASE</span><span class="p">)</span>
                        <span class="o">!=</span> <span class="n">TEST_FAIL_STATUS</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                            <span class="n">THROUGHPUT_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span>
                        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compare_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compare the current test output to a baseline result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="c1"># compare baseline</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">compare_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>

            <span class="n">append_testlog</span><span class="p">(</span><span class="n">comments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>

            <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;*.nc.cprnc.out&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_cprnc_output_tail</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span>
            <span class="n">baseline_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASECMP_CASE&quot;</span><span class="p">)</span>
            <span class="n">ts_comments</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">baseline_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">get_ts_synopsis</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">BASELINE_PHASE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">ts_comments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generate a new baseline case based on the current test</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="c1"># generate baseline</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">generate_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>
            <span class="n">append_testlog</span><span class="p">(</span><span class="n">comments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span>
            <span class="n">baseline_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASEGEN_CASE&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span>
                <span class="n">GENERATE_PHASE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">baseline_name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">basegen_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASELINE_ROOT&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASEGEN_CASE&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># copy latest cpl log to baseline</span>
            <span class="c1"># drop the date so that the name is generic</span>
            <span class="n">newestcpllogfiles</span> <span class="o">=</span> <span class="n">get_latest_cpl_logs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">SharedArea</span><span class="p">():</span>
                <span class="c1"># TODO ever actually more than one cpl log?</span>
                <span class="k">for</span> <span class="n">cpllog</span> <span class="ow">in</span> <span class="n">newestcpllogfiles</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/(</span><span class="si">{}</span><span class="s2">.*.log).*.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">),</span> <span class="n">cpllog</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">baselog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basegen_dir</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.gz&quot;</span>

                        <span class="n">safe_copy</span><span class="p">(</span>
                            <span class="n">cpllog</span><span class="p">,</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basegen_dir</span><span class="p">,</span> <span class="n">baselog</span><span class="p">),</span>
                            <span class="n">preserve_meta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="n">perf_write_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">basegen_dir</span><span class="p">,</span> <span class="n">cpllog</span><span class="p">)</span></div>



<div class="viewcode-block" id="perf_check_for_memory_leak">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.perf_check_for_memory_leak">[docs]</a>
<span class="k">def</span> <span class="nf">perf_check_for_memory_leak</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">latestcpllogs</span> <span class="o">=</span> <span class="n">get_latest_cpl_logs</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cpllog</span> <span class="ow">in</span> <span class="n">latestcpllogs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">memlist</span> <span class="o">=</span> <span class="n">perf_get_memory_list</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">cpllog</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;insufficient data for memleak test&quot;</span>

        <span class="c1"># last day - second day, skip first day, can be too low while initializing</span>
        <span class="n">elapsed_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">memlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">memlist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">finalmem</span><span class="p">,</span> <span class="n">originalmem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">memlist</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">memdiff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">originalmem</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="n">finalmem</span> <span class="o">-</span> <span class="n">originalmem</span><span class="p">)</span> <span class="o">/</span> <span class="n">originalmem</span>

        <span class="k">if</span> <span class="n">memdiff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">leak</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;data for memleak test is insufficient&quot;</span>
        <span class="k">elif</span> <span class="n">memdiff</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="n">leak</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leak</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;memleak detected, memory went from </span><span class="si">{:f}</span><span class="s2"> to </span><span class="si">{:f}</span><span class="s2"> in </span><span class="si">{:d}</span><span class="s2"> days&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">originalmem</span><span class="p">,</span> <span class="n">finalmem</span><span class="p">,</span> <span class="n">elapsed_days</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">leak</span><span class="p">,</span> <span class="n">comment</span></div>



<div class="viewcode-block" id="FakeTest">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.FakeTest">[docs]</a>
<span class="k">class</span> <span class="nc">FakeTest</span><span class="p">(</span><span class="n">SystemTestsCommon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inheriters of the FakeTest Class are intended to test the code.</span>

<span class="sd">    All members of the FakeTest Class must</span>
<span class="sd">    have names beginning with &quot;TEST&quot; this is so that the find_system_test</span>
<span class="sd">    in utils.py will work with these classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requires_exe</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">_non_local</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_exe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;run_exe&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">requires_exe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script</span> <span class="o">=</span> <span class="n">script</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requires_exe</span> <span class="o">=</span> <span class="n">requires_exe</span>

    <span class="k">def</span> <span class="nf">_resetup_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">run_exe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;run_exe&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_resetup_case</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">reset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;run_exe&quot;</span><span class="p">,</span> <span class="n">run_exe</span><span class="p">)</span>

<div class="viewcode-block" id="FakeTest.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.FakeTest.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requires_exe</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span>
                <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sharedlib_only</span><span class="p">:</span>
            <span class="n">exeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;EXEROOT&quot;</span><span class="p">)</span>
            <span class="n">modelexe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exeroot</span><span class="p">,</span> <span class="s2">&quot;fake.exe&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;run_exe&quot;</span><span class="p">,</span> <span class="n">modelexe</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">modelexe</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_script</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">modelexe</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requires_exe</span><span class="p">:</span>
                <span class="n">build</span><span class="o">.</span><span class="n">post_build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="p">[],</span> <span class="n">build_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">modelexe</span><span class="p">),</span>
                    <span class="s2">&quot;Could not find expected file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modelexe</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;FakeTest build_phase complete </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">modelexe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requires_exe</span>
                    <span class="p">)</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="FakeTest.run_indv">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.FakeTest.run_indv">[docs]</a>
    <span class="k">def</span> <span class="nf">run_indv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;base&quot;</span><span class="p">,</span>
        <span class="n">st_archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">submit_resubmits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_init_generated_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">mpilib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MPILIB&quot;</span><span class="p">)</span>
        <span class="c1"># This flag is needed by mpt to run a script under mpiexec</span>
        <span class="k">if</span> <span class="n">mpilib</span> <span class="o">==</span> <span class="s2">&quot;mpt&quot;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MPI_SHEPHERD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_indv</span><span class="p">(</span>
            <span class="n">suffix</span><span class="p">,</span> <span class="n">st_archive</span><span class="o">=</span><span class="n">st_archive</span><span class="p">,</span> <span class="n">submit_resubmits</span><span class="o">=</span><span class="n">submit_resubmits</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTRUNPASS">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNPASS">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNPASS</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTRUNPASS.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNPASS.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">echo Insta pass</span>
<span class="s2">echo SUCCESSFUL TERMINATION &gt; </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{log}</span><span class="s2">.log.$LID</span>
<span class="s2">cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi1.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTRUNDIFF">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNDIFF">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNDIFF</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    You can generate a diff with this test as follows:</span>
<span class="sd">    1) Run the test and generate a baseline</span>
<span class="sd">    2) set TESTRUNDIFF_ALTERNATE environment variable to TRUE</span>
<span class="sd">    3) Re-run the same test from step 1 but do a baseline comparison instead of generation</span>
<span class="sd">      3.a) This should give you a DIFF</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TESTRUNDIFF.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNDIFF.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">echo Insta pass</span>
<span class="s2">echo SUCCESSFUL TERMINATION &gt; </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{log}</span><span class="s2">.log.$LID</span>
<span class="s2">if [ -z &quot;$TESTRUNDIFF_ALTERNATE&quot; ]; then</span>
<span class="s2">  cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi1.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc</span>
<span class="s2">else</span>
<span class="s2">  cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi2.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc</span>
<span class="s2">fi</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTRUNDIFFRESUBMIT">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNDIFFRESUBMIT">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNDIFFRESUBMIT</span><span class="p">(</span><span class="n">TESTRUNDIFF</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="TESTTESTDIFF">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTTESTDIFF">[docs]</a>
<span class="k">class</span> <span class="nc">TESTTESTDIFF</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTTESTDIFF.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTTESTDIFF.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">echo Insta pass</span>
<span class="s2">echo SUCCESSFUL TERMINATION &gt; </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{log}</span><span class="s2">.log.$LID</span>
<span class="s2">cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi1.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc</span>
<span class="s2">cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi2.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc.rest</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TESTTESTDIFF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span>
            <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TESTTESTDIFF.run_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTTESTDIFF.run_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TESTTESTDIFF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_phase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component_compare_test</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTRUNFAIL">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAIL">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNFAIL</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTRUNFAIL.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAIL.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">if [ -z &quot;$TESTRUNFAIL_PASS&quot; ]; then</span>
<span class="s2">  echo Insta fail</span>
<span class="s2">  echo model failed &gt; </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{log}</span><span class="s2">.log.$LID</span>
<span class="s2">  exit -1</span>
<span class="s2">else</span>
<span class="s2">  echo Insta pass</span>
<span class="s2">  echo SUCCESSFUL TERMINATION &gt; </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{log}</span><span class="s2">.log.$LID</span>
<span class="s2">  cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi1.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc</span>
<span class="s2">fi</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTRUNFAILRESET">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAILRESET">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNFAILRESET</span><span class="p">(</span><span class="n">TESTRUNFAIL</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This fake test can fail for two reasons:</span>
<span class="sd">    1. As in the TESTRUNFAIL test: If the environment variable TESTRUNFAIL_PASS is *not* set</span>
<span class="sd">    2. Even if that environment variable *is* set, it will fail if STOP_N differs from the</span>
<span class="sd">       original value</span>

<span class="sd">    The purpose of (2) is to ensure that test&#39;s values get properly reset if the test is</span>
<span class="sd">    rerun after an initial failure.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TESTRUNFAILRESET.run_indv">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAILRESET.run_indv">[docs]</a>
    <span class="k">def</span> <span class="nf">run_indv</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;base&quot;</span><span class="p">,</span>
        <span class="n">st_archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">submit_resubmits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_init_generated_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Make sure STOP_N matches the original value for the case. This tests that STOP_N</span>
        <span class="c1"># has been reset properly if we are rerunning the test after a failure.</span>
        <span class="n">env_test</span> <span class="o">=</span> <span class="n">EnvTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_caseroot</span><span class="p">())</span>
        <span class="n">stop_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_N&quot;</span><span class="p">)</span>
        <span class="n">stop_n_test</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">env_test</span><span class="o">.</span><span class="n">get_test_parameter</span><span class="p">(</span><span class="s2">&quot;STOP_N&quot;</span><span class="p">))</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">stop_n</span> <span class="o">==</span> <span class="n">stop_n_test</span><span class="p">,</span>
            <span class="s2">&quot;Expect STOP_N to match original (</span><span class="si">{}</span><span class="s2"> != </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stop_n</span><span class="p">,</span> <span class="n">stop_n_test</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Now modify STOP_N so that an error will be generated if it isn&#39;t reset properly</span>
        <span class="c1"># upon a rerun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;STOP_N&quot;</span><span class="p">,</span> <span class="n">stop_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">TESTRUNFAILRESET</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_indv</span><span class="p">(</span>
            <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">st_archive</span><span class="o">=</span><span class="n">st_archive</span><span class="p">,</span> <span class="n">submit_resubmits</span><span class="o">=</span><span class="n">submit_resubmits</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTRUNFAILEXC">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAILEXC">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNFAILEXC</span><span class="p">(</span><span class="n">TESTRUNPASS</span><span class="p">):</span>
<div class="viewcode-block" id="TESTRUNFAILEXC.run_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAILEXC.run_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Exception from run_phase&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTRUNSTARCFAIL">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNSTARCFAIL">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNSTARCFAIL</span><span class="p">(</span><span class="n">TESTRUNPASS</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_st_archive_case_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Exception from st archive&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="TESTBUILDFAIL">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTBUILDFAIL">[docs]</a>
<span class="k">class</span> <span class="nc">TESTBUILDFAIL</span><span class="p">(</span><span class="n">TESTRUNPASS</span><span class="p">):</span>
<div class="viewcode-block" id="TESTBUILDFAIL.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTBUILDFAIL.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;TESTBUILDFAIL_PASS&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">TESTRUNPASS</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sharedlib_only</span><span class="p">:</span>
                <span class="n">blddir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;EXEROOT&quot;</span><span class="p">)</span>
                <span class="n">bldlog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">blddir</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.bldlog.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_model</span><span class="p">(),</span> <span class="n">get_timestamp</span><span class="p">(</span><span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bldlog</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;BUILD FAIL: Intentional fail for testing infrastructure&quot;</span><span class="p">)</span>

                <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;BUILD FAIL: Intentional fail for testing infrastructure&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTBUILDFAILEXC">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTBUILDFAILEXC">[docs]</a>
<span class="k">class</span> <span class="nc">TESTBUILDFAILEXC</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Exception from init&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="TESTRUNUSERXMLCHANGE">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNUSERXMLCHANGE">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNUSERXMLCHANGE</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTRUNUSERXMLCHANGE.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNUSERXMLCHANGE.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">caseroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span>
        <span class="n">modelexe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;run_exe&quot;</span><span class="p">)</span>
        <span class="n">new_stop_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_N&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">cd </span><span class="si">{caseroot}</span>
<span class="s2">./xmlchange --file env_test.xml STOP_N=</span><span class="si">{stopn}</span>
<span class="s2">./xmlchange RESUBMIT=1,STOP_N=</span><span class="si">{stopn}</span><span class="s2">,CONTINUE_RUN=FALSE,RESUBMIT_SETS_CONTINUE_RUN=FALSE</span>
<span class="s2">cd -</span>
<span class="si">{originalexe}</span><span class="s2"> &quot;$@&quot;</span>
<span class="s2">cd </span><span class="si">{caseroot}</span>
<span class="s2">./xmlchange run_exe=</span><span class="si">{modelexe}</span>
<span class="s2">sleep 5</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">originalexe</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_exe</span><span class="p">,</span>
            <span class="n">caseroot</span><span class="o">=</span><span class="n">caseroot</span><span class="p">,</span>
            <span class="n">modelexe</span><span class="o">=</span><span class="n">modelexe</span><span class="p">,</span>
            <span class="n">stopn</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">new_stop_n</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">requires_exe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>


<div class="viewcode-block" id="TESTRUNUSERXMLCHANGE.run_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNUSERXMLCHANGE.run_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_indv</span><span class="p">(</span><span class="n">submit_resubmits</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTRUNSLOWPASS">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNSLOWPASS">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNSLOWPASS</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTRUNSLOWPASS.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNSLOWPASS.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">sleep 300</span>
<span class="s2">echo Slow pass</span>
<span class="s2">echo SUCCESSFUL TERMINATION &gt; </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{log}</span><span class="s2">.log.$LID</span>
<span class="s2">cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi1.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTMEMLEAKFAIL">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTMEMLEAKFAIL">[docs]</a>
<span class="k">class</span> <span class="nc">TESTMEMLEAKFAIL</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTMEMLEAKFAIL.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTMEMLEAKFAIL.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">testfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">,</span> <span class="s2">&quot;scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="s2">&quot;cpl.log.failmemleak.gz&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">echo Insta pass</span>
<span class="s2">gunzip -c </span><span class="si">{testfile}</span><span class="s2"> &gt; </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{log}</span><span class="s2">.log.$LID</span>
<span class="s2">cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi1.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">testfile</span><span class="o">=</span><span class="n">testfile</span><span class="p">,</span> <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TESTMEMLEAKPASS">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTMEMLEAKPASS">[docs]</a>
<span class="k">class</span> <span class="nc">TESTMEMLEAKPASS</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTMEMLEAKPASS.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTMEMLEAKPASS.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">testfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">,</span> <span class="s2">&quot;scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;tests&quot;</span><span class="p">,</span> <span class="s2">&quot;cpl.log.passmemleak.gz&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">echo Insta pass</span>
<span class="s2">gunzip -c </span><span class="si">{testfile}</span><span class="s2"> &gt; </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{log}</span><span class="s2">.log.$LID</span>
<span class="s2">cp </span><span class="si">{root}</span><span class="s2">/scripts/tests/cpl.hi1.nc.test </span><span class="si">{rundir}</span><span class="s2">/</span><span class="si">{case}</span><span class="s2">.cpl.hi.0.nc</span>
<span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">testfile</span><span class="o">=</span><span class="n">testfile</span><span class="p">,</span> <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  

  <script type="text/javascript">
    let baseUriRegex = /(.*\/cime)\/.*/g;
    let parsedUri = baseUriRegex.exec(document.baseURI);

    if (parsedUri != null && parsedUri.length == 2) {
      let baseUri = parsedUri[1];

      $.get(`${baseUri}/versions/versions.json`, function(data) {
        let versionElement = $("#versions");

        Object.keys(data).forEach(function(key) {
          let value = data[key];

          let item = `<dd><a href="${baseUri}/versions/${key}/html/">${value}</a></dd>`

          versionElement.append(item);
        });
      });
    }
  </script>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: master
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl id="versions">
        <dt>Versions</dt>
      </dl>
      
      
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>