<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIME.XML.grids &mdash; CIME master documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=30d551ce"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/pop_ver.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CIME
          </a>
              <div class="version">
                master
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../what_cime/index.html">What is CIME?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html">Case Control System Part 1: Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html#case-control-system-part-2-configuration-porting-testing-and-use-cases">Case Control System Part 2: Configuration, Porting, Testing and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_cpl/index.html">Building a Coupled Model with CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_tools/index.html">Miscellaneous Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_user/index.html">User Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xml_files/index.html">XML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CIME_api/modules.html">CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_api/modules.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CIME</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">CIME.XML.grids</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CIME.XML.grids</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Common interface to XML files which follow the grids format,</span>
<span class="sd">This is not an abstract class - but inherits from the abstact class GenericXML</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">CIME.XML.standard_module_setup</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">CIME.XML.files</span> <span class="kn">import</span> <span class="n">Files</span>
<span class="kn">from</span> <span class="nn">CIME.XML.generic_xml</span> <span class="kn">import</span> <span class="n">GenericXML</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Separator character for multiple grids within a single component (currently just used</span>
<span class="c1"># for GLC when there are multiple ice sheet grids). It is important that this character</span>
<span class="c1"># NOT appear in any file names - or anywhere in the path of directories holding input</span>
<span class="c1"># data.</span>
<span class="n">GRID_SEP</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span>


<div class="viewcode-block" id="Grids">
<a class="viewcode-back" href="../../../CIME_api/CIME.XML.html#CIME.XML.grids.Grids">[docs]</a>
<span class="k">class</span> <span class="nc">Grids</span><span class="p">(</span><span class="n">GenericXML</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comp_interface</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">Files</span><span class="p">(</span><span class="n">comp_interface</span><span class="o">=</span><span class="n">comp_interface</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">infile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">infile</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;GRIDS_SPEC_FILE&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; Grid specification file is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_schema</span><span class="p">(</span><span class="s2">&quot;GRIDS_SPEC_FILE&quot;</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot; grid file not found </span><span class="si">{</span><span class="n">infile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">GenericXML</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Getting false failures on izumi, change this to a warning</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Schema validity test fails for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_gridnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_grid_names</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_grid_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;grids&quot;</span><span class="p">)</span>
        <span class="n">model_grid_defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;model_grid_defaults&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">grids</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">model_grid_defaults</span><span class="p">)</span>
        <span class="n">gridnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gridnames</span><span class="p">:</span>
                <span class="n">gridnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gn</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gridnames</span><span class="p">:</span>
            <span class="n">gridnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gridnames</span>

<div class="viewcode-block" id="Grids.get_grid_info">
<a class="viewcode-back" href="../../../CIME_api/CIME.XML.html#CIME.XML.grids.Grids.get_grid_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_grid_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compset</span><span class="p">,</span> <span class="n">driver</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the matching grid node</span>

<span class="sd">        Returns a dictionary containing relevant grid variables: domains, gridmaps, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gridinfo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">atmnlev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lndnlev</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># mechanism to specify atm levels</span>
        <span class="n">atmlevregex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([^_]+)z(\d+)(.*)$&quot;</span><span class="p">)</span>
        <span class="n">levmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">atmlevregex</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">levmatch</span><span class="p">:</span>
            <span class="n">atmnlev</span> <span class="o">=</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># mechanism to specify lnd levels</span>
        <span class="n">lndlevregex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*_)([^_]+)z(\d+)(_[^m].*)$&quot;</span><span class="p">)</span>
        <span class="n">levmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lndlevregex</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">levmatch</span><span class="p">:</span>
            <span class="n">lndnlev</span> <span class="o">=</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># determine component_grids dictionary and grid longname</span>
        <span class="n">lname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_config_grids</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">compset</span><span class="p">,</span> <span class="n">atmnlev</span><span class="p">,</span> <span class="n">lndnlev</span><span class="p">)</span>
        <span class="n">gridinfo</span><span class="p">[</span><span class="s2">&quot;GRID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lname</span>
        <span class="n">component_grids</span> <span class="o">=</span> <span class="n">_ComponentGrids</span><span class="p">(</span><span class="n">lname</span><span class="p">)</span>

        <span class="c1"># determine domains given component_grids</span>
        <span class="n">domains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_domains</span><span class="p">(</span><span class="n">component_grids</span><span class="p">,</span> <span class="n">atmlevregex</span><span class="p">,</span> <span class="n">lndlevregex</span><span class="p">,</span> <span class="n">driver</span><span class="p">)</span>

        <span class="n">gridinfo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">domains</span><span class="p">)</span>

        <span class="c1"># determine gridmaps given component_grids</span>
        <span class="n">gridmaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gridmaps</span><span class="p">(</span><span class="n">component_grids</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">compset</span><span class="p">)</span>
        <span class="n">gridinfo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gridmaps</span><span class="p">)</span>

        <span class="n">component_grids</span><span class="o">.</span><span class="n">check_num_elements</span><span class="p">(</span><span class="n">gridinfo</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gridinfo</span></div>


    <span class="k">def</span> <span class="nf">_read_config_grids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">compset</span><span class="p">,</span> <span class="n">atmnlev</span><span class="p">,</span> <span class="n">lndnlev</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        read config_grids.xml with version 2.0 schema</span>

<span class="sd">        Returns a grid long name given the alias (&#39;name&#39; argument)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_grid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">comp_gridname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_gridnames</span><span class="p">:</span>
            <span class="n">model_grid</span><span class="p">[</span><span class="n">comp_gridname</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># (1) set array of component grid defaults that match current compset</span>
        <span class="n">grids_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;grids&quot;</span><span class="p">)</span>
        <span class="n">grid_defaults_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;model_grid_defaults&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">grids_node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">grid_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">grid_defaults_node</span><span class="p">):</span>
            <span class="n">name_attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grid_node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">compset_attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grid_node</span><span class="p">,</span> <span class="s2">&quot;compset&quot;</span><span class="p">)</span>
            <span class="n">compset_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">compset_attrib</span><span class="p">,</span> <span class="n">compset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">compset_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model_grid</span><span class="p">[</span><span class="n">name_attrib</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">grid_node</span><span class="p">)</span>

        <span class="c1"># (2)loop over all of the &quot;model grid&quot; nodes and determine is there an alias match with the</span>
        <span class="c1"># input grid name -  if there is an alias match determine if the &quot;compset&quot; and &quot;not_compset&quot;</span>
        <span class="c1"># regular expression attributes match the match the input compset</span>

        <span class="n">model_gridnodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;model_grid&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">grids_node</span><span class="p">)</span>
        <span class="n">model_gridnode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">foundalias</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">model_gridnodes</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;alias&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alias</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">foundalias</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">foundcompset</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">compset_attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;compset&quot;</span><span class="p">)</span>
                <span class="n">not_compset_attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;not_compset&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">compset_attrib</span> <span class="ow">and</span> <span class="n">not_compset_attrib</span><span class="p">:</span>
                    <span class="n">compset_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">compset_attrib</span><span class="p">,</span> <span class="n">compset</span><span class="p">)</span>
                    <span class="n">not_compset_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">not_compset_attrib</span><span class="p">,</span> <span class="n">compset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">compset_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">not_compset_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">foundcompset</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">model_gridnode</span> <span class="o">=</span> <span class="n">node</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Found match for </span><span class="si">{}</span><span class="s2"> with compset_match </span><span class="si">{}</span><span class="s2"> and not_compset_match </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">alias</span><span class="p">,</span> <span class="n">compset_attrib</span><span class="p">,</span> <span class="n">not_compset_attrib</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">elif</span> <span class="n">compset_attrib</span><span class="p">:</span>
                    <span class="n">compset_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">compset_attrib</span><span class="p">,</span> <span class="n">compset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">compset_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">foundcompset</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">model_gridnode</span> <span class="o">=</span> <span class="n">node</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Found match for </span><span class="si">{}</span><span class="s2"> with compset_match </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">alias</span><span class="p">,</span> <span class="n">compset_attrib</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">elif</span> <span class="n">not_compset_attrib</span><span class="p">:</span>
                    <span class="n">not_compset_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">not_compset_attrib</span><span class="p">,</span> <span class="n">compset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">not_compset_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">foundcompset</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">model_gridnode</span> <span class="o">=</span> <span class="n">node</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Found match for </span><span class="si">{}</span><span class="s2"> with not_compset_match </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">alias</span><span class="p">,</span> <span class="n">not_compset_attrib</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">foundcompset</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">model_gridnode</span> <span class="o">=</span> <span class="n">node</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found match for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
                    <span class="k">break</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">foundalias</span><span class="p">,</span> <span class="s2">&quot;no alias </span><span class="si">{}</span><span class="s2"> defined&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="c1"># if no match is found in config_grids.xml - exit</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">foundcompset</span><span class="p">,</span> <span class="s2">&quot;grid alias </span><span class="si">{}</span><span class="s2"> not valid for compset </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">compset</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># for the match - find all of the component grid settings</span>
        <span class="n">grid_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">model_gridnode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">grid_node</span> <span class="ow">in</span> <span class="n">grid_nodes</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grid_node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">grid_node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_grid</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
                <span class="n">model_grid</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">mask_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optional_child</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">model_gridnode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_grid</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mask_node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_grid</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_grid</span><span class="p">[</span><span class="s2">&quot;ocnice&quot;</span><span class="p">]</span>

        <span class="c1"># determine component grids and associated required domains and gridmaps</span>
        <span class="c1"># TODO: this should be in XML, not here</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;atm&quot;</span><span class="p">:</span> <span class="s2">&quot;a%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lnd&quot;</span><span class="p">:</span> <span class="s2">&quot;l%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ocnice&quot;</span><span class="p">:</span> <span class="s2">&quot;oi%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rof&quot;</span><span class="p">:</span> <span class="s2">&quot;r%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wav&quot;</span><span class="p">:</span> <span class="s2">&quot;w%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;glc&quot;</span><span class="p">:</span> <span class="s2">&quot;g%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="s2">&quot;m%&quot;</span><span class="p">,</span>
            <span class="s2">&quot;iac&quot;</span><span class="p">:</span> <span class="s2">&quot;z%&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">lname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">component_gridname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_gridnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lname</span><span class="p">:</span>
                <span class="n">lname</span> <span class="o">=</span> <span class="n">lname</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">prefix</span><span class="p">[</span><span class="n">component_gridname</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lname</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[</span><span class="n">component_gridname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model_grid</span><span class="p">[</span><span class="n">component_gridname</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lname</span> <span class="o">+=</span> <span class="n">model_grid</span><span class="p">[</span><span class="n">component_gridname</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">component_gridname</span> <span class="o">==</span> <span class="s2">&quot;atm&quot;</span> <span class="ow">and</span> <span class="n">atmnlev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;a</span><span class="si">{:n}</span><span class="s2">ull&quot;</span> <span class="ow">in</span> <span class="n">lname</span><span class="p">):</span>
                        <span class="n">lname</span> <span class="o">+=</span> <span class="s2">&quot;z&quot;</span> <span class="o">+</span> <span class="n">atmnlev</span>

                <span class="k">elif</span> <span class="n">component_gridname</span> <span class="o">==</span> <span class="s2">&quot;lnd&quot;</span> <span class="ow">and</span> <span class="n">lndnlev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;l</span><span class="si">{:n}</span><span class="s2">ull&quot;</span> <span class="ow">in</span> <span class="n">lname</span><span class="p">):</span>
                        <span class="n">lname</span> <span class="o">+=</span> <span class="s2">&quot;z&quot;</span> <span class="o">+</span> <span class="n">lndnlev</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">lname</span> <span class="o">+=</span> <span class="s2">&quot;null&quot;</span>
        <span class="k">return</span> <span class="n">lname</span>

    <span class="k">def</span> <span class="nf">_get_domains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_grids</span><span class="p">,</span> <span class="n">atmlevregex</span><span class="p">,</span> <span class="n">lndlevregex</span><span class="p">,</span> <span class="n">driver</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;determine domains dictionary for config_grids.xml v2 schema&quot;&quot;&quot;</span>
        <span class="n">domains</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mask_name</span> <span class="o">=</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridname</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">comp_name</span> <span class="ow">in</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_compnames</span><span class="p">(</span><span class="n">include_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">grid_name</span> <span class="ow">in</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridlist</span><span class="p">(</span><span class="n">comp_name</span><span class="p">):</span>
                <span class="c1"># Determine grid name with no nlev suffix if there is one</span>
                <span class="n">grid_name_nonlev</span> <span class="o">=</span> <span class="n">grid_name</span>
                <span class="n">levmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">atmlevregex</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">levmatch</span><span class="p">:</span>
                    <span class="n">grid_name_nonlev</span> <span class="o">=</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">levmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lndlevregex</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">levmatch</span><span class="p">:</span>
                    <span class="n">grid_name_nonlev</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">levmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_domains_for_one_grid</span><span class="p">(</span>
                    <span class="n">domains</span><span class="o">=</span><span class="n">domains</span><span class="p">,</span>
                    <span class="n">comp_name</span><span class="o">=</span><span class="n">comp_name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                    <span class="n">grid_name</span><span class="o">=</span><span class="n">grid_name</span><span class="p">,</span>
                    <span class="n">grid_name_nonlev</span><span class="o">=</span><span class="n">grid_name_nonlev</span><span class="p">,</span>
                    <span class="n">mask_name</span><span class="o">=</span><span class="n">mask_name</span><span class="p">,</span>
                    <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">driver</span> <span class="o">==</span> <span class="s2">&quot;nuopc&quot;</span><span class="p">:</span>
            <span class="c1"># Obtain the root node for the domain entry that sets the mask</span>
            <span class="k">if</span> <span class="n">domains</span><span class="p">[</span><span class="s2">&quot;MASK_GRID&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
                <span class="n">mask_domain_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optional_child</span><span class="p">(</span>
                    <span class="s2">&quot;domain&quot;</span><span class="p">,</span>
                    <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">domains</span><span class="p">[</span><span class="s2">&quot;MASK_GRID&quot;</span><span class="p">]},</span>
                    <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># Now obtain the mesh for the mask for the domain node for that component grid</span>
                <span class="n">mesh_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;mesh&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">mask_domain_node</span><span class="p">)</span>
                <span class="n">domains</span><span class="p">[</span><span class="s2">&quot;MASK_MESH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mesh_node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">domains</span>

    <span class="k">def</span> <span class="nf">_get_domains_for_one_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">domains</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">grid_name_nonlev</span><span class="p">,</span> <span class="n">mask_name</span><span class="p">,</span> <span class="n">driver</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get domain information for the given grid, adding elements to the domains dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">        - domains: dictionary of values, modified in place</span>
<span class="sd">        - comp_name: uppercase abbreviated name of component (e.g., &quot;ATM&quot;)</span>
<span class="sd">        - grid_name: name of this grid</span>
<span class="sd">        - grid_name_nonlev: same as grid_name but with any level information stripped out</span>
<span class="sd">        - mask_name: the mask being used in this case</span>
<span class="sd">        - driver: the name of the driver being used in this case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">domain_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optional_child</span><span class="p">(</span>
            <span class="s2">&quot;domain&quot;</span><span class="p">,</span>
            <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">grid_name_nonlev</span><span class="p">},</span>
            <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">domain_node</span><span class="p">:</span>
            <span class="n">domain_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optional_child</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="n">driver</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">domain_root</span><span class="p">:</span>
                <span class="n">domain_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optional_child</span><span class="p">(</span>
                    <span class="s2">&quot;domain&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">grid_name_nonlev</span><span class="p">},</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_root</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">domain_node</span><span class="p">:</span>
            <span class="c1"># determine xml variable name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;PTS_LAT&quot;</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                <span class="n">domains</span><span class="p">[</span><span class="s2">&quot;PTS_LAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-999.99&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;PTS_LON&quot;</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                <span class="n">domains</span><span class="p">[</span><span class="s2">&quot;PTS_LON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-999.99&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;MASK&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span><span class="s2">&quot;nx&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">):</span>
                    <span class="c1"># If there are multiple grids for this component, then the component</span>
                    <span class="c1"># _NX and _NY values won&#39;t end up being used, so we simply set them to 1</span>
                    <span class="n">_add_grid_info</span><span class="p">(</span>
                        <span class="n">domains</span><span class="p">,</span>
                        <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_NX&quot;</span><span class="p">,</span>
                        <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span><span class="s2">&quot;nx&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">)),</span>
                        <span class="n">value_for_multiple</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">_add_grid_info</span><span class="p">(</span>
                        <span class="n">domains</span><span class="p">,</span>
                        <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_NY&quot;</span><span class="p">,</span>
                        <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span><span class="s2">&quot;ny&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">)),</span>
                        <span class="n">value_for_multiple</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">):</span>
                    <span class="c1"># No need to call _add_grid_info here because, for multiple grids, the</span>
                    <span class="c1"># end result will be the same as the hard-coded 1 used here</span>
                    <span class="n">domains</span><span class="p">[</span><span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_NX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">domains</span><span class="p">[</span><span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_NY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">domains</span><span class="p">[</span><span class="s2">&quot;PTS_LAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">)</span>
                    <span class="n">domains</span><span class="p">[</span><span class="s2">&quot;PTS_LON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No need to call _add_grid_info here because, for multiple grids, the</span>
                    <span class="c1"># end result will be the same as the hard-coded 1 used here</span>
                    <span class="n">domains</span><span class="p">[</span><span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_NX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">domains</span><span class="p">[</span><span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_NY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">driver</span> <span class="o">==</span> <span class="s2">&quot;mct&quot;</span> <span class="ow">or</span> <span class="n">driver</span> <span class="o">==</span> <span class="s2">&quot;moab&quot;</span><span class="p">:</span>
                <span class="c1"># mct</span>
                <span class="n">file_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">)</span>
                <span class="n">domain_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">file_node</span> <span class="ow">in</span> <span class="n">file_nodes</span><span class="p">:</span>
                    <span class="n">grid_attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_node</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">)</span>
                    <span class="n">mask_attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_node</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">grid_attrib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_attrib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">grid_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">comp_name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">grid_attrib</span><span class="p">)</span>
                        <span class="n">mask_match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">mask_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">mask_match</span> <span class="o">=</span> <span class="n">mask_name</span> <span class="o">==</span> <span class="n">mask_attrib</span>
                        <span class="k">if</span> <span class="n">grid_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mask_match</span><span class="p">:</span>
                            <span class="n">domain_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">file_node</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">grid_attrib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">grid_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">comp_name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">grid_attrib</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">grid_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">domain_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">file_node</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">mask_attrib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">mask_match</span> <span class="o">=</span> <span class="n">mask_name</span> <span class="o">==</span> <span class="n">mask_attrib</span>
                        <span class="k">if</span> <span class="n">mask_match</span><span class="p">:</span>
                            <span class="n">domain_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">file_node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">domain_file</span><span class="p">:</span>
                    <span class="n">_add_grid_info</span><span class="p">(</span>
                        <span class="n">domains</span><span class="p">,</span>
                        <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_DOMAIN_FILE&quot;</span><span class="p">,</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">domain_file</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">domain_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_add_grid_info</span><span class="p">(</span><span class="n">domains</span><span class="p">,</span> <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_DOMAIN_PATH&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">driver</span> <span class="o">==</span> <span class="s2">&quot;nuopc&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;MASK&quot;</span><span class="p">:</span>
                    <span class="n">mesh_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;mesh&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">)</span>
                    <span class="n">mesh_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">mesh_node</span> <span class="ow">in</span> <span class="n">mesh_nodes</span><span class="p">:</span>
                        <span class="n">mesh_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mesh_node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mesh_file</span><span class="p">:</span>
                        <span class="n">_add_grid_info</span><span class="p">(</span><span class="n">domains</span><span class="p">,</span> <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_DOMAIN_MESH&quot;</span><span class="p">,</span> <span class="n">mesh_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;LND&quot;</span> <span class="ow">or</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s2">&quot;ATM&quot;</span><span class="p">:</span>
                        <span class="c1"># Note: ONLY want to define PTS_DOMAINFILE for land and ATM</span>
                        <span class="n">file_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optional_child</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">file_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">file_node</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;unset&quot;</span><span class="p">:</span>
                            <span class="n">domains</span><span class="p">[</span><span class="s2">&quot;PTS_DOMAINFILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">file_node</span><span class="p">)</span>
        <span class="c1"># set up dictionary of domain files for every component</span>
        <span class="n">_add_grid_info</span><span class="p">(</span><span class="n">domains</span><span class="p">,</span> <span class="n">comp_name</span> <span class="o">+</span> <span class="s2">&quot;_GRID&quot;</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_gridmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_grids</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">compset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set all mapping files for config_grids.xml v2 schema</span>

<span class="sd">        If a component (e.g., GLC) has multiple grids, then each mapping file variable for</span>
<span class="sd">        that component will be a colon-delimited list with the appropriate number of</span>
<span class="sd">        elements.</span>

<span class="sd">        If a given gridmap is required but not given explicitly, then its value will be</span>
<span class="sd">        either &quot;unset&quot; or &quot;idmap&quot;. Even in the case of a component with multiple grids</span>
<span class="sd">        (e.g., GLC), there will only be a single &quot;unset&quot; or &quot;idmap&quot; value. (We do not</span>
<span class="sd">        currently handle the possibility that some grids will have an &quot;idmap&quot; value while</span>
<span class="sd">        others have an explicit mapping file. So it is currently an error for &quot;idmap&quot; to</span>
<span class="sd">        appear in a mapping file variable for a component with multiple grids; this will</span>
<span class="sd">        be checked elsewhere.)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gridmaps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># (1) determine values of gridmaps for target grid</span>
        <span class="c1">#</span>
        <span class="c1"># Exclude the ice component from the list of compnames because it is assumed to be</span>
        <span class="c1"># on the same grid as ocn, so doesn&#39;t have any gridmaps of its own</span>
        <span class="n">compnames</span> <span class="o">=</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_compnames</span><span class="p">(</span>
            <span class="n">include_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_comps</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ice&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">compname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compnames</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">other_compname</span> <span class="ow">in</span> <span class="n">compnames</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]:</span>
                <span class="k">for</span> <span class="n">gridvalue</span> <span class="ow">in</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridlist</span><span class="p">(</span><span class="n">compname</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">other_gridvalue</span> <span class="ow">in</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridlist</span><span class="p">(</span>
                        <span class="n">other_compname</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_get_gridmaps_for_one_grid_pair</span><span class="p">(</span>
                            <span class="n">gridmaps</span><span class="o">=</span><span class="n">gridmaps</span><span class="p">,</span>
                            <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span>
                            <span class="n">compname</span><span class="o">=</span><span class="n">compname</span><span class="p">,</span>
                            <span class="n">other_compname</span><span class="o">=</span><span class="n">other_compname</span><span class="p">,</span>
                            <span class="n">gridvalue</span><span class="o">=</span><span class="n">gridvalue</span><span class="p">,</span>
                            <span class="n">other_gridvalue</span><span class="o">=</span><span class="n">other_gridvalue</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="c1"># (2) set all possibly required gridmaps to &#39;idmap&#39; for mct and &#39;unset/idmap&#39; for</span>
        <span class="c1"># nuopc, if they aren&#39;t already set</span>
        <span class="n">required_gridmaps_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;required_gridmaps&quot;</span><span class="p">)</span>
        <span class="n">tmp_gridmap_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span>
            <span class="s2">&quot;required_gridmap&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">required_gridmaps_node</span>
        <span class="p">)</span>
        <span class="n">required_gridmap_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tmp_gridmap_nodes</span><span class="p">:</span>
            <span class="n">compset_att</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;compset&quot;</span><span class="p">)</span>
            <span class="n">not_compset_att</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;not_compset&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">compset_att</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">compset_att</span> <span class="ow">in</span> <span class="n">compset</span>
                <span class="ow">or</span> <span class="n">not_compset_att</span>
                <span class="ow">and</span> <span class="n">not_compset_att</span> <span class="ow">in</span> <span class="n">compset</span>
            <span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">required_gridmap_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">mapname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mapname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gridmaps</span><span class="p">:</span>
                <span class="n">gridmaps</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_unset_gridmap_value</span><span class="p">(</span>
                    <span class="n">mapname</span><span class="p">,</span> <span class="n">component_grids</span><span class="p">,</span> <span class="n">driver</span>
                <span class="p">)</span>

        <span class="c1"># (3) check that all necessary maps are not set to idmap</span>
        <span class="c1">#</span>
        <span class="c1"># NOTE(wjs, 2021-05-18) This could probably be combined with the above loop, but</span>
        <span class="c1"># I&#39;m avoiding making that change now due to fear of breaking this complex logic</span>
        <span class="c1"># that isn&#39;t covered by unit tests.</span>
        <span class="n">atm_gridvalue</span> <span class="o">=</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridname</span><span class="p">(</span><span class="s2">&quot;atm&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">required_gridmap_nodes</span><span class="p">:</span>
            <span class="n">comp1_name</span> <span class="o">=</span> <span class="n">_strip_grid_from_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;grid1&quot;</span><span class="p">))</span>
            <span class="n">comp2_name</span> <span class="o">=</span> <span class="n">_strip_grid_from_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;grid2&quot;</span><span class="p">))</span>
            <span class="n">grid1_value</span> <span class="o">=</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridname</span><span class="p">(</span><span class="n">comp1_name</span><span class="p">)</span>
            <span class="n">grid2_value</span> <span class="o">=</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridname</span><span class="p">(</span><span class="n">comp2_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grid1_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid2_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">grid1_value</span> <span class="o">!=</span> <span class="n">grid2_value</span>
                    <span class="ow">and</span> <span class="n">grid1_value</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span>
                    <span class="ow">and</span> <span class="n">grid2_value</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span>
                <span class="p">):</span>
                    <span class="n">map_</span> <span class="o">=</span> <span class="n">gridmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">map_</span> <span class="o">==</span> <span class="s2">&quot;idmap&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">comp1_name</span> <span class="o">==</span> <span class="s2">&quot;ocn&quot;</span> <span class="ow">and</span> <span class="n">grid1_value</span> <span class="o">==</span> <span class="n">atm_gridvalue</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;ocn_grid == atm_grid so this is not an idmap error&quot;</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">driver</span> <span class="o">==</span> <span class="s2">&quot;nuopc&quot;</span><span class="p">:</span>
                                <span class="n">gridmaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;unset&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;Warning: missing non-idmap </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
                                        <span class="n">comp1_name</span><span class="p">,</span>
                                        <span class="n">grid1_value</span><span class="p">,</span>
                                        <span class="n">comp2_name</span><span class="p">,</span>
                                        <span class="n">grid2_value</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>

        <span class="k">return</span> <span class="n">gridmaps</span>

    <span class="k">def</span> <span class="nf">_get_gridmaps_for_one_grid_pair</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gridmaps</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">compname</span><span class="p">,</span> <span class="n">other_compname</span><span class="p">,</span> <span class="n">gridvalue</span><span class="p">,</span> <span class="n">other_gridvalue</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get gridmap information for one pair of grids, adding elements to the gridmaps dictionary</span>

<span class="sd">        Args:</span>
<span class="sd">        - gridmaps: dictionary of values, modified in place</span>
<span class="sd">        - driver: the name of the driver being used in this case</span>
<span class="sd">        - compname: abbreviated name of component (e.g., &quot;atm&quot;)</span>
<span class="sd">        - other_compname: abbreviated name of other component (e.g., &quot;ocn&quot;)</span>
<span class="sd">        - gridvalue: name of grid for compname</span>
<span class="sd">        - other_gridvalue: name of grid for other_compname</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gridmaps_roots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;gridmaps&quot;</span><span class="p">)</span>
        <span class="n">gridmap_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">gridmaps_roots</span><span class="p">:</span>
            <span class="n">gmdriver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;driver&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gmdriver</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">gmdriver</span> <span class="o">==</span> <span class="n">driver</span><span class="p">:</span>
                <span class="n">gridname</span> <span class="o">=</span> <span class="n">compname</span> <span class="o">+</span> <span class="s2">&quot;_grid&quot;</span>
                <span class="n">other_gridname</span> <span class="o">=</span> <span class="n">other_compname</span> <span class="o">+</span> <span class="s2">&quot;_grid&quot;</span>
                <span class="n">gridmap_nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span>
                        <span class="s2">&quot;gridmap&quot;</span><span class="p">,</span>
                        <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">,</span>
                        <span class="n">attributes</span><span class="o">=</span><span class="p">{</span>
                            <span class="n">gridname</span><span class="p">:</span> <span class="n">gridvalue</span><span class="p">,</span>
                            <span class="n">other_gridname</span><span class="p">:</span> <span class="n">other_gridvalue</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># We first create a dictionary of gridmaps just for this pair of grids, then later</span>
        <span class="c1"># add these grids to the main gridmaps dict using _add_grid_info. The reason for</span>
        <span class="c1"># doing this in two steps, using the intermediate these_gridmaps variable, is: If</span>
        <span class="c1"># there are multiple definitions of a given gridmap for a given grid pair, we just</span>
        <span class="c1"># want to use one of them, rather than adding them all to the final gridmaps dict.</span>
        <span class="c1"># (This may not occur in practice, but the logic allowed for this possibility</span>
        <span class="c1"># before extending it to handle multiple grids for a given component, so we are</span>
        <span class="c1"># leaving this possibility in place.)</span>
        <span class="n">these_gridmaps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">gridmap_node</span> <span class="ow">in</span> <span class="n">gridmap_nodes</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrib</span><span class="p">(</span><span class="n">gridmap_node</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot; Bad attribute count in gridmap node </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrib</span><span class="p">(</span><span class="n">gridmap_node</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">map_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">gridmap_node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">map_node</span> <span class="ow">in</span> <span class="n">map_nodes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">map_node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">map_node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">these_gridmaps</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; gridmap name,value are </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">these_gridmaps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_add_grid_info</span><span class="p">(</span><span class="n">gridmaps</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="Grids.print_values">
<a class="viewcode-back" href="../../../CIME_api/CIME.XML.html#CIME.XML.grids.Grids.print_values">[docs]</a>
    <span class="k">def</span> <span class="nf">print_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">long_output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># write out help message</span>
        <span class="n">helptext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_text</span><span class="p">(</span><span class="s2">&quot;help&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">helptext</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{:5s}</span><span class="s2">-------------------------------------------------------------&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:10s}</span><span class="s2">  default component grids:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;     component         compset       value &quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{:5s}</span><span class="s2">-------------------------------------------------------------&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">default_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span>
            <span class="s2">&quot;model_grid_defaults&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;grids&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">default_node</span> <span class="ow">in</span> <span class="n">default_nodes</span><span class="p">:</span>
            <span class="n">grid_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">default_node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">grid_node</span> <span class="ow">in</span> <span class="n">grid_nodes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grid_node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="n">compset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grid_node</span><span class="p">,</span> <span class="s2">&quot;compset&quot;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">grid_node</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;     </span><span class="si">{:6s}</span><span class="s2">   </span><span class="si">{:15s}</span><span class="s2">   </span><span class="si">{:10s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">compset</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{:5s}</span><span class="s2">-------------------------------------------------------------&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">domains</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">long_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;domain&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;domains&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">domain_node</span> <span class="ow">in</span> <span class="n">domain_nodes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">domain_node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">))</span>
                <span class="n">files</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">file_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">domain_node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file_node</span> <span class="ow">in</span> <span class="n">file_nodes</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">file_node</span><span class="p">)</span>
                    <span class="n">mask_attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_node</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">)</span>
                    <span class="n">grid_attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_node</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">)</span>
                    <span class="n">files</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">       &quot;</span> <span class="o">+</span> <span class="n">filename</span>
                    <span class="k">if</span> <span class="n">mask_attrib</span> <span class="ow">or</span> <span class="n">grid_attrib</span><span class="p">:</span>
                        <span class="n">files</span> <span class="o">+=</span> <span class="s2">&quot; (only for&quot;</span>
                    <span class="k">if</span> <span class="n">mask_attrib</span><span class="p">:</span>
                        <span class="n">files</span> <span class="o">+=</span> <span class="s2">&quot; mask: &quot;</span> <span class="o">+</span> <span class="n">mask_attrib</span>
                    <span class="k">if</span> <span class="n">grid_attrib</span><span class="p">:</span>
                        <span class="n">files</span> <span class="o">+=</span> <span class="s2">&quot; grid match: &quot;</span> <span class="o">+</span> <span class="n">grid_attrib</span>
                    <span class="k">if</span> <span class="n">mask_attrib</span> <span class="ow">or</span> <span class="n">grid_attrib</span><span class="p">:</span>
                        <span class="n">files</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
                <span class="n">domains</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">       </span><span class="si">{}</span><span class="s2"> with domain file(s): </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">desc</span><span class="p">,</span> <span class="n">files</span>
                <span class="p">)</span>

        <span class="n">model_grid_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;model_grid&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;grids&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">model_grid_node</span> <span class="ow">in</span> <span class="n">model_grid_nodes</span><span class="p">:</span>
            <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_grid_node</span><span class="p">,</span> <span class="s2">&quot;alias&quot;</span><span class="p">)</span>
            <span class="n">compset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_grid_node</span><span class="p">,</span> <span class="s2">&quot;compset&quot;</span><span class="p">)</span>
            <span class="n">not_compset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_grid_node</span><span class="p">,</span> <span class="s2">&quot;not_compset&quot;</span><span class="p">)</span>
            <span class="n">restriction</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">compset</span><span class="p">:</span>
                <span class="n">restriction</span> <span class="o">+=</span> <span class="s2">&quot;only for compsets that are </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">not_compset</span><span class="p">:</span>
                <span class="n">restriction</span> <span class="o">+=</span> <span class="s2">&quot;only for compsets that are not </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">not_compset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">restriction</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">     alias: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">restriction</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">     alias: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span>
            <span class="n">grid_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">model_grid_node</span><span class="p">)</span>
            <span class="n">grids</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">gridnames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">grid_node</span> <span class="ow">in</span> <span class="n">grid_nodes</span><span class="p">:</span>
                <span class="n">gridnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">grid_node</span><span class="p">))</span>
                <span class="n">grids</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grid_node</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">grid_node</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;       non-default grids are: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grids</span><span class="p">))</span>
            <span class="n">mask_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">model_grid_node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mask_node</span> <span class="ow">in</span> <span class="n">mask_nodes</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;       mask is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mask_node</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">long_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">gridnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gridnames</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">gridname</span> <span class="ow">in</span> <span class="n">gridnames</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gridname</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">domains</span><span class="p">[</span><span class="n">gridname</span><span class="p">]))</span></div>
</div>



<span class="c1"># ------------------------------------------------------------------------</span>
<span class="c1"># Helper class: _ComponentGrids</span>
<span class="c1"># ------------------------------------------------------------------------</span>


<span class="k">class</span> <span class="nc">_ComponentGrids</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class stores the grid names for each component and allows retrieval in a variety</span>
<span class="sd">    of formats</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Mappings from component names to the single characters used in the grid long name.</span>
    <span class="c1"># Ordering is potentially important here, because it will determine the order in the</span>
    <span class="c1"># list returned by get_compnames, which will in turn impact ordering of components in</span>
    <span class="c1"># iterations.</span>
    <span class="c1">#</span>
    <span class="c1"># TODO: this should be in XML, not here</span>
    <span class="n">_COMP_NAMES</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;atm&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;lnd&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ocn&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ice&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;rof&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;glc&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;wav&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;iac&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_longname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_gridnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_component_grids_from_longname</span><span class="p">(</span><span class="n">grid_longname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_component_grids_from_longname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dictionary mapping each compname to its gridname&quot;&quot;&quot;</span>
        <span class="n">grid_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[_]{0,1}[a-z]{1,2}%&quot;</span><span class="p">)</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="n">grid_re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">prefixes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;[a-z]+%&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">component_grids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">grids</span><span class="p">):</span>
            <span class="c1"># In the following, [:-1] strips the trailing &#39;%&#39;</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefixes</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">component_grids</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">component_grids</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_grids</span><span class="p">[</span><span class="s2">&quot;oi&quot;</span><span class="p">]</span>
        <span class="n">component_grids</span><span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_grids</span><span class="p">[</span><span class="s2">&quot;oi&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">component_grids</span><span class="p">[</span><span class="s2">&quot;oi&quot;</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">compname</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COMP_NAMES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">compname</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_grids</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_compnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_comps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of all component names (lower case)</span>

<span class="sd">        This can be used for iterating through the grid names</span>

<span class="sd">        If include_mask is True (the default), then &#39;mask&#39; is included in the list of</span>
<span class="sd">        returned component names.</span>

<span class="sd">        If exclude_comps is given, then it should be a list of component names to exclude</span>
<span class="sd">        from the returned list. For example, if it is [&#39;ice&#39;, &#39;rof&#39;], then &#39;ice&#39; and &#39;rof&#39;</span>
<span class="sd">        are NOT included in the returned list.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exclude_comps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_exclude_comps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_exclude_comps</span> <span class="o">=</span> <span class="n">exclude_comps</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_mask</span><span class="p">:</span>
            <span class="n">all_exclude_comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_COMP_NAMES</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_exclude_comps</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_comp_gridname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the grid name for the given component name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_gridnames</span><span class="p">[</span><span class="n">compname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_comp_gridlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of individual grids for the given component name</span>

<span class="sd">        Usually this list has only a single grid (so the return value will be a</span>
<span class="sd">        single-element list like [&quot;0.9x1.25&quot;]). However, the glc component (glc) can have</span>
<span class="sd">        multiple grids, separated by GRID_SEP. In this situation, the return value for</span>
<span class="sd">        GLC will have multiple elements.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gridname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_comp_gridname</span><span class="p">(</span><span class="n">compname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gridname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">GRID_SEP</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_comp_numgrids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of grids for the given component name</span>

<span class="sd">        Usually this is one, but the glc component can have multiple grids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_comp_gridlist</span><span class="p">(</span><span class="n">compname</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_gridmap_total_nmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridmap_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a gridmap_name like ATM2OCN_FMAPNAME, return the total number of maps needed between the two components</span>

<span class="sd">        In most cases, this will be 1, but if either or both components has multiple grids,</span>
<span class="sd">        then this will be the product of the number of grids for each component.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comp1_name</span><span class="p">,</span> <span class="n">comp2_name</span> <span class="o">=</span> <span class="n">_get_compnames_from_mapname</span><span class="p">(</span><span class="n">gridmap_name</span><span class="p">)</span>
        <span class="n">comp1_ngrids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_comp_numgrids</span><span class="p">(</span><span class="n">comp1_name</span><span class="p">)</span>
        <span class="n">comp2_ngrids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_comp_numgrids</span><span class="p">(</span><span class="n">comp2_name</span><span class="p">)</span>
        <span class="n">total_nmaps</span> <span class="o">=</span> <span class="n">comp1_ngrids</span> <span class="o">*</span> <span class="n">comp2_ngrids</span>
        <span class="k">return</span> <span class="n">total_nmaps</span>

    <span class="k">def</span> <span class="nf">check_num_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridinfo</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check each member of gridinfo to make sure that it has the correct number of elements</span>

<span class="sd">        gridinfo is a dict mapping variable names to their values</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">compname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compnames</span><span class="p">(</span><span class="n">include_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">gridinfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># Non-string values only hold a single element, regardless of how many</span>
                    <span class="c1"># grids there are for a component. This is enforced in _add_grid_info</span>
                    <span class="c1"># by requiring value_for_multiple to be provided for non-string</span>
                    <span class="c1"># values. For now, it is *only* those non-string values that only</span>
                    <span class="c1"># carry a single element regardless of the number of grids. If, in the</span>
                    <span class="c1"># future, other variables are added with this property, then this</span>
                    <span class="c1"># logic would need to be extended to skip those variables as well.</span>
                    <span class="c1"># (This could be done by hard-coding some suffixes to skip here. A</span>
                    <span class="c1"># better alternative could be to do away with the value_for_multiple</span>
                    <span class="c1"># argument in _add_grid_info, instead setting a module-level</span>
                    <span class="c1"># dictionary mapping suffixes to their value_for_multiple, and</span>
                    <span class="c1"># referencing that dictionary in both _add_grid_info and here. For</span>
                    <span class="c1"># example: _VALUE_FOR_MULTIPLE = {&#39;_NX&#39;: 1, &#39;_NY&#39;: 1, &#39;_FOO&#39;: &#39;bar&#39;}.)</span>
                    <span class="k">continue</span>
                <span class="n">name_lower</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name_lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">compname</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">name_lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">compname</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">):</span>
                        <span class="n">expected_num_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_comp_numgrids</span><span class="p">(</span><span class="n">compname</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name_lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">compname</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span><span class="p">):</span>
                        <span class="n">expected_num_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gridmap_total_nmaps</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># We don&#39;t know what to expect if the character after compname is</span>
                        <span class="c1"># neither &quot;_&quot; nor &quot;2&quot;</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;unset&quot;</span><span class="p">:</span>
                        <span class="c1"># It&#39;s okay for there to be a single &quot;unset&quot; value even for a</span>
                        <span class="c1"># component with multiple grids</span>
                        <span class="k">continue</span>
                    <span class="n">num_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">GRID_SEP</span><span class="p">))</span>
                    <span class="n">expect</span><span class="p">(</span>
                        <span class="n">num_elements</span> <span class="o">==</span> <span class="n">expected_num_elements</span><span class="p">,</span>
                        <span class="s2">&quot;Unexpected number of colon-delimited elements in </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> (expected </span><span class="si">{}</span><span class="s2"> elements)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expected_num_elements</span>
                        <span class="p">),</span>
                    <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------------</span>
<span class="c1"># Some helper functions</span>
<span class="c1"># ------------------------------------------------------------------------</span>


<span class="k">def</span> <span class="nf">_get_compnames_from_mapname</span><span class="p">(</span><span class="n">mapname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a mapname like ATM2OCN_FMAPNAME, return the two component names</span>

<span class="sd">    The returned component names are lowercase. So, for example, if mapname is</span>
<span class="sd">    ATM2OCN_FMAPNAME, then this function returns a tuple (&#39;atm&#39;, &#39;ocn&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comp1_name</span> <span class="o">=</span> <span class="n">mapname</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">comp2_name</span> <span class="o">=</span> <span class="n">mapname</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">comp1_name</span><span class="p">,</span> <span class="n">comp2_name</span>


<span class="k">def</span> <span class="nf">_strip_grid_from_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given some string &#39;name&#39;, strip trailing &#39;_grid&#39; from name and return result</span>

<span class="sd">    Raises an exception if &#39;name&#39; doesn&#39;t end with &#39;_grid&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_grid&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not end with _grid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">name</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;_grid&quot;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">_add_grid_info</span><span class="p">(</span><span class="n">info_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_for_multiple</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a value to info_dict, handling the possibility of multiple grids for a component</span>

<span class="sd">    In the basic case, where key is not yet present in info_dict, this is equivalent to</span>
<span class="sd">    setting:</span>
<span class="sd">        info_dict[key] = value</span>

<span class="sd">    However, if the given key is already present, then instead of overriding the old</span>
<span class="sd">    value, we instead concatenate, separated by GRID_SEP. This is used in case there are</span>
<span class="sd">    multiple grids for a given component. An exception to this behavior is: If</span>
<span class="sd">    value_for_multiple is specified (not None) then, if we find an existing value, then we</span>
<span class="sd">    instead replace the value with the value given by value_for_multiple.</span>

<span class="sd">    value_for_multiple must be specified if value is not a string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">value_for_multiple</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;_add_grid_info: value_for_multiple must be specified if value is not a string&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value_for_multiple</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_for_multiple</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GRID_SEP</span> <span class="o">+</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">_get_unset_gridmap_value</span><span class="p">(</span><span class="n">mapname</span><span class="p">,</span> <span class="n">component_grids</span><span class="p">,</span> <span class="n">driver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the appropriate setting for a given gridmap that has not been explicitly set</span>

<span class="sd">    This will be &#39;unset&#39; or &#39;idmap&#39; depending on various parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">driver</span> <span class="o">==</span> <span class="s2">&quot;nuopc&quot;</span><span class="p">:</span>
        <span class="n">comp1_name</span><span class="p">,</span> <span class="n">comp2_name</span> <span class="o">=</span> <span class="n">_get_compnames_from_mapname</span><span class="p">(</span><span class="n">mapname</span><span class="p">)</span>
        <span class="n">grid1</span> <span class="o">=</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridname</span><span class="p">(</span><span class="n">comp1_name</span><span class="p">)</span>
        <span class="n">grid2</span> <span class="o">=</span> <span class="n">component_grids</span><span class="o">.</span><span class="n">get_comp_gridname</span><span class="p">(</span><span class="n">comp2_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grid1</span> <span class="o">==</span> <span class="n">grid2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grid1</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span> <span class="ow">and</span> <span class="n">grid2</span> <span class="o">!=</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
                <span class="n">gridmap</span> <span class="o">=</span> <span class="s2">&quot;idmap&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gridmap</span> <span class="o">=</span> <span class="s2">&quot;unset&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gridmap</span> <span class="o">=</span> <span class="s2">&quot;unset&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gridmap</span> <span class="o">=</span> <span class="s2">&quot;idmap&quot;</span>

    <span class="k">return</span> <span class="n">gridmap</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>