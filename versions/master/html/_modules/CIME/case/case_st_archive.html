<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIME.case.case_st_archive &mdash; CIME master documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=30d551ce"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/pop_ver.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CIME
          </a>
              <div class="version">
                master
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../what_cime/index.html">What is CIME?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html">Case Control System Part 1: Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html#case-control-system-part-2-configuration-porting-testing-and-use-cases">Case Control System Part 2: Configuration, Porting, Testing and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_cpl/index.html">Building a Coupled Model with CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_tools/index.html">Miscellaneous Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_user/index.html">User Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xml_files/index.html">XML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CIME_api/modules.html">CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_api/modules.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CIME</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">CIME.case.case_st_archive</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CIME.case.case_st_archive</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">short term archiving</span>
<span class="sd">case_st_archive, restore_from_archive, archive_last_restarts</span>
<span class="sd">are members of class Case from file case.py</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">CIME.XML.standard_module_setup</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">run_and_log_case_status</span><span class="p">,</span>
    <span class="n">ls_sorted_by_mtime</span><span class="p">,</span>
    <span class="n">symlink_force</span><span class="p">,</span>
    <span class="n">safe_copy</span><span class="p">,</span>
    <span class="n">find_files</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span> <span class="kn">import</span> <span class="n">batch_jobid</span>
<span class="kn">from</span> <span class="nn">CIME.date</span> <span class="kn">import</span> <span class="n">get_file_date</span>
<span class="kn">from</span> <span class="nn">CIME.XML.archive</span> <span class="kn">import</span> <span class="n">Archive</span>
<span class="kn">from</span> <span class="nn">CIME.XML.files</span> <span class="kn">import</span> <span class="n">Files</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isdir</span><span class="p">,</span> <span class="n">join</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_get_archive_fn_desc</span><span class="p">(</span><span class="n">archive_fn</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>
    <span class="k">return</span> <span class="s2">&quot;moving&quot;</span> <span class="k">if</span> <span class="n">archive_fn</span> <span class="ow">is</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span> <span class="k">else</span> <span class="s2">&quot;copying&quot;</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_get_archive_file_fn</span><span class="p">(</span><span class="n">copy_only</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the function to use for archiving some files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">safe_copy</span> <span class="k">if</span> <span class="n">copy_only</span> <span class="k">else</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_get_datenames</span><span class="p">(</span><span class="n">casename</span><span class="p">,</span> <span class="n">rundir</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the date objects specifying the times of each file</span>
<span class="sd">    Note we are assuming that the coupler restart files exist and are consistent with other component datenames</span>
<span class="sd">    Not doc-testable due to filesystem dependence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">isdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">),</span> <span class="s2">&quot;Cannot open directory </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="p">))</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">casename</span> <span class="o">+</span> <span class="s2">&quot;.cpl.r.*.nc&quot;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">casename</span> <span class="o">+</span> <span class="s2">&quot;.cpl_0001.r.*.nc&quot;</span><span class="p">)))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  cpl files : </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Cannot find a </span><span class="si">{}</span><span class="s2">.cpl*.r.*.nc file in directory </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">casename</span><span class="p">,</span> <span class="n">rundir</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">datenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">file_date</span> <span class="o">=</span> <span class="n">get_file_date</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">datenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datenames</span>


<span class="k">def</span> <span class="nf">_datetime_str</span><span class="p">(</span><span class="n">_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the standard format associated with filenames.</span>

<span class="sd">    &gt;&gt;&gt; from CIME.date import date</span>
<span class="sd">    &gt;&gt;&gt; _datetime_str(date(5, 8, 22))</span>
<span class="sd">    &#39;0005-08-22-00000&#39;</span>
<span class="sd">    &gt;&gt;&gt; _datetime_str(get_file_date(&quot;0011-12-09-00435&quot;))</span>
<span class="sd">    &#39;0011-12-09-00435&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">format_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{year:04d}</span><span class="s2">-</span><span class="si">{month:02d}</span><span class="s2">-</span><span class="si">{day:02d}</span><span class="s2">-</span><span class="si">{seconds:05d}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">format_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">year</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">year</span><span class="p">(),</span>
        <span class="n">month</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">month</span><span class="p">(),</span>
        <span class="n">day</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">day</span><span class="p">(),</span>
        <span class="n">seconds</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">second_of_day</span><span class="p">(),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_datetime_str_mpas</span><span class="p">(</span><span class="n">_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the mpas format associated with filenames.</span>

<span class="sd">    &gt;&gt;&gt; from CIME.date import date</span>
<span class="sd">    &gt;&gt;&gt; _datetime_str_mpas(date(5, 8, 22))</span>
<span class="sd">    &#39;0005-08-22_00:00:00&#39;</span>
<span class="sd">    &gt;&gt;&gt; _datetime_str_mpas(get_file_date(&quot;0011-12-09-00435&quot;))</span>
<span class="sd">    &#39;0011-12-09_00:07:15&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">format_string</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{year:04d}</span><span class="s2">-</span><span class="si">{month:02d}</span><span class="s2">-</span><span class="si">{day:02d}</span><span class="s2">_</span><span class="si">{hours:02d}</span><span class="s2">:</span><span class="si">{minutes:02d}</span><span class="s2">:</span><span class="si">{seconds:02d}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">format_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">year</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">year</span><span class="p">(),</span>
        <span class="n">month</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">month</span><span class="p">(),</span>
        <span class="n">day</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">day</span><span class="p">(),</span>
        <span class="n">hours</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">hour</span><span class="p">(),</span>
        <span class="n">minutes</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">minute</span><span class="p">(),</span>
        <span class="n">seconds</span><span class="o">=</span><span class="n">_date</span><span class="o">.</span><span class="n">second</span><span class="p">(),</span>
    <span class="p">)</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_get_ninst_info</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">compclass</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the number of instances used by a component and suffix strings for filenames</span>
<span class="sd">    Not doc-testable due to case dependence</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ninst</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;NINST_&quot;</span> <span class="o">+</span> <span class="n">compclass</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">ninst_strings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">ninst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ninst</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ninst</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ninst</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ninst_strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:04d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;ninst and ninst_strings are: </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ninst</span><span class="p">,</span> <span class="n">ninst_strings</span><span class="p">,</span> <span class="n">compclass</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ninst</span><span class="p">,</span> <span class="n">ninst_strings</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_get_component_archive_entries</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">archive</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Each time this generator function is called, it yields a tuple</span>
<span class="sd">    (archive_entry, compname, compclass) for one component in this</span>
<span class="sd">    case&#39;s compset components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">compname</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;compname is </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compname</span><span class="p">))</span>
        <span class="n">archive_entry</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_entry</span><span class="p">(</span><span class="n">compname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">archive_entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No entry found for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compname</span><span class="p">))</span>
            <span class="n">compclass</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compclass</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">archive_entry</span><span class="p">,</span> <span class="s2">&quot;compclass&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">archive_entry</span><span class="p">,</span> <span class="n">compname</span><span class="p">,</span> <span class="n">compclass</span><span class="p">)</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_archive_rpointer_files</span><span class="p">(</span>
    <span class="n">casename</span><span class="p">,</span>
    <span class="n">ninst_strings</span><span class="p">,</span>
    <span class="n">rundir</span><span class="p">,</span>
    <span class="n">save_interim_restart_files</span><span class="p">,</span>
    <span class="n">archive</span><span class="p">,</span>
    <span class="n">archive_entry</span><span class="p">,</span>
    <span class="n">archive_restdir</span><span class="p">,</span>
    <span class="n">datename</span><span class="p">,</span>
    <span class="n">datename_is_last</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>

    <span class="k">if</span> <span class="n">datename_is_last</span><span class="p">:</span>
        <span class="c1"># Copy of all rpointer files for latest restart date</span>
        <span class="n">rpointers</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="s2">&quot;rpointer.*&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">rpointer</span> <span class="ow">in</span> <span class="n">rpointers</span><span class="p">:</span>
            <span class="n">safe_copy</span><span class="p">(</span>
                <span class="n">rpointer</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rpointer</span><span class="p">))</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Generate rpointer file(s) for interim restarts for the one datename and each</span>
        <span class="c1"># possible value of ninst_strings</span>
        <span class="k">if</span> <span class="n">save_interim_restart_files</span><span class="p">:</span>

            <span class="c1"># parse env_archive.xml to determine the rpointer files</span>
            <span class="c1"># and contents for the given archive_entry tag</span>
            <span class="n">rpointer_items</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_rpointer_contents</span><span class="p">(</span><span class="n">archive_entry</span><span class="p">)</span>

            <span class="c1"># loop through the possible rpointer files and contents</span>
            <span class="k">for</span> <span class="n">rpointer_file</span><span class="p">,</span> <span class="n">rpointer_content</span> <span class="ow">in</span> <span class="n">rpointer_items</span><span class="p">:</span>
                <span class="n">temp_rpointer_file</span> <span class="o">=</span> <span class="n">rpointer_file</span>
                <span class="n">temp_rpointer_content</span> <span class="o">=</span> <span class="n">rpointer_content</span>

                <span class="c1"># put in a temporary setting for ninst_strings if they are empty</span>
                <span class="c1"># in order to have just one loop over ninst_strings below</span>
                <span class="k">if</span> <span class="n">rpointer_content</span> <span class="o">!=</span> <span class="s2">&quot;unset&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ninst_strings</span><span class="p">:</span>
                        <span class="n">ninst_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;empty&quot;</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">ninst_string</span> <span class="ow">in</span> <span class="n">ninst_strings</span><span class="p">:</span>
                        <span class="n">rpointer_file</span> <span class="o">=</span> <span class="n">temp_rpointer_file</span>
                        <span class="n">rpointer_content</span> <span class="o">=</span> <span class="n">temp_rpointer_content</span>
                        <span class="k">if</span> <span class="n">ninst_string</span> <span class="o">==</span> <span class="s2">&quot;empty&quot;</span><span class="p">:</span>
                            <span class="n">ninst_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="p">(</span><span class="s2">&quot;$CASE&quot;</span><span class="p">,</span> <span class="n">casename</span><span class="p">),</span>
                            <span class="p">(</span><span class="s2">&quot;$DATENAME&quot;</span><span class="p">,</span> <span class="n">_datetime_str</span><span class="p">(</span><span class="n">datename</span><span class="p">)),</span>
                            <span class="p">(</span><span class="s2">&quot;$MPAS_DATENAME&quot;</span><span class="p">,</span> <span class="n">_datetime_str_mpas</span><span class="p">(</span><span class="n">datename</span><span class="p">)),</span>
                            <span class="p">(</span><span class="s2">&quot;$NINST_STRING&quot;</span><span class="p">,</span> <span class="n">ninst_string</span><span class="p">),</span>
                        <span class="p">]:</span>
                            <span class="n">rpointer_file</span> <span class="o">=</span> <span class="n">rpointer_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="n">rpointer_content</span> <span class="o">=</span> <span class="n">rpointer_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

                        <span class="c1"># write out the respective files with the correct contents</span>
                        <span class="n">rpointer_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">,</span> <span class="n">rpointer_file</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;writing rpointer_file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rpointer_file</span><span class="p">))</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rpointer_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">rpointer_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;rpointer_content unset, not creating rpointer file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">rpointer_file</span>
                        <span class="p">)</span>
                    <span class="p">)</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_archive_log_files</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="n">rundir</span><span class="p">,</span> <span class="n">archive_incomplete</span><span class="p">,</span> <span class="n">archive_file_fn</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find all completed log files, or all log files if archive_incomplete is True, and archive them.</span>
<span class="sd">    Each log file is required to have &quot;.log.&quot; in its name, and completed ones will end with &quot;.gz&quot;</span>
<span class="sd">    Not doc-testable due to file system dependence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">archive_logdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_logdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">archive_logdir</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created directory </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">archive_logdir</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">archive_incomplete</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">log_search</span> <span class="o">=</span> <span class="s2">&quot;*.log.*.gz&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_search</span> <span class="o">=</span> <span class="s2">&quot;*.log.*&quot;</span>

    <span class="n">logfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log_search</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">logfile</span> <span class="ow">in</span> <span class="n">logfiles</span><span class="p">:</span>
        <span class="n">srcfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
        <span class="n">destfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">archive_logdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_get_archive_fn_desc</span><span class="p">(</span><span class="n">archive_file_fn</span><span class="p">),</span> <span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">archive_file_fn</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_archive_history_files</span><span class="p">(</span>
    <span class="n">archive</span><span class="p">,</span>
    <span class="n">compclass</span><span class="p">,</span>
    <span class="n">compname</span><span class="p">,</span>
    <span class="n">histfiles_savein_rundir</span><span class="p">,</span>
    <span class="n">last_date</span><span class="p">,</span>
    <span class="n">archive_file_fn</span><span class="p">,</span>
    <span class="n">dout_s_root</span><span class="p">,</span>
    <span class="n">casename</span><span class="p">,</span>
    <span class="n">rundir</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    perform short term archiving on history files in rundir</span>

<span class="sd">    Not doc-testable due to case and file system dependence</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># determine history archive directory (create if it does not exist)</span>

    <span class="n">archive_histdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="n">compclass</span><span class="p">,</span> <span class="s2">&quot;hist&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_histdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">archive_histdir</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">archive_histdir</span><span class="p">))</span>
    <span class="c1"># the compname is drv but the files are named cpl</span>
    <span class="k">if</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;drv&quot;</span><span class="p">:</span>
        <span class="n">compname</span> <span class="o">=</span> <span class="s2">&quot;cpl&quot;</span>

    <span class="k">if</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;nemo&quot;</span><span class="p">:</span>
        <span class="n">archive_rblddir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="n">compclass</span><span class="p">,</span> <span class="s2">&quot;rebuild&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_rblddir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">archive_rblddir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">archive_rblddir</span><span class="p">))</span>

        <span class="n">sfxrbld</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;mesh_mask_&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;[0-9]*&quot;</span>
        <span class="n">pfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">sfxrbld</span><span class="p">)</span>
        <span class="n">rbldfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span> <span class="k">if</span> <span class="n">pfile</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;rbldfiles = </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rbldfiles</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">rbldfiles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rbldfile</span> <span class="ow">in</span> <span class="n">rbldfiles</span><span class="p">:</span>
                <span class="n">srcfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">rbldfile</span><span class="p">)</span>
                <span class="n">destfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">archive_rblddir</span><span class="p">,</span> <span class="n">rbldfile</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">_get_archive_fn_desc</span><span class="p">(</span><span class="n">archive_file_fn</span><span class="p">),</span> <span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">archive_file_fn</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>

        <span class="n">sfxhst</span> <span class="o">=</span> <span class="n">casename</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;_[0-9][mdy]_&quot;</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;[0-9]*&quot;</span>
        <span class="n">pfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">sfxhst</span><span class="p">)</span>
        <span class="n">hstfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span> <span class="k">if</span> <span class="n">pfile</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;hstfiles = </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hstfiles</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">hstfiles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hstfile</span> <span class="ow">in</span> <span class="n">hstfiles</span><span class="p">:</span>
                <span class="n">srcfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">hstfile</span><span class="p">)</span>
                <span class="n">destfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">archive_histdir</span><span class="p">,</span> <span class="n">hstfile</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">_get_archive_fn_desc</span><span class="p">(</span><span class="n">archive_file_fn</span><span class="p">),</span> <span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">archive_file_fn</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>

    <span class="c1"># determine ninst and ninst_string</span>

    <span class="c1"># archive history files - the only history files that kept in the</span>
    <span class="c1"># run directory are those that are needed for restarts</span>
    <span class="n">histfiles</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_all_hist_files</span><span class="p">(</span><span class="n">casename</span><span class="p">,</span> <span class="n">compname</span><span class="p">,</span> <span class="n">rundir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">histfiles</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">histfile</span> <span class="ow">in</span> <span class="n">histfiles</span><span class="p">:</span>
            <span class="n">file_date</span> <span class="o">=</span> <span class="n">get_file_date</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">histfile</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">last_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">file_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">file_date</span> <span class="o">&lt;=</span> <span class="n">last_date</span><span class="p">:</span>
                <span class="n">srcfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">histfile</span><span class="p">)</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">srcfile</span><span class="p">),</span>
                    <span class="s2">&quot;history file </span><span class="si">{}</span><span class="s2"> does not exist &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcfile</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">destfile</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">archive_histdir</span><span class="p">,</span> <span class="n">histfile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">histfile</span> <span class="ow">in</span> <span class="n">histfiles_savein_rundir</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;copying </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">))</span>
                    <span class="n">safe_copy</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">_get_archive_fn_desc</span><span class="p">(</span><span class="n">archive_file_fn</span><span class="p">),</span> <span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">archive_file_fn</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>


<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="get_histfiles_for_restarts">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.get_histfiles_for_restarts">[docs]</a>
<span class="k">def</span> <span class="nf">get_histfiles_for_restarts</span><span class="p">(</span>
    <span class="n">rundir</span><span class="p">,</span> <span class="n">archive</span><span class="p">,</span> <span class="n">archive_entry</span><span class="p">,</span> <span class="n">restfile</span><span class="p">,</span> <span class="n">testonly</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    query restart files to determine history files that are needed for restarts</span>

<span class="sd">    Not doc-testable due to filesystem dependence</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make certain histfiles is a set so we don&#39;t repeat</span>
    <span class="n">histfiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">rest_hist_varname</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_entry_value</span><span class="p">(</span><span class="s2">&quot;rest_history_varname&quot;</span><span class="p">,</span> <span class="n">archive_entry</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rest_hist_varname</span> <span class="o">!=</span> <span class="s2">&quot;unset&quot;</span><span class="p">:</span>
        <span class="n">ncdump</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;ncdump&quot;</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">ncdump</span><span class="p">,</span> <span class="s2">&quot;ncdump not found in path&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> -v </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ncdump</span><span class="p">,</span> <span class="n">rest_hist_varname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">restfile</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">testonly</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> =&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rest_hist_varname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot; WARNING: </span><span class="si">{}</span><span class="s2"> failed rc=</span><span class="si">{:d}</span><span class="se">\n</span><span class="s2">    out=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">    err=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">cmd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">error</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; get_histfiles_for_restarts: </span><span class="se">\n</span><span class="s2">    out=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>

        <span class="n">searchname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> =&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rest_hist_varname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">searchname</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">searchname</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="c1"># the following match has an option of having any number of &#39;.&#39;s and &#39;/&#39;s</span>
                <span class="c1"># at the beginning of the history filename</span>
                <span class="n">matchobj</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">\S+\s*</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matchobj</span><span class="p">:</span>
                    <span class="n">histfile</span> <span class="o">=</span> <span class="n">matchobj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot; &#39;</span><span class="p">)</span>
                    <span class="n">histfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">histfile</span><span class="p">)</span>
                    <span class="c1"># append histfile to the list ONLY if it exists in rundir before the archiving</span>
                    <span class="k">if</span> <span class="n">histfile</span> <span class="ow">in</span> <span class="n">histfiles</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;WARNING, tried to add a duplicate file to histfiles&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">histfile</span><span class="p">)):</span>
                        <span class="n">histfiles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">histfile</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot; get_histfiles_for_restarts: histfile </span><span class="si">{}</span><span class="s2"> does not exist &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">histfile</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
    <span class="k">return</span> <span class="n">histfiles</span></div>



<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_archive_restarts_date</span><span class="p">(</span>
    <span class="n">case</span><span class="p">,</span>
    <span class="n">casename</span><span class="p">,</span>
    <span class="n">rundir</span><span class="p">,</span>
    <span class="n">archive</span><span class="p">,</span>
    <span class="n">datename</span><span class="p">,</span>
    <span class="n">datename_is_last</span><span class="p">,</span>
    <span class="n">last_date</span><span class="p">,</span>
    <span class="n">archive_restdir</span><span class="p">,</span>
    <span class="n">archive_file_fn</span><span class="p">,</span>
    <span class="n">components</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">link_to_last_restart_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">testonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Archive restart files for a single date</span>

<span class="sd">    Returns a dictionary of histfiles that need saving in the run</span>
<span class="sd">    directory, indexed by compname</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------------------------------------&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Archiving restarts for date </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datename</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;last date </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_date</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;date is last? </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datename_is_last</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;components are </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">components</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-------------------------------------------&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;last date: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">last_date</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">components</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_compset_components</span><span class="p">()</span>
        <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;drv&quot;</span><span class="p">)</span>
        <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dart&quot;</span><span class="p">)</span>

    <span class="n">histfiles_savein_rundir_by_compname</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">archive_entry</span><span class="p">,</span> <span class="n">compname</span><span class="p">,</span> <span class="n">compclass</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_get_component_archive_entries</span><span class="p">(</span>
        <span class="n">components</span><span class="p">,</span> <span class="n">archive</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">compclass</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Archiving restarts for </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compname</span><span class="p">,</span> <span class="n">compclass</span><span class="p">))</span>

            <span class="c1"># archive restarts</span>
            <span class="n">histfiles_savein_rundir</span> <span class="o">=</span> <span class="n">_archive_restarts_date_comp</span><span class="p">(</span>
                <span class="n">case</span><span class="p">,</span>
                <span class="n">casename</span><span class="p">,</span>
                <span class="n">rundir</span><span class="p">,</span>
                <span class="n">archive</span><span class="p">,</span>
                <span class="n">archive_entry</span><span class="p">,</span>
                <span class="n">compclass</span><span class="p">,</span>
                <span class="n">compname</span><span class="p">,</span>
                <span class="n">datename</span><span class="p">,</span>
                <span class="n">datename_is_last</span><span class="p">,</span>
                <span class="n">last_date</span><span class="p">,</span>
                <span class="n">archive_restdir</span><span class="p">,</span>
                <span class="n">archive_file_fn</span><span class="p">,</span>
                <span class="n">link_to_last_restart_files</span><span class="o">=</span><span class="n">link_to_last_restart_files</span><span class="p">,</span>
                <span class="n">testonly</span><span class="o">=</span><span class="n">testonly</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">histfiles_savein_rundir_by_compname</span><span class="p">[</span><span class="n">compname</span><span class="p">]</span> <span class="o">=</span> <span class="n">histfiles_savein_rundir</span>

    <span class="k">return</span> <span class="n">histfiles_savein_rundir_by_compname</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_archive_restarts_date_comp</span><span class="p">(</span>
    <span class="n">case</span><span class="p">,</span>
    <span class="n">casename</span><span class="p">,</span>
    <span class="n">rundir</span><span class="p">,</span>
    <span class="n">archive</span><span class="p">,</span>
    <span class="n">archive_entry</span><span class="p">,</span>
    <span class="n">compclass</span><span class="p">,</span>
    <span class="n">compname</span><span class="p">,</span>
    <span class="n">datename</span><span class="p">,</span>
    <span class="n">datename_is_last</span><span class="p">,</span>
    <span class="n">last_date</span><span class="p">,</span>
    <span class="n">archive_restdir</span><span class="p">,</span>
    <span class="n">archive_file_fn</span><span class="p">,</span>
    <span class="n">link_to_last_restart_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">testonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Archive restart files for a single date and single component</span>

<span class="sd">    If link_to_last_restart_files is True, then make a symlink to the</span>
<span class="sd">    last set of restart files (i.e., the set with datename_is_last</span>
<span class="sd">    True); if False (the default), copy them. (This has no effect on the</span>
<span class="sd">    history files that are associated with these restart files.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datename_str</span> <span class="o">=</span> <span class="n">_datetime_str</span><span class="p">(</span><span class="n">datename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">datename_is_last</span> <span class="ow">or</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DOUT_S_SAVE_INTERIM_RESTART_FILES&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">)</span>

    <span class="c1"># archive the rpointer file(s) for this datename and all possible ninst_strings</span>
    <span class="n">_archive_rpointer_files</span><span class="p">(</span>
        <span class="n">casename</span><span class="p">,</span>
        <span class="n">_get_ninst_info</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">compclass</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">rundir</span><span class="p">,</span>
        <span class="k">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DOUT_S_SAVE_INTERIM_RESTART_FILES&quot;</span><span class="p">),</span>
        <span class="n">archive</span><span class="p">,</span>
        <span class="n">archive_entry</span><span class="p">,</span>
        <span class="n">archive_restdir</span><span class="p">,</span>
        <span class="n">datename</span><span class="p">,</span>
        <span class="n">datename_is_last</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># move all but latest restart files into the archive restart directory</span>
    <span class="c1"># copy latest restart files to archive restart directory</span>
    <span class="n">histfiles_savein_rundir</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># determine function to use for last set of restart files</span>
    <span class="k">if</span> <span class="n">link_to_last_restart_files</span><span class="p">:</span>
        <span class="n">last_restart_file_fn</span> <span class="o">=</span> <span class="n">symlink_force</span>
        <span class="n">last_restart_file_fn_msg</span> <span class="o">=</span> <span class="s2">&quot;linking&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">last_restart_file_fn</span> <span class="o">=</span> <span class="n">safe_copy</span>
        <span class="n">last_restart_file_fn_msg</span> <span class="o">=</span> <span class="s2">&quot;copying&quot;</span>

    <span class="c1"># the compname is drv but the files are named cpl</span>
    <span class="k">if</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;drv&quot;</span><span class="p">:</span>
        <span class="n">compname</span> <span class="o">=</span> <span class="s2">&quot;cpl&quot;</span>
    <span class="k">if</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;cice5&quot;</span><span class="p">:</span>
        <span class="n">compname</span> <span class="o">=</span> <span class="s2">&quot;cice&quot;</span>
    <span class="k">if</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;ww3dev&quot;</span><span class="p">:</span>
        <span class="n">compname</span> <span class="o">=</span> <span class="s2">&quot;ww3&quot;</span>

    <span class="c1"># get file_extension suffixes</span>
    <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_rest_file_extensions</span><span class="p">(</span><span class="n">archive_entry</span><span class="p">):</span>
        <span class="c1">#        logger.debug(&quot;suffix is {} ninst {}&quot;.format(suffix, ninst))</span>
        <span class="n">restfiles</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mpas&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;mali&quot;</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">casename</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\.&quot;</span>
                <span class="o">+</span> <span class="n">compname</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\.&quot;</span>
                <span class="o">+</span> <span class="n">suffix</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\.&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datename_str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">pfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="n">restfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span> <span class="k">if</span> <span class="n">pfile</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;nemo&quot;</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;_*_&quot;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;[0-9]*&quot;</span>
            <span class="n">pfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="n">restfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span> <span class="k">if</span> <span class="n">pfile</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^</span><span class="si">{}</span><span class="s2">\.</span><span class="si">{}</span><span class="s2">[\d_]*\.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">casename</span><span class="p">,</span> <span class="n">compname</span><span class="p">)</span>
            <span class="n">pfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span> <span class="k">if</span> <span class="n">pfile</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;_?&quot;</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\d*&quot;</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\.&quot;</span>
                <span class="o">+</span> <span class="n">suffix</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\.&quot;</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;[^\.]*&quot;</span>
                <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\.?&quot;</span>
                <span class="o">+</span> <span class="n">datename_str</span>
            <span class="p">)</span>
            <span class="n">pfile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="n">restfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">pfile</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pattern is </span><span class="si">{}</span><span class="s2"> restfiles </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">restfiles</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">rfile</span> <span class="ow">in</span> <span class="n">restfiles</span><span class="p">:</span>
            <span class="n">rfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>

            <span class="n">file_date</span> <span class="o">=</span> <span class="n">get_file_date</span><span class="p">(</span><span class="n">rfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">file_date</span> <span class="o">&gt;</span> <span class="n">last_date</span><span class="p">:</span>
                <span class="c1"># Skip this file</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">)</span>

            <span class="c1"># obtain array of history files for restarts</span>
            <span class="c1"># need to do this before archiving restart files</span>
            <span class="n">histfiles_for_restart</span> <span class="o">=</span> <span class="n">get_histfiles_for_restarts</span><span class="p">(</span>
                <span class="n">rundir</span><span class="p">,</span> <span class="n">archive</span><span class="p">,</span> <span class="n">archive_entry</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">testonly</span><span class="o">=</span><span class="n">testonly</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">datename_is_last</span> <span class="ow">and</span> <span class="n">histfiles_for_restart</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">histfile</span> <span class="ow">in</span> <span class="n">histfiles_for_restart</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">histfile</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">histfiles_savein_rundir</span><span class="p">:</span>
                        <span class="n">histfiles_savein_rundir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">histfile</span><span class="p">)</span>

            <span class="c1"># archive restart files and all history files that are needed for restart</span>
            <span class="c1"># Note that the latest file should be copied and not moved</span>
            <span class="k">if</span> <span class="n">datename_is_last</span><span class="p">:</span>
                <span class="n">srcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">rfile</span><span class="p">)</span>
                <span class="n">destfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">,</span> <span class="n">rfile</span><span class="p">)</span>
                <span class="n">last_restart_file_fn</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> file </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">last_restart_file_fn_msg</span><span class="p">,</span> <span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">histfile</span> <span class="ow">in</span> <span class="n">histfiles_for_restart</span><span class="p">:</span>
                    <span class="n">srcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">histfile</span><span class="p">)</span>
                    <span class="n">destfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">,</span> <span class="n">histfile</span><span class="p">)</span>
                    <span class="n">expect</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">srcfile</span><span class="p">),</span>
                        <span class="s2">&quot;history restart file </span><span class="si">{}</span><span class="s2"> for last date does not exist &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">srcfile</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">))</span>
                    <span class="n">safe_copy</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;datename_is_last + histfiles_for_restart copying </span><span class="se">\n</span><span class="s2">  </span><span class="si">{}</span><span class="s2"> to </span><span class="se">\n</span><span class="s2">  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Only archive intermediate restarts if requested - otherwise remove them</span>
                <span class="k">if</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DOUT_S_SAVE_INTERIM_RESTART_FILES&quot;</span><span class="p">):</span>
                    <span class="n">srcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">rfile</span><span class="p">)</span>
                    <span class="n">destfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">,</span> <span class="n">rfile</span><span class="p">)</span>
                    <span class="n">expect</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">srcfile</span><span class="p">),</span>
                        <span class="s2">&quot;restart file </span><span class="si">{}</span><span class="s2"> does not exist &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcfile</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> file </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">_get_archive_fn_desc</span><span class="p">(</span><span class="n">archive_file_fn</span><span class="p">),</span> <span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">archive_file_fn</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>

                    <span class="c1"># need to copy the history files needed for interim restarts - since</span>
                    <span class="c1"># have not archived all of the history files yet</span>
                    <span class="k">for</span> <span class="n">histfile</span> <span class="ow">in</span> <span class="n">histfiles_for_restart</span><span class="p">:</span>
                        <span class="n">srcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">histfile</span><span class="p">)</span>
                        <span class="n">destfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_restdir</span><span class="p">,</span> <span class="n">histfile</span><span class="p">)</span>
                        <span class="n">expect</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">srcfile</span><span class="p">),</span>
                            <span class="s2">&quot;hist file </span><span class="si">{}</span><span class="s2"> does not exist &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcfile</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;copying </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">))</span>
                        <span class="n">safe_copy</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;nemo&quot;</span><span class="p">:</span>
                        <span class="n">flist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">rundir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">casename</span> <span class="o">+</span> <span class="s2">&quot;_*_restart*.nc&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;nemo restart file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flist</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">flist0</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                                <span class="n">rundir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">casename</span> <span class="o">+</span> <span class="s2">&quot;_*_restart_0000.nc&quot;</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flist0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">rstfl01</span> <span class="o">=</span> <span class="n">flist0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">rstfl01spl</span> <span class="o">=</span> <span class="n">rstfl01</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;splitted name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rstfl01spl</span><span class="p">))</span>
                                <span class="n">rstfl01nm</span> <span class="o">=</span> <span class="n">rstfl01spl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">rstfl01nmspl</span> <span class="o">=</span> <span class="n">rstfl01nm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="s2">&quot;splitted name step2 </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rstfl01nmspl</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">rsttm01</span> <span class="o">=</span> <span class="n">rstfl01nmspl</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

                                <span class="n">rstfl02</span> <span class="o">=</span> <span class="n">flist0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">rstfl02spl</span> <span class="o">=</span> <span class="n">rstfl02</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;splitted name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rstfl02spl</span><span class="p">))</span>
                                <span class="n">rstfl02nm</span> <span class="o">=</span> <span class="n">rstfl02spl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">rstfl02nmspl</span> <span class="o">=</span> <span class="n">rstfl02nm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="s2">&quot;splitted name step2 </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rstfl02nmspl</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">rsttm02</span> <span class="o">=</span> <span class="n">rstfl02nmspl</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">rsttm01</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">rsttm02</span><span class="p">):</span>
                                    <span class="n">restlist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                                        <span class="n">rundir</span>
                                        <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                                        <span class="o">+</span> <span class="n">casename</span>
                                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                                        <span class="o">+</span> <span class="n">rsttm02</span>
                                        <span class="o">+</span> <span class="s2">&quot;_restart_*.nc&quot;</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">restlist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                                        <span class="n">rundir</span>
                                        <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                                        <span class="o">+</span> <span class="n">casename</span>
                                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                                        <span class="o">+</span> <span class="n">rsttm01</span>
                                        <span class="o">+</span> <span class="s2">&quot;_restart_*.nc&quot;</span>
                                    <span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;nemo restart list </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restlist</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">restlist</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">_restfile</span> <span class="ow">in</span> <span class="n">restlist</span><span class="p">:</span>
                                        <span class="n">srcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">_restfile</span><span class="p">)</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                            <span class="s2">&quot;removing interim restart file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">srcfile</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">srcfile</span><span class="p">):</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">srcfile</span><span class="p">)</span>
                                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                                    <span class="s2">&quot;unable to remove interim restart file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                        <span class="n">srcfile</span>
                                                    <span class="p">)</span>
                                                <span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                                <span class="s2">&quot;interim restart file </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">srcfile</span>
                                                <span class="p">)</span>
                                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">flist0</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                                <span class="n">rundir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">casename</span> <span class="o">+</span> <span class="s2">&quot;_*_restart.nc&quot;</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flist0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">rstfl01</span> <span class="o">=</span> <span class="n">flist0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">rstfl01spl</span> <span class="o">=</span> <span class="n">rstfl01</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;splitted name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rstfl01spl</span><span class="p">))</span>
                                <span class="n">rstfl01nm</span> <span class="o">=</span> <span class="n">rstfl01spl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">rstfl01nmspl</span> <span class="o">=</span> <span class="n">rstfl01nm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="s2">&quot;splitted name step2 </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rstfl01nmspl</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">rsttm01</span> <span class="o">=</span> <span class="n">rstfl01nmspl</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

                                <span class="n">rstfl02</span> <span class="o">=</span> <span class="n">flist0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">rstfl02spl</span> <span class="o">=</span> <span class="n">rstfl02</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;splitted name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rstfl02spl</span><span class="p">))</span>
                                <span class="n">rstfl02nm</span> <span class="o">=</span> <span class="n">rstfl02spl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">rstfl02nmspl</span> <span class="o">=</span> <span class="n">rstfl02nm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="s2">&quot;splitted name step2 </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rstfl02nmspl</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="n">rsttm02</span> <span class="o">=</span> <span class="n">rstfl02nmspl</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">rsttm01</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">rsttm02</span><span class="p">):</span>
                                    <span class="n">restlist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                                        <span class="n">rundir</span>
                                        <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                                        <span class="o">+</span> <span class="n">casename</span>
                                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                                        <span class="o">+</span> <span class="n">rsttm02</span>
                                        <span class="o">+</span> <span class="s2">&quot;_restart_*.nc&quot;</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">restlist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                                        <span class="n">rundir</span>
                                        <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
                                        <span class="o">+</span> <span class="n">casename</span>
                                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                                        <span class="o">+</span> <span class="n">rsttm01</span>
                                        <span class="o">+</span> <span class="s2">&quot;_restart_*.nc&quot;</span>
                                    <span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;nemo restart list </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restlist</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">restlist</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">_rfile</span> <span class="ow">in</span> <span class="n">restlist</span><span class="p">:</span>
                                        <span class="n">srcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">_rfile</span><span class="p">)</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                            <span class="s2">&quot;removing interim restart file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">srcfile</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">srcfile</span><span class="p">):</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">srcfile</span><span class="p">)</span>
                                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                                    <span class="s2">&quot;unable to remove interim restart file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                        <span class="n">srcfile</span>
                                                    <span class="p">)</span>
                                                <span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                                <span class="s2">&quot;interim restart file </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">srcfile</span>
                                                <span class="p">)</span>
                                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;unable to find NEMO restart file in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">srcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">rfile</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;removing interim restart file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcfile</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">srcfile</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">srcfile</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;unable to remove interim restart file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">srcfile</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;interim restart file </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcfile</span><span class="p">)</span>
                            <span class="p">)</span>

    <span class="k">return</span> <span class="n">histfiles_savein_rundir</span>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_archive_process</span><span class="p">(</span>
    <span class="n">case</span><span class="p">,</span>
    <span class="n">archive</span><span class="p">,</span>
    <span class="n">last_date</span><span class="p">,</span>
    <span class="n">archive_incomplete_logs</span><span class="p">,</span>
    <span class="n">copy_only</span><span class="p">,</span>
    <span class="n">components</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dout_s_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">casename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rundir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">testonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse config_archive.xml and perform short term archiving</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;In archive_process...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dout_s_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dout_s_root</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DOUT_S_ROOT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rundir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">casename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">casename</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">components</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_compset_components</span><span class="p">()</span>
        <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;drv&quot;</span><span class="p">)</span>
        <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dart&quot;</span><span class="p">)</span>

    <span class="n">archive_file_fn</span> <span class="o">=</span> <span class="n">_get_archive_file_fn</span><span class="p">(</span><span class="n">copy_only</span><span class="p">)</span>

    <span class="c1"># archive log files</span>
    <span class="n">_archive_log_files</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="n">rundir</span><span class="p">,</span> <span class="n">archive_incomplete_logs</span><span class="p">,</span> <span class="n">archive_file_fn</span><span class="p">)</span>

    <span class="c1"># archive restarts and all necessary associated files (e.g. rpointer files)</span>
    <span class="n">datenames</span> <span class="o">=</span> <span class="n">_get_datenames</span><span class="p">(</span><span class="n">casename</span><span class="p">,</span> <span class="n">rundir</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;datenames </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datenames</span><span class="p">))</span>
    <span class="n">histfiles_savein_rundir_by_compname</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">datename</span> <span class="ow">in</span> <span class="n">datenames</span><span class="p">:</span>
        <span class="n">datename_is_last</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">datename</span> <span class="o">==</span> <span class="n">datenames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">datename_is_last</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;datename </span><span class="si">{}</span><span class="s2"> last_date </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datename</span><span class="p">,</span> <span class="n">last_date</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">last_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">datename</span> <span class="o">&lt;=</span> <span class="n">last_date</span><span class="p">:</span>
            <span class="n">archive_restdir</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="n">_datetime_str</span><span class="p">(</span><span class="n">datename</span><span class="p">))</span>

            <span class="n">histfiles_savein_rundir_by_compname_this_date</span> <span class="o">=</span> <span class="n">_archive_restarts_date</span><span class="p">(</span>
                <span class="n">case</span><span class="p">,</span>
                <span class="n">casename</span><span class="p">,</span>
                <span class="n">rundir</span><span class="p">,</span>
                <span class="n">archive</span><span class="p">,</span>
                <span class="n">datename</span><span class="p">,</span>
                <span class="n">datename_is_last</span><span class="p">,</span>
                <span class="n">last_date</span><span class="p">,</span>
                <span class="n">archive_restdir</span><span class="p">,</span>
                <span class="n">archive_file_fn</span><span class="p">,</span>
                <span class="n">components</span><span class="p">,</span>
                <span class="n">testonly</span><span class="o">=</span><span class="n">testonly</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">datename_is_last</span><span class="p">:</span>
                <span class="n">histfiles_savein_rundir_by_compname</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">histfiles_savein_rundir_by_compname_this_date</span>
                <span class="p">)</span>

    <span class="c1"># archive history files</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">compname</span><span class="p">,</span> <span class="n">compclass</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_get_component_archive_entries</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">archive</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">compclass</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Archiving history files for </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compname</span><span class="p">,</span> <span class="n">compclass</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">histfiles_savein_rundir</span> <span class="o">=</span> <span class="n">histfiles_savein_rundir_by_compname</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">compname</span><span class="p">,</span> <span class="p">[]</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;_archive_process: histfiles_savein_rundir </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">histfiles_savein_rundir</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">_archive_history_files</span><span class="p">(</span>
                <span class="n">archive</span><span class="p">,</span>
                <span class="n">compclass</span><span class="p">,</span>
                <span class="n">compname</span><span class="p">,</span>
                <span class="n">histfiles_savein_rundir</span><span class="p">,</span>
                <span class="n">last_date</span><span class="p">,</span>
                <span class="n">archive_file_fn</span><span class="p">,</span>
                <span class="n">dout_s_root</span><span class="p">,</span>
                <span class="n">casename</span><span class="p">,</span>
                <span class="n">rundir</span><span class="p">,</span>
            <span class="p">)</span>


<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="restore_from_archive">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.restore_from_archive">[docs]</a>
<span class="k">def</span> <span class="nf">restore_from_archive</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">rest_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dout_s_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rundir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take archived restart files and load them into current case.  Use rest_dir if provided otherwise use most recent</span>
<span class="sd">    restore_from_archive is a member of Class Case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dout_s_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dout_s_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DOUT_S_ROOT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rundir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rest_dir</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">rest_dir</span><span class="p">):</span>
            <span class="n">rest_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="n">rest_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rest_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rest_root</span><span class="p">):</span>
            <span class="n">rest_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">rest_root</span><span class="p">,</span> <span class="n">ls_sorted_by_mtime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">rest_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">test</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;No rest_dir found for test - is this expected? DOUT_S_ROOT=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">dout_s_root</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rest_dir</span><span class="p">),</span> <span class="s2">&quot;ERROR: No directory </span><span class="si">{}</span><span class="s2"> found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rest_dir</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring restart from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rest_dir</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rest_dir</span><span class="p">)):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring </span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">rest_dir</span><span class="p">,</span> <span class="n">rundir</span><span class="p">))</span>

        <span class="n">safe_copy</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">rundir</span><span class="p">)</span></div>



<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="archive_last_restarts">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.archive_last_restarts">[docs]</a>
<span class="k">def</span> <span class="nf">archive_last_restarts</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">archive_restdir</span><span class="p">,</span> <span class="n">rundir</span><span class="p">,</span> <span class="n">last_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">link_to_restart_files</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function for archiving just the last set of restart</span>
<span class="sd">    files to a given directory. This also saves files attached to the</span>
<span class="sd">    restart set, such as rpointer files and necessary history</span>
<span class="sd">    files. However, it does not save other files that are typically</span>
<span class="sd">    archived (e.g., history files, log files).</span>

<span class="sd">    Files are copied to the directory given by archive_restdir.</span>

<span class="sd">    If link_to_restart_files is True, then symlinks rather than copies</span>
<span class="sd">    are done for the restart files. (This has no effect on the history</span>
<span class="sd">    files that are associated with these restart files.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;archive&quot;</span><span class="p">)</span>
    <span class="n">casename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
    <span class="n">datenames</span> <span class="o">=</span> <span class="n">_get_datenames</span><span class="p">(</span><span class="n">casename</span><span class="p">,</span> <span class="n">rundir</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datenames</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;No restart dates found&quot;</span><span class="p">)</span>
    <span class="n">last_datename</span> <span class="o">=</span> <span class="n">datenames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Not currently used for anything if we&#39;re only archiving the last</span>
    <span class="c1"># set of restart files, but needed to satisfy the following interface</span>
    <span class="n">archive_file_fn</span> <span class="o">=</span> <span class="n">_get_archive_file_fn</span><span class="p">(</span><span class="n">copy_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">_archive_restarts_date</span><span class="p">(</span>
        <span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">casename</span><span class="o">=</span><span class="n">casename</span><span class="p">,</span>
        <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span>
        <span class="n">archive</span><span class="o">=</span><span class="n">archive</span><span class="p">,</span>
        <span class="n">datename</span><span class="o">=</span><span class="n">last_datename</span><span class="p">,</span>
        <span class="n">datename_is_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">last_date</span><span class="o">=</span><span class="n">last_date</span><span class="p">,</span>
        <span class="n">archive_restdir</span><span class="o">=</span><span class="n">archive_restdir</span><span class="p">,</span>
        <span class="n">archive_file_fn</span><span class="o">=</span><span class="n">archive_file_fn</span><span class="p">,</span>
        <span class="n">link_to_last_restart_files</span><span class="o">=</span><span class="n">link_to_restart_files</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="case_st_archive">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.case_st_archive">[docs]</a>
<span class="k">def</span> <span class="nf">case_st_archive</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">last_date_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">archive_incomplete_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">copy_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resubmit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create archive object and perform short term archiving</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;resubmit </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resubmit</span><span class="p">))</span>
    <span class="n">caseroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_env</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="s2">&quot;case.st_archive&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">last_date_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_date</span> <span class="o">=</span> <span class="n">get_file_date</span><span class="p">(</span><span class="n">last_date_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Could not parse the last date to archive&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">last_date</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">dout_s_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DOUT_S_ROOT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dout_s_root</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dout_s_root</span> <span class="o">==</span> <span class="s2">&quot;UNSET&quot;</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;XML variable DOUT_S_ROOT is required for short-term achiver&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dout_s_root</span><span class="p">)</span>

    <span class="n">dout_s_save_interim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;DOUT_S_SAVE_INTERIM_RESTART_FILES&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dout_s_save_interim</span> <span class="o">==</span> <span class="s2">&quot;FALSE&quot;</span> <span class="ow">or</span> <span class="n">dout_s_save_interim</span> <span class="o">==</span> <span class="s2">&quot;UNSET&quot;</span><span class="p">:</span>
        <span class="n">rest_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;REST_N&quot;</span><span class="p">)</span>
        <span class="n">stop_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_N&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rest_n</span> <span class="o">&lt;</span> <span class="n">stop_n</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Restart files from end of run will be saved&quot;</span>
                <span class="s2">&quot;interim restart files will be deleted&quot;</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;st_archive starting&quot;</span><span class="p">)</span>

    <span class="n">is_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BATCH_SYSTEM&quot;</span><span class="p">)</span>
    <span class="n">msg_func</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">is_batch</span><span class="p">:</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">batch_jobid</span><span class="p">()</span>
        <span class="n">msg_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">jobid</span> <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="n">archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;archive&quot;</span><span class="p">)</span>
    <span class="n">functor</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_archive_process</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">archive</span><span class="p">,</span> <span class="n">last_date</span><span class="p">,</span> <span class="n">archive_incomplete_logs</span><span class="p">,</span> <span class="n">copy_only</span>
    <span class="p">)</span>
    <span class="n">run_and_log_case_status</span><span class="p">(</span>
        <span class="n">functor</span><span class="p">,</span>
        <span class="s2">&quot;st_archive&quot;</span><span class="p">,</span>
        <span class="n">custom_starting_msg_functor</span><span class="o">=</span><span class="n">msg_func</span><span class="p">,</span>
        <span class="n">custom_success_msg_functor</span><span class="o">=</span><span class="n">msg_func</span><span class="p">,</span>
        <span class="n">caseroot</span><span class="o">=</span><span class="n">caseroot</span><span class="p">,</span>
        <span class="n">is_batch</span><span class="o">=</span><span class="n">is_batch</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;st_archive completed&quot;</span><span class="p">)</span>

    <span class="c1"># resubmit case if appropriate</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;EXTERNAL_WORKFLOW&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resubmit</span><span class="p">:</span>
        <span class="n">resubmit_cnt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RESUBMIT&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;resubmit_cnt </span><span class="si">{}</span><span class="s2"> resubmit </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resubmit_cnt</span><span class="p">,</span> <span class="n">resubmit</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">resubmit_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;resubmitting from st_archive, resubmit=</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resubmit_cnt</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MACH&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mira&quot;</span><span class="p">:</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;.original_host&quot;</span><span class="p">),</span> <span class="s2">&quot;ERROR alcf host file not found&quot;</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;.original_host&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="n">sshhost</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">run_cmd</span><span class="p">(</span>
                    <span class="s2">&quot;ssh cooleylogin1 ssh </span><span class="si">{}</span><span class="s2"> &#39;</span><span class="si">{case}</span><span class="s2">/case.submit </span><span class="si">{case}</span><span class="s2"> --resubmit&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sshhost</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">caseroot</span>
                    <span class="p">),</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">resubmit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="test_st_archive">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.test_st_archive">[docs]</a>
<span class="k">def</span> <span class="nf">test_st_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testdir</span><span class="o">=</span><span class="s2">&quot;st_archive_test&quot;</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">Files</span><span class="p">()</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
    <span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#    expect(not self.get_value(&quot;MULTI_DRIVER&quot;),&quot;Test not configured for multi-driver cases&quot;)</span>

    <span class="n">config_archive_files</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_all_config_archive_files</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="c1"># create the run directory testdir and populate it with rest_file and hist_file from</span>
    <span class="c1"># config_archive.xml test_file_names</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">testdir</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing existing test directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testdir</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>
    <span class="n">dout_s_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">)</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">()</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_schema</span><span class="p">(</span><span class="s2">&quot;ARCHIVE_SPEC_FILE&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">config_archive_file</span> <span class="ow">in</span> <span class="n">config_archive_files</span><span class="p">:</span>
        <span class="n">archive</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">config_archive_file</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
    <span class="n">comp_archive_specs</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;comp_archive_spec&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">comp_archive_spec</span> <span class="ow">in</span> <span class="n">comp_archive_specs</span><span class="p">:</span>
        <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">comp_archive_spec</span><span class="p">,</span> <span class="s2">&quot;compname&quot;</span><span class="p">))</span>
        <span class="n">test_file_names</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_optional_child</span><span class="p">(</span>
            <span class="s2">&quot;test_file_names&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">comp_archive_spec</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">test_file_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">testdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">file_node</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;tfile&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">test_file_names</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">file_node</span><span class="p">))</span>
                <span class="n">disposition</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_node</span><span class="p">,</span> <span class="s2">&quot;disposition&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Create file </span><span class="si">{}</span><span class="s2"> with disposition </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">disposition</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">disposition</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;testing components: </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">components</span><span class="p">))))</span>
    <span class="n">_archive_process</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">archive</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">components</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">components</span><span class="p">)),</span>
        <span class="n">dout_s_root</span><span class="o">=</span><span class="n">dout_s_root</span><span class="p">,</span>
        <span class="n">casename</span><span class="o">=</span><span class="s2">&quot;casename&quot;</span><span class="p">,</span>
        <span class="n">rundir</span><span class="o">=</span><span class="n">testdir</span><span class="p">,</span>
        <span class="n">testonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_check_disposition</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>

    <span class="c1"># Now test the restore capability</span>
    <span class="n">testdir2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;run2&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">testdir2</span><span class="p">)</span>

    <span class="n">restore_from_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rundir</span><span class="o">=</span><span class="n">testdir2</span><span class="p">,</span> <span class="n">dout_s_root</span><span class="o">=</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">restfiles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="s2">&quot;1976-01-01-00000&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">restfiles</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir2</span><span class="p">,</span> <span class="n">_file</span><span class="p">)),</span>
            <span class="s2">&quot;Expected file </span><span class="si">{}</span><span class="s2"> to be restored from rest dir&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_file</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="test_env_archive">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.test_env_archive">[docs]</a>
<span class="k">def</span> <span class="nf">test_env_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testdir</span><span class="o">=</span><span class="s2">&quot;env_archive_test&quot;</span><span class="p">):</span>
    <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">)</span>
    <span class="n">comps_in_case</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># create the run directory testdir and populate it with rest_file and hist_file from</span>
    <span class="c1"># config_archive.xml test_file_names</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">testdir</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing existing test directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testdir</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>
    <span class="n">dout_s_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">)</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;archive&quot;</span><span class="p">)</span>
    <span class="n">comp_archive_specs</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">scan_children</span><span class="p">(</span><span class="s2">&quot;comp_archive_spec&quot;</span><span class="p">)</span>

    <span class="c1"># ignore stub and dead components</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
        <span class="n">compname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMP_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="o">+</span> <span class="n">comp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">comp</span> <span class="o">!=</span> <span class="s2">&quot;ESP&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not testing component </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
            <span class="n">components</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">comp</span> <span class="o">==</span> <span class="s2">&quot;ESP&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MODEL&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;e3sm&quot;</span><span class="p">:</span>
            <span class="n">components</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">compname</span> <span class="o">==</span> <span class="s2">&quot;cpl&quot;</span><span class="p">:</span>
                <span class="n">compname</span> <span class="o">=</span> <span class="s2">&quot;drv&quot;</span>
            <span class="n">comps_in_case</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compname</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">comp_archive_spec</span> <span class="ow">in</span> <span class="n">comp_archive_specs</span><span class="p">:</span>
        <span class="n">comp_expected</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">comp_archive_spec</span><span class="p">,</span> <span class="s2">&quot;compname&quot;</span><span class="p">)</span>
        <span class="c1"># Rename ww3 component when case and archive names don&#39;t match,</span>
        <span class="c1"># specific to CESM.</span>
        <span class="k">if</span> <span class="n">comp_expected</span> <span class="o">==</span> <span class="s2">&quot;ww3&quot;</span> <span class="ow">and</span> <span class="s2">&quot;ww&quot;</span> <span class="ow">in</span> <span class="n">comps_in_case</span><span class="p">:</span>
            <span class="n">comp_expected</span> <span class="o">=</span> <span class="s2">&quot;ww&quot;</span>
        <span class="n">comp_class</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">comp_archive_spec</span><span class="p">,</span> <span class="s2">&quot;compclass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">comp_class</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">components</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">comp_class</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Error finding comp_class </span><span class="si">{}</span><span class="s2"> in components&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_class</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">comp_expected</span> <span class="o">==</span> <span class="s2">&quot;cpl&quot;</span><span class="p">:</span>
            <span class="n">comp_expected</span> <span class="o">=</span> <span class="s2">&quot;drv&quot;</span>
        <span class="k">if</span> <span class="n">comp_expected</span> <span class="o">!=</span> <span class="s2">&quot;dart&quot;</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="n">comp_expected</span> <span class="ow">in</span> <span class="n">comps_in_case</span><span class="p">,</span>
                <span class="s2">&quot;env_archive defines component </span><span class="si">{}</span><span class="s2"> not defined in case&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">comp_expected</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="n">test_file_names</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_optional_child</span><span class="p">(</span>
            <span class="s2">&quot;test_file_names&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">comp_archive_spec</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">test_file_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">testdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">file_node</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="s2">&quot;tfile&quot;</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">test_file_names</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="n">archive</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">file_node</span><span class="p">))</span>
                <span class="n">disposition</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_node</span><span class="p">,</span> <span class="s2">&quot;disposition&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Create file </span><span class="si">{}</span><span class="s2"> with disposition </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">disposition</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">disposition</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span>
        <span class="ow">not</span> <span class="n">components</span><span class="p">,</span> <span class="s2">&quot;No archive entry found for components: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;dart&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comps_in_case</span><span class="p">:</span>
        <span class="n">comps_in_case</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dart&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;testing components: </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comps_in_case</span><span class="p">))</span>
    <span class="n">_archive_process</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">archive</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="kc">False</span><span class="p">,</span>
        <span class="n">components</span><span class="o">=</span><span class="n">comps_in_case</span><span class="p">,</span>
        <span class="n">dout_s_root</span><span class="o">=</span><span class="n">dout_s_root</span><span class="p">,</span>
        <span class="n">casename</span><span class="o">=</span><span class="s2">&quot;casename&quot;</span><span class="p">,</span>
        <span class="n">rundir</span><span class="o">=</span><span class="n">testdir</span><span class="p">,</span>
        <span class="n">testonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_check_disposition</span><span class="p">(</span><span class="n">testdir</span><span class="p">)</span>

    <span class="c1"># Now test the restore capability</span>
    <span class="n">testdir2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;run2&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">testdir2</span><span class="p">)</span>
    <span class="n">restfiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">restore_from_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rundir</span><span class="o">=</span><span class="n">testdir2</span><span class="p">,</span> <span class="n">dout_s_root</span><span class="o">=</span><span class="n">dout_s_root</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">)):</span>
        <span class="n">restfiles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="s2">&quot;1976-01-01-00000&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">restfiles</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir2</span><span class="p">,</span> <span class="n">_file</span><span class="p">)),</span>
            <span class="s2">&quot;Expected file </span><span class="si">{}</span><span class="s2"> to be restored from rest dir&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_file</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<span class="k">def</span> <span class="nf">_check_disposition</span><span class="p">(</span><span class="n">testdir</span><span class="p">):</span>
    <span class="n">copyfilelist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">testdir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">_file</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">disposition</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Checking testfile </span><span class="si">{}</span><span class="s2"> with disposition </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="n">disposition</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="n">testdir</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;move&quot;</span> <span class="ow">in</span> <span class="n">disposition</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">find_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">),</span> <span class="n">_file</span><span class="p">):</span>
                        <span class="n">expect</span><span class="p">(</span>
                            <span class="kc">False</span><span class="p">,</span>
                            <span class="s2">&quot;Copied file </span><span class="si">{}</span><span class="s2"> to archive with disposition move&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">_file</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Failed to move file </span><span class="si">{}</span><span class="s2"> to archive&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_file</span><span class="p">))</span>
                <span class="k">if</span> <span class="s2">&quot;copy&quot;</span> <span class="ow">in</span> <span class="n">disposition</span><span class="p">:</span>
                    <span class="n">copyfilelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;ignore&quot;</span> <span class="ow">in</span> <span class="n">disposition</span><span class="p">:</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;Moved file </span><span class="si">{}</span><span class="s2"> with dispostion ignore to directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">_file</span><span class="p">,</span> <span class="n">root</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;copy&quot;</span> <span class="ow">in</span> <span class="n">disposition</span><span class="p">:</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="n">_file</span> <span class="ow">in</span> <span class="n">copyfilelist</span><span class="p">,</span>
                    <span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> with disposition copy was moved to directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">_file</span><span class="p">,</span> <span class="n">root</span>
                    <span class="p">),</span>
                <span class="p">)</span>
    <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">copyfilelist</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">find_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testdir</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">),</span> <span class="n">_file</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[],</span>
            <span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> was not copied to archive.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_file</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>