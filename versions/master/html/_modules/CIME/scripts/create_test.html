<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIME.scripts.create_test &mdash; CIME master documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/pop_ver.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CIME
          </a>
              <div class="version">
                master
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../what_cime/index.html">What is CIME?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html">Case Control System Part 1: Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html#case-control-system-part-2-configuration-porting-testing-and-use-cases">Case Control System Part 2: Configuration, Porting, Testing and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_cpl/index.html">Building a Coupled Model with CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_tools/index.html">Miscellaneous Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_user/index.html">User Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xml_files/index.html">XML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CIME_api/modules.html">CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_api/modules.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CIME</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">CIME.scripts.create_test</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CIME.scripts.create_test</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to create, build and run CIME tests. This script can:</span>

<span class="sd">1) Run a single test, or more than one test</span>
<span class="sd">   ./create_test TESTNAME</span>
<span class="sd">   ./create_test TESTNAME1 TESTNAME2 ...</span>
<span class="sd">2) Run a test suite from a text file with one test per line</span>
<span class="sd">   ./create_test -f TESTFILE</span>
<span class="sd">3) Run an E3SM test suite:</span>
<span class="sd">  Below, a suite name, SUITE, is defined in $CIMEROOT/scripts/lib/get_tests.py</span>
<span class="sd">  - Run a single suite</span>
<span class="sd">   ./create_test SUITE</span>
<span class="sd">  - Run two suites</span>
<span class="sd">   ./create_test SUITE1 SUITE2</span>
<span class="sd">  - Run all tests in a suite except for one</span>
<span class="sd">   ./create_test SUITE ^TESTNAME</span>
<span class="sd">  - Run all tests in a suite except for tests that are in another suite</span>
<span class="sd">   ./create_test SUITE1 ^SUITE2</span>
<span class="sd">  - Run all tests in a suite with baseline comparisons against master baselines</span>
<span class="sd">   ./create_test SUITE1 -c -b master</span>
<span class="sd">4) Run a CESM test suite(s):</span>
<span class="sd">   ./create_test --xml-category XML_CATEGORY [--xml-machine XML_MACHINE] [--xml-compiler XML_COMPILER] [ --xml-testlist XML_TESTLIST]</span>

<span class="sd">If this tool is missing any feature that you need, please add an issue on</span>
<span class="sd">https://github.com/ESMCI/cime</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">CIME.Tools.standard_script_setup</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">CIME</span> <span class="kn">import</span> <span class="n">get_tests</span>
<span class="kn">from</span> <span class="nn">CIME.test_scheduler</span> <span class="kn">import</span> <span class="n">TestScheduler</span><span class="p">,</span> <span class="n">RUN_PHASE</span>
<span class="kn">from</span> <span class="nn">CIME</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">expect</span><span class="p">,</span>
    <span class="n">convert_to_seconds</span><span class="p">,</span>
    <span class="n">compute_total_time</span><span class="p">,</span>
    <span class="n">convert_to_babylonian_time</span><span class="p">,</span>
    <span class="n">run_cmd_no_fail</span><span class="p">,</span>
    <span class="n">get_cime_config</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">CIME.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">CIME.XML.machines</span> <span class="kn">import</span> <span class="n">Machines</span>
<span class="kn">from</span> <span class="nn">CIME.case</span> <span class="kn">import</span> <span class="n">Case</span>
<span class="kn">from</span> <span class="nn">CIME.test_utils</span> <span class="kn">import</span> <span class="n">get_tests_from_xml</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">RawTextHelpFormatter</span>

<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">glob</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="parse_command_line"><a class="viewcode-back" href="../../../CIME_api/CIME.scripts.html#CIME.scripts.create_test.parse_command_line">[docs]</a><span class="k">def</span> <span class="nf">parse_command_line</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">RawTextHelpFormatter</span>
    <span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>

    <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">setup_standard_logging_options</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-run&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not run generated tests&quot;</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-build&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not build generated tests, implies --no-run&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-setup&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not setup generated tests, implies --no-build and --no-run&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-u&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--use-existing&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use pre-existing case directories they will pick up at the &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">latest PEND state or re-run the first failed state. Requires test-id&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;SAVE_TIMING&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--save-timing&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable archiving of performance data.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-batch&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not submit jobs to batch system, run locally.&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">If false, this will default to machine setting.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--single-exe&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use a single build for all cases. This can &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">drastically improve test throughput but is currently use-at-your-own risk.&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">It&#39;s up to the user to ensure that all cases are build-compatible.&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">E3SM tests belonging to a suite with share enabled will always share exes.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;SINGLE_SUBMIT&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--single-submit&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use a single interactive allocation to run all the tests. This can &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">drastically reduce queue waiting but only makes sense on batch machines.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;TEST_ROOT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--test-root&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Where test cases will be created. The default is output root&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">as defined in the config_machines file&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;OUTPUT_ROOT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output-root&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Where the case output is written.&quot;</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;BASELINE_ROOT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--baseline-root&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specifies a root directory for baseline datasets that will &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">be used for Bit-for-bit generate and/or compare testing.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;CLEAN&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--clean&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specifies if tests should be cleaned after run. If set, all object&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">executables and data files will be removed after the tests are run.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;MACHINE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--machine&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The machine for creating and building tests. This machine must be defined&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">in the config_machines.xml file for the given model. The default is to &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">to match the name of the machine in the test name or the name of the &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">machine this script is run on to the NODENAME_REGEX field in &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">config_machines.xml. WARNING: This option is highly unsafe and should &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">only be used if you are an expert.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;MPILIB&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--mpilib&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify the mpilib. To see list of supported MPI libraries for each machine, &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">invoke ./query_config. The default is the first listing .&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">create_test_flag_mode</span> <span class="o">==</span> <span class="s2">&quot;cesm&quot;</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--compare&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;While testing, compare baselines against the given compare directory. &quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-g&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--generate&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;While testing, generate baselines in the given generate directory. &quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NOTE: this can also be done after the fact with bless_test_results&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--xml-machine&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use this machine key in the lookup in testlist.xml. &quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The default is all if any --xml- argument is used.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--xml-compiler&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use this compiler key in the lookup in testlist.xml. &quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The default is all if any --xml- argument is used.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--xml-category&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use this category key in the lookup in testlist.xml. &quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The default is all if any --xml- argument is used.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--xml-testlist&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use this testlist to lookup tests.The default is specified in config_files.xml&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--driver&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">driver_choices</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Override driver specified in tests and use this one.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;testargs&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tests to run. Testname form is TEST.GRID.COMPSET[.MACHINE_COMPILER]&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;testargs&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Tests or test suites to run.&quot;</span>
            <span class="s2">&quot; Testname form is TEST.GRID.COMPSET[.MACHINE_COMPILER]&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--baseline-name&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If comparing or generating baselines, use this directory under baseline root. &quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Default will be current branch name.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--compare&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;While testing, compare baselines&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-g&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--generate&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;While testing, generate baselines. &quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NOTE: this can also be done after the fact with bless_test_results&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;COMPILER&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--compiler&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Compiler for building cime. Default will be the name in the &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Testname or the default defined for the machine.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-n&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--namelists-only&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only perform namelist actions for tests&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--project&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify a project id for the case (optional).&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Used for accounting and directory permissions when on a batch system.&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The default is user or machine specified by PROJECT.&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Accounting (only) may be overridden by user or machine specified CHARGE_ACCOUNT.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--test-id&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify an &#39;id&#39; for the test. This is simply a string that is appended &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">to the end of a test name. If no test-id is specified, a time stamp plus a &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">random string will be used (ensuring a high probability of uniqueness). &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">If a test-id is specified, it is the user&#39;s responsibility to ensure that &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">each run of create_test uses a unique test-id. WARNING: problems will occur &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">if you use the same test-id twice on the same file system, even if the test &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">lists are completely different.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;PARALLEL_JOBS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-j&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--parallel-jobs&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of tasks create_test should perform simultaneously. The default &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> is min(num_cores, num_tests).&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;PROC_POOL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--proc-pool&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The size of the processor pool that create_test can use. The default is &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MAX_MPITASKS_PER_NODE + 25 percent.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CIME_GLOBAL_WALLTIME&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;WALLTIME&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--walltime&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the wallclock limit for all tests in the suite. &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Use the variable CIME_GLOBAL_WALLTIME to set this for all tests.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;JOB_QUEUE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--queue&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Force batch system to use a certain queue&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--testfile&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A file containing an ascii list of tests to run&quot;</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;ALLOW_BASELINE_OVERWRITE&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--allow-baseline-overwrite&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If the --generate option is given, then an attempt to overwrite &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">an existing baseline directory will raise an error. WARNING: Specifying this &quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">option will allow existing baseline directories to be silently overwritten.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;WAIT&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--wait&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;On batch systems, wait for submitted jobs to complete&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;ALLOW_PNL&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--allow-pnl&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not pass skip-pnl to case.submit&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--check-throughput&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fail if throughput check fails. Requires --wait on batch systems&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--check-memory&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fail if memory check fails. Requires --wait on batch systems&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ignore-namelists&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not fail if there namelist diffs&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--ignore-memleak&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not fail if there&#39;s a memleak&quot;</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;FORCE_PROCS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--force-procs&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For all tests to run with this number of processors&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;FORCE_THREADS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--force-threads&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For all tests to run with this number of threads&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;INPUT_DIR&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-i&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--input-dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use a non-default location for input files&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;PESFILE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--pesfile&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Full pathname of an optional pes specification file. The file&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">can follow either the config_pes.xml or the env_mach_pes.xml format.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">default</span> <span class="o">=</span> <span class="n">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;RETRY&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--retry&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Automatically retry failed tests. &gt;0 implies --wait&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--non-local&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use when you&#39;ve requested a machine that you aren&#39;t on. &quot;</span>
        <span class="s2">&quot;Will reduce errors for missing directories etc.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;workflow&quot;</span><span class="p">):</span>
        <span class="n">workflow_default</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;workflow&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">workflow_default</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--workflow&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">workflow_default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;A workflow from config_workflow.xml to apply to this case. &quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--chksum&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Verifies input data checksums.&quot;</span>
    <span class="p">)</span>

    <span class="n">srcroot_default</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_src_root</span><span class="p">()</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--srcroot&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">srcroot_default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Alternative pathname for source root directory. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;The default is </span><span class="si">{</span><span class="n">srcroot_default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--force-rebuild&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;When used with &#39;use-existing&#39; and &#39;test-id&#39;, the&quot;</span>
        <span class="s2">&quot;tests will have their &#39;BUILD_SHAREDLIB&#39; phase reset to &#39;PEND&#39;.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">add_mail_type_args</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parse_args_and_handle_standard_logging_options</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>

    <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">resolve_mail_type_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">force_rebuild</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">use_existing</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">test_id</span><span class="p">,</span>
            <span class="s2">&quot;Cannot force a rebuild without &#39;use-existing&#39; and &#39;test-id&#39;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># generate and compare flags may not point to the same directory</span>
    <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">create_test_flag_mode</span> <span class="o">==</span> <span class="s2">&quot;cesm&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">generate</span> <span class="o">==</span> <span class="n">args</span><span class="o">.</span><span class="n">compare</span><span class="p">),</span>
                <span class="s2">&quot;Cannot generate and compare baselines at the same time&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">xml_testlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="ow">not</span> <span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">xml_machine</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">xml_compiler</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">xml_category</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="s2">&quot;If an xml-testlist is present at least one of --xml-machine, &quot;</span>
                <span class="s2">&quot;--xml-compiler, --xml-category must also be present&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="ow">not</span> <span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">baseline_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">compare</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;Provided baseline name but did not specify compare or generate&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">compare</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span><span class="p">),</span>
            <span class="s2">&quot;Tried to compare and generate at same time&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span>
        <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">namelists_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">generate</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">compare</span><span class="p">)),</span>
        <span class="s2">&quot;Must provide either --compare or --generate with --namelists-only&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">retry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">parallel_jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">parallel_jobs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;Invalid value for parallel_jobs: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">parallel_jobs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_existing</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">test_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Must provide test-id of pre-existing cases&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_setup</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_build</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_build</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Namelist-only forces some other options:</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">namelists_only</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_setup</span><span class="p">,</span> <span class="s2">&quot;Cannot compare namelists without setup&quot;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_build</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_run</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_batch</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">expect</span><span class="p">(</span>
        <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">non_local</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_build</span><span class="p">),</span> <span class="s2">&quot;Cannot build on non-local machine&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">single_submit</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_run</span><span class="p">,</span>
            <span class="s2">&quot;Doesn&#39;t make sense to request single-submit if no-run is on&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_build</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_run</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_batch</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">test_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">test_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">(),</span> <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">id_generator</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">check_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">test_id</span><span class="p">,</span> <span class="n">additional_chars</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
            <span class="s2">&quot;invalid test-id argument provided&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">testfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">testfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">testargs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="c1"># Propagate `srcroot` to `GenericXML` to resolve $SRCROOT</span>
    <span class="c1"># See call to `Machines` below</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">GLOBAL</span><span class="p">[</span><span class="s2">&quot;SRCROOT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">srcroot</span>

    <span class="c1"># Compute list of fully-resolved test_names</span>
    <span class="n">test_extra_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">check_machine_name_from_test_name</span><span class="p">:</span>
        <span class="n">machine_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">xml_machine</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">machine</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">machine</span>

        <span class="c1"># If it&#39;s still unclear what machine to use, look at test names</span>
        <span class="k">if</span> <span class="n">machine_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">testargs</span><span class="p">:</span>
                <span class="n">testsplit</span> <span class="o">=</span> <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parse_test_name</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">testsplit</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">machine_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">machine_name</span> <span class="o">=</span> <span class="n">testsplit</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expect</span><span class="p">(</span>
                            <span class="n">machine_name</span> <span class="o">==</span> <span class="n">testsplit</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                            <span class="s2">&quot;ambiguity in machine, please use the --machine option&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="n">mach_obj</span> <span class="o">=</span> <span class="n">Machines</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="n">machine_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">testargs</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">mach_obj</span><span class="o">.</span><span class="n">get_default_compiler</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">compiler</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">compiler</span>
            <span class="p">)</span>
            <span class="n">test_names</span> <span class="o">=</span> <span class="n">get_tests</span><span class="o">.</span><span class="n">get_full_test_names</span><span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">testargs</span><span class="p">,</span> <span class="n">mach_obj</span><span class="o">.</span><span class="n">get_machine_name</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">compiler</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="ow">not</span> <span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">xml_machine</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">xml_compiler</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">xml_category</span> <span class="ow">is</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">xml_testlist</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="s2">&quot;At least one of --xml-machine, --xml-testlist, &quot;</span>
                <span class="s2">&quot;--xml-compiler, --xml-category or a valid test name must be provided.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">test_data</span> <span class="o">=</span> <span class="n">get_tests_from_xml</span><span class="p">(</span>
                <span class="n">xml_machine</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">xml_machine</span><span class="p">,</span>
                <span class="n">xml_category</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">xml_category</span><span class="p">,</span>
                <span class="n">xml_compiler</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">xml_compiler</span><span class="p">,</span>
                <span class="n">xml_testlist</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">xml_testlist</span><span class="p">,</span>
                <span class="n">machine</span><span class="o">=</span><span class="n">machine_name</span><span class="p">,</span>
                <span class="n">compiler</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span>
                <span class="n">driver</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">test_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">test_datum</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
                <span class="n">test_extra_data</span><span class="p">[</span><span class="n">test_datum</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">test_datum</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Testnames: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">test_names</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inf_machine</span><span class="p">,</span> <span class="n">inf_compilers</span> <span class="o">=</span> <span class="n">get_tests</span><span class="o">.</span><span class="n">infer_arch_from_tests</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">testargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">machine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">machine</span> <span class="o">=</span> <span class="n">inf_machine</span>

        <span class="n">mach_obj</span> <span class="o">=</span> <span class="n">Machines</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">machine</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">compiler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_compilers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="n">mach_obj</span><span class="o">.</span><span class="n">get_default_compiler</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">inf_compilers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="n">inf_compilers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># User has multiple compiler specifications in their testargs</span>
                <span class="n">args</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="n">inf_compilers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">compare</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span><span class="p">,</span>
                    <span class="s2">&quot;It is not safe to do baseline operations with heterogenous compiler set: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">inf_compilers</span>
                    <span class="p">),</span>
                <span class="p">)</span>

        <span class="n">test_names</span> <span class="o">=</span> <span class="n">get_tests</span><span class="o">.</span><span class="n">get_full_test_names</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">testargs</span><span class="p">,</span> <span class="n">mach_obj</span><span class="o">.</span><span class="n">get_machine_name</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">compiler</span>
        <span class="p">)</span>

    <span class="n">expect</span><span class="p">(</span>
        <span class="n">mach_obj</span><span class="o">.</span><span class="n">is_valid_compiler</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">compiler</span><span class="p">),</span>
        <span class="s2">&quot;Compiler </span><span class="si">%s</span><span class="s2"> not valid for machine </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span> <span class="n">mach_obj</span><span class="o">.</span><span class="n">get_machine_name</span><span class="p">()),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">wait</span> <span class="ow">and</span> <span class="n">mach_obj</span><span class="o">.</span><span class="n">has_batch_system</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_batch</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">check_throughput</span><span class="p">,</span>
            <span class="s2">&quot;Makes no sense to use --check-throughput without --wait&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">check_memory</span><span class="p">,</span> <span class="s2">&quot;Makes no sense to use --check-memory without --wait&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Normalize compare/generate between the models</span>
    <span class="n">baseline_cmp_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">baseline_gen_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">compare</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">create_test_flag_mode</span> <span class="o">==</span> <span class="s2">&quot;cesm&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">baseline_cmp_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">compare</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">baseline_gen_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">baseline_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">baseline_name</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">baseline_name</span>
                <span class="k">else</span> <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_current_branch</span><span class="p">(</span><span class="n">repo</span><span class="o">=</span><span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_cime_root</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="n">baseline_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Could not determine baseline name from branch, please use -b option&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">compare</span><span class="p">:</span>
                <span class="n">baseline_cmp_name</span> <span class="o">=</span> <span class="n">baseline_name</span>
            <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">generate</span><span class="p">:</span>
                <span class="n">baseline_gen_name</span> <span class="o">=</span> <span class="n">baseline_name</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">input_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">input_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input_dir</span><span class="p">)</span>

    <span class="c1"># sanity check</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">test_names</span><span class="p">:</span>
        <span class="n">dot_count</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">dot_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dot_count</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Invalid test Name, &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="c1"># for e3sm, sort by walltime</span>
    <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">sort_tests</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">walltime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Longest tests should run first</span>
            <span class="n">test_names</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">get_tests</span><span class="o">.</span><span class="n">key_test_time</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">test_names</span><span class="p">,</span>
        <span class="n">test_extra_data</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span>
        <span class="n">mach_obj</span><span class="o">.</span><span class="n">get_machine_name</span><span class="p">(),</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_run</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_build</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_setup</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">no_batch</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">test_root</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">baseline_root</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">clean</span><span class="p">,</span>
        <span class="n">baseline_cmp_name</span><span class="p">,</span>
        <span class="n">baseline_gen_name</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">namelists_only</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">test_id</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">parallel_jobs</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">walltime</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">single_submit</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">proc_pool</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">use_existing</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">save_timing</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">allow_baseline_overwrite</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">output_root</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">wait</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">force_procs</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">force_threads</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mpilib</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">pesfile</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">retry</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mail_user</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">mail_type</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">check_throughput</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">check_memory</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">ignore_namelists</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">ignore_memleak</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">allow_pnl</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">non_local</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">single_exe</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">workflow</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chksum</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">force_rebuild</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="get_default_setting"><a class="viewcode-back" href="../../../CIME_api/CIME.scripts.html#CIME.scripts.create_test.get_default_setting">[docs]</a><span class="k">def</span> <span class="nf">get_default_setting</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">default_if_not_found</span><span class="p">,</span> <span class="n">check_main</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;create_test&quot;</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;create_test&quot;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">check_main</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">default_if_not_found</span>
    <span class="k">return</span> <span class="n">default</span></div>


<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="single_submit_impl"><a class="viewcode-back" href="../../../CIME_api/CIME.scripts.html#CIME.scripts.create_test.single_submit_impl">[docs]</a><span class="k">def</span> <span class="nf">single_submit_impl</span><span class="p">(</span>
    <span class="n">machine_name</span><span class="p">,</span> <span class="n">test_id</span><span class="p">,</span> <span class="n">proc_pool</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">job_cost_map</span><span class="p">,</span> <span class="n">wall_time</span><span class="p">,</span> <span class="n">test_root</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
    <span class="n">mach</span> <span class="o">=</span> <span class="n">Machines</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="n">machine_name</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>
        <span class="n">mach</span><span class="o">.</span><span class="n">has_batch_system</span><span class="p">(),</span>
        <span class="s2">&quot;Single submit does not make sense on non-batch machine &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
        <span class="o">%</span> <span class="n">mach</span><span class="o">.</span><span class="n">get_machine_name</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">machine_name</span> <span class="o">=</span> <span class="n">mach</span><span class="o">.</span><span class="n">get_machine_name</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># Compute arg list for second call to create_test</span>
    <span class="c1">#</span>
    <span class="n">new_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">new_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;--single-submit&quot;</span><span class="p">)</span>
    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--no-batch&quot;</span><span class="p">)</span>
    <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--use-existing&quot;</span><span class="p">)</span>
    <span class="n">no_arg_is_a_test_id_arg</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">no_arg_is_a_proc_pool_arg</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">no_arg_is_a_machine_arg</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">new_args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;-t&quot;</span> <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--test-id&quot;</span><span class="p">):</span>
            <span class="n">no_arg_is_a_test_id_arg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--proc-pool&quot;</span><span class="p">):</span>
            <span class="n">no_arg_is_a_proc_pool_arg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;-m&quot;</span> <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--machine&quot;</span><span class="p">):</span>
            <span class="n">no_arg_is_a_machine_arg</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">no_arg_is_a_test_id_arg</span><span class="p">:</span>
        <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-t </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">test_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">no_arg_is_a_proc_pool_arg</span><span class="p">:</span>
        <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--proc-pool </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">proc_pool</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">no_arg_is_a_machine_arg</span><span class="p">:</span>
        <span class="n">new_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-m </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">machine_name</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Resolve batch directives manually. There is currently no other way</span>
    <span class="c1"># to do this without making a Case object. Make a throwaway case object</span>
    <span class="c1"># to help us here.</span>
    <span class="c1">#</span>
    <span class="n">testcase_dirs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/*</span><span class="si">%s</span><span class="s2">*/TestStatus&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_root</span><span class="p">,</span> <span class="n">test_id</span><span class="p">))</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">testcase_dirs</span><span class="p">,</span> <span class="s2">&quot;No test case dirs found!?&quot;</span><span class="p">)</span>
    <span class="n">first_case</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">testcase_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">with</span> <span class="n">Case</span><span class="p">(</span><span class="n">first_case</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">case</span><span class="p">:</span>
        <span class="n">env_batch</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>

        <span class="n">submit_cmd</span> <span class="o">=</span> <span class="n">env_batch</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;batch_submit&quot;</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">submit_args</span> <span class="o">=</span> <span class="n">env_batch</span><span class="o">.</span><span class="n">get_submit_args</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="s2">&quot;case.test&quot;</span><span class="p">)</span>

    <span class="n">tasks_per_node</span> <span class="o">=</span> <span class="n">mach</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MAX_MPITASKS_PER_NODE&quot;</span><span class="p">)</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">proc_pool</span><span class="p">)</span> <span class="o">/</span> <span class="n">tasks_per_node</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">wall_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wall_time</span> <span class="o">=</span> <span class="n">compute_total_time</span><span class="p">(</span><span class="n">job_cost_map</span><span class="p">,</span> <span class="n">proc_pool</span><span class="p">)</span>
        <span class="n">wall_time_bab</span> <span class="o">=</span> <span class="n">convert_to_babylonian_time</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">wall_time</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wall_time_bab</span> <span class="o">=</span> <span class="n">wall_time</span>

    <span class="n">queue</span> <span class="o">=</span> <span class="n">env_batch</span><span class="o">.</span><span class="n">select_best_queue</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">proc_pool</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="n">wall_time_bab</span><span class="p">)</span>
    <span class="n">wall_time_max_bab</span> <span class="o">=</span> <span class="n">env_batch</span><span class="o">.</span><span class="n">get_queue_specs</span><span class="p">(</span><span class="n">queue</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">wall_time_max_bab</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wall_time_max</span> <span class="o">=</span> <span class="n">convert_to_seconds</span><span class="p">(</span><span class="n">wall_time_max_bab</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wall_time_max</span> <span class="o">&lt;</span> <span class="n">wall_time</span><span class="p">:</span>
            <span class="n">wall_time</span> <span class="o">=</span> <span class="n">wall_time_max</span>
            <span class="n">wall_time_bab</span> <span class="o">=</span> <span class="n">convert_to_babylonian_time</span><span class="p">(</span><span class="n">wall_time</span><span class="p">)</span>

    <span class="n">overrides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="s2">&quot;create_test_single_submit_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">test_id</span><span class="p">,</span>
        <span class="s2">&quot;num_nodes&quot;</span><span class="p">:</span> <span class="n">num_nodes</span><span class="p">,</span>
        <span class="s2">&quot;tasks_per_node&quot;</span><span class="p">:</span> <span class="n">tasks_per_node</span><span class="p">,</span>
        <span class="s2">&quot;totaltasks&quot;</span><span class="p">:</span> <span class="n">tasks_per_node</span> <span class="o">*</span> <span class="n">num_nodes</span><span class="p">,</span>
        <span class="s2">&quot;job_wallclock_time&quot;</span><span class="p">:</span> <span class="n">wall_time_bab</span><span class="p">,</span>
        <span class="s2">&quot;job_queue&quot;</span><span class="p">:</span> <span class="n">env_batch</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">directives</span> <span class="o">=</span> <span class="n">env_batch</span><span class="o">.</span><span class="n">get_batch_directives</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="s2">&quot;case.test&quot;</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="n">overrides</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Make simple submit script and submit</span>
    <span class="c1">#</span>

    <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;#! /bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">directives</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;cd </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_args</span><span class="p">))</span>

    <span class="n">submit_cmd</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">submit_cmd</span><span class="p">,</span> <span class="n">submit_args</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Script:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">script</span><span class="p">)</span>

    <span class="n">run_cmd_no_fail</span><span class="p">(</span>
        <span class="n">submit_cmd</span><span class="p">,</span> <span class="n">input_str</span><span class="o">=</span><span class="n">script</span><span class="p">,</span> <span class="n">arg_stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arg_stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span></div>


<span class="c1">###############################################################################</span>
<span class="c1"># pragma pylint: disable=protected-access</span>
<div class="viewcode-block" id="create_test"><a class="viewcode-back" href="../../../CIME_api/CIME.scripts.html#CIME.scripts.create_test.create_test">[docs]</a><span class="k">def</span> <span class="nf">create_test</span><span class="p">(</span>
    <span class="n">test_names</span><span class="p">,</span>
    <span class="n">test_data</span><span class="p">,</span>
    <span class="n">compiler</span><span class="p">,</span>
    <span class="n">machine_name</span><span class="p">,</span>
    <span class="n">no_run</span><span class="p">,</span>
    <span class="n">no_build</span><span class="p">,</span>
    <span class="n">no_setup</span><span class="p">,</span>
    <span class="n">no_batch</span><span class="p">,</span>
    <span class="n">test_root</span><span class="p">,</span>
    <span class="n">baseline_root</span><span class="p">,</span>
    <span class="n">clean</span><span class="p">,</span>
    <span class="n">baseline_cmp_name</span><span class="p">,</span>
    <span class="n">baseline_gen_name</span><span class="p">,</span>
    <span class="n">namelists_only</span><span class="p">,</span>
    <span class="n">project</span><span class="p">,</span>
    <span class="n">test_id</span><span class="p">,</span>
    <span class="n">parallel_jobs</span><span class="p">,</span>
    <span class="n">walltime</span><span class="p">,</span>
    <span class="n">single_submit</span><span class="p">,</span>
    <span class="n">proc_pool</span><span class="p">,</span>
    <span class="n">use_existing</span><span class="p">,</span>
    <span class="n">save_timing</span><span class="p">,</span>
    <span class="n">queue</span><span class="p">,</span>
    <span class="n">allow_baseline_overwrite</span><span class="p">,</span>
    <span class="n">output_root</span><span class="p">,</span>
    <span class="n">wait</span><span class="p">,</span>
    <span class="n">force_procs</span><span class="p">,</span>
    <span class="n">force_threads</span><span class="p">,</span>
    <span class="n">mpilib</span><span class="p">,</span>
    <span class="n">input_dir</span><span class="p">,</span>
    <span class="n">pesfile</span><span class="p">,</span>
    <span class="n">run_count</span><span class="p">,</span>
    <span class="n">mail_user</span><span class="p">,</span>
    <span class="n">mail_type</span><span class="p">,</span>
    <span class="n">check_throughput</span><span class="p">,</span>
    <span class="n">check_memory</span><span class="p">,</span>
    <span class="n">ignore_namelists</span><span class="p">,</span>
    <span class="n">ignore_memleak</span><span class="p">,</span>
    <span class="n">allow_pnl</span><span class="p">,</span>
    <span class="n">non_local</span><span class="p">,</span>
    <span class="n">single_exe</span><span class="p">,</span>
    <span class="n">workflow</span><span class="p">,</span>
    <span class="n">chksum</span><span class="p">,</span>
    <span class="n">force_rebuild</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1">###############################################################################</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">TestScheduler</span><span class="p">(</span>
        <span class="n">test_names</span><span class="p">,</span>
        <span class="n">test_data</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span>
        <span class="n">no_run</span><span class="o">=</span><span class="n">no_run</span><span class="p">,</span>
        <span class="n">no_build</span><span class="o">=</span><span class="n">no_build</span><span class="p">,</span>
        <span class="n">no_setup</span><span class="o">=</span><span class="n">no_setup</span><span class="p">,</span>
        <span class="n">no_batch</span><span class="o">=</span><span class="n">no_batch</span><span class="p">,</span>
        <span class="n">test_root</span><span class="o">=</span><span class="n">test_root</span><span class="p">,</span>
        <span class="n">test_id</span><span class="o">=</span><span class="n">test_id</span><span class="p">,</span>
        <span class="n">baseline_root</span><span class="o">=</span><span class="n">baseline_root</span><span class="p">,</span>
        <span class="n">baseline_cmp_name</span><span class="o">=</span><span class="n">baseline_cmp_name</span><span class="p">,</span>
        <span class="n">baseline_gen_name</span><span class="o">=</span><span class="n">baseline_gen_name</span><span class="p">,</span>
        <span class="n">clean</span><span class="o">=</span><span class="n">clean</span><span class="p">,</span>
        <span class="n">machine_name</span><span class="o">=</span><span class="n">machine_name</span><span class="p">,</span>
        <span class="n">compiler</span><span class="o">=</span><span class="n">compiler</span><span class="p">,</span>
        <span class="n">namelists_only</span><span class="o">=</span><span class="n">namelists_only</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
        <span class="n">parallel_jobs</span><span class="o">=</span><span class="n">parallel_jobs</span><span class="p">,</span>
        <span class="n">walltime</span><span class="o">=</span><span class="n">walltime</span><span class="p">,</span>
        <span class="n">proc_pool</span><span class="o">=</span><span class="n">proc_pool</span><span class="p">,</span>
        <span class="n">use_existing</span><span class="o">=</span><span class="n">use_existing</span><span class="p">,</span>
        <span class="n">save_timing</span><span class="o">=</span><span class="n">save_timing</span><span class="p">,</span>
        <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
        <span class="n">allow_baseline_overwrite</span><span class="o">=</span><span class="n">allow_baseline_overwrite</span><span class="p">,</span>
        <span class="n">output_root</span><span class="o">=</span><span class="n">output_root</span><span class="p">,</span>
        <span class="n">force_procs</span><span class="o">=</span><span class="n">force_procs</span><span class="p">,</span>
        <span class="n">force_threads</span><span class="o">=</span><span class="n">force_threads</span><span class="p">,</span>
        <span class="n">mpilib</span><span class="o">=</span><span class="n">mpilib</span><span class="p">,</span>
        <span class="n">input_dir</span><span class="o">=</span><span class="n">input_dir</span><span class="p">,</span>
        <span class="n">pesfile</span><span class="o">=</span><span class="n">pesfile</span><span class="p">,</span>
        <span class="n">run_count</span><span class="o">=</span><span class="n">run_count</span><span class="p">,</span>
        <span class="n">mail_user</span><span class="o">=</span><span class="n">mail_user</span><span class="p">,</span>
        <span class="n">mail_type</span><span class="o">=</span><span class="n">mail_type</span><span class="p">,</span>
        <span class="n">allow_pnl</span><span class="o">=</span><span class="n">allow_pnl</span><span class="p">,</span>
        <span class="n">non_local</span><span class="o">=</span><span class="n">non_local</span><span class="p">,</span>
        <span class="n">single_exe</span><span class="o">=</span><span class="n">single_exe</span><span class="p">,</span>
        <span class="n">workflow</span><span class="o">=</span><span class="n">workflow</span><span class="p">,</span>
        <span class="n">chksum</span><span class="o">=</span><span class="n">chksum</span><span class="p">,</span>
        <span class="n">force_rebuild</span><span class="o">=</span><span class="n">force_rebuild</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">success</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">run_tests</span><span class="p">(</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
        <span class="n">check_throughput</span><span class="o">=</span><span class="n">check_throughput</span><span class="p">,</span>
        <span class="n">check_memory</span><span class="o">=</span><span class="n">check_memory</span><span class="p">,</span>
        <span class="n">ignore_namelists</span><span class="o">=</span><span class="n">ignore_namelists</span><span class="p">,</span>
        <span class="n">ignore_memleak</span><span class="o">=</span><span class="n">ignore_memleak</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">single_submit</span><span class="p">:</span>
        <span class="c1"># Get real test root</span>
        <span class="n">test_root</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">_test_root</span>

        <span class="n">job_cost_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">largest_case</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">impl</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
            <span class="n">test_dir</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">_get_test_dir</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="n">procs_needed</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">_get_procs_needed</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">RUN_PHASE</span><span class="p">)</span>
            <span class="n">time_needed</span> <span class="o">=</span> <span class="n">convert_to_seconds</span><span class="p">(</span>
                <span class="n">run_cmd_no_fail</span><span class="p">(</span>
                    <span class="s2">&quot;./xmlquery JOB_WALLCLOCK_TIME -value -subgroup case.test&quot;</span><span class="p">,</span>
                    <span class="n">from_dir</span><span class="o">=</span><span class="n">test_dir</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">job_cost_map</span><span class="p">[</span><span class="n">test</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">procs_needed</span><span class="p">,</span> <span class="n">time_needed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">procs_needed</span> <span class="o">&gt;</span> <span class="n">largest_case</span><span class="p">:</span>
                <span class="n">largest_case</span> <span class="o">=</span> <span class="n">procs_needed</span>

        <span class="k">if</span> <span class="n">proc_pool</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Based on size of created jobs, choose a reasonable proc_pool. May need to put</span>
            <span class="c1"># more thought into this.</span>
            <span class="n">proc_pool</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">largest_case</span>

        <span class="c1"># Create submit script</span>
        <span class="n">single_submit_impl</span><span class="p">(</span>
            <span class="n">machine_name</span><span class="p">,</span>
            <span class="n">test_id</span><span class="p">,</span>
            <span class="n">proc_pool</span><span class="p">,</span>
            <span class="n">project</span><span class="p">,</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
            <span class="n">job_cost_map</span><span class="p">,</span>
            <span class="n">walltime</span><span class="p">,</span>
            <span class="n">test_root</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">success</span></div>


<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">_main_func</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1">###############################################################################</span>
    <span class="n">customize_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">get_src_root</span><span class="p">(),</span> <span class="s2">&quot;cime_config&quot;</span><span class="p">,</span> <span class="s2">&quot;customize&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">customize_path</span><span class="p">):</span>
        <span class="n">Config</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">customize_path</span><span class="p">)</span>

    <span class="p">(</span>
        <span class="n">test_names</span><span class="p">,</span>
        <span class="n">test_data</span><span class="p">,</span>
        <span class="n">compiler</span><span class="p">,</span>
        <span class="n">machine_name</span><span class="p">,</span>
        <span class="n">no_run</span><span class="p">,</span>
        <span class="n">no_build</span><span class="p">,</span>
        <span class="n">no_setup</span><span class="p">,</span>
        <span class="n">no_batch</span><span class="p">,</span>
        <span class="n">test_root</span><span class="p">,</span>
        <span class="n">baseline_root</span><span class="p">,</span>
        <span class="n">clean</span><span class="p">,</span>
        <span class="n">baseline_cmp_name</span><span class="p">,</span>
        <span class="n">baseline_gen_name</span><span class="p">,</span>
        <span class="n">namelists_only</span><span class="p">,</span>
        <span class="n">project</span><span class="p">,</span>
        <span class="n">test_id</span><span class="p">,</span>
        <span class="n">parallel_jobs</span><span class="p">,</span>
        <span class="n">walltime</span><span class="p">,</span>
        <span class="n">single_submit</span><span class="p">,</span>
        <span class="n">proc_pool</span><span class="p">,</span>
        <span class="n">use_existing</span><span class="p">,</span>
        <span class="n">save_timing</span><span class="p">,</span>
        <span class="n">queue</span><span class="p">,</span>
        <span class="n">allow_baseline_overwrite</span><span class="p">,</span>
        <span class="n">output_root</span><span class="p">,</span>
        <span class="n">wait</span><span class="p">,</span>
        <span class="n">force_procs</span><span class="p">,</span>
        <span class="n">force_threads</span><span class="p">,</span>
        <span class="n">mpilib</span><span class="p">,</span>
        <span class="n">input_dir</span><span class="p">,</span>
        <span class="n">pesfile</span><span class="p">,</span>
        <span class="n">retry</span><span class="p">,</span>
        <span class="n">mail_user</span><span class="p">,</span>
        <span class="n">mail_type</span><span class="p">,</span>
        <span class="n">check_throughput</span><span class="p">,</span>
        <span class="n">check_memory</span><span class="p">,</span>
        <span class="n">ignore_namelists</span><span class="p">,</span>
        <span class="n">ignore_memleak</span><span class="p">,</span>
        <span class="n">allow_pnl</span><span class="p">,</span>
        <span class="n">non_local</span><span class="p">,</span>
        <span class="n">single_exe</span><span class="p">,</span>
        <span class="n">workflow</span><span class="p">,</span>
        <span class="n">chksum</span><span class="p">,</span>
        <span class="n">force_rebuild</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">parse_command_line</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">run_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">run_count</span> <span class="o">&lt;=</span> <span class="n">retry</span><span class="p">:</span>
        <span class="n">use_existing</span> <span class="o">=</span> <span class="n">use_existing</span> <span class="k">if</span> <span class="n">run_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="n">allow_baseline_overwrite</span> <span class="o">=</span> <span class="n">allow_baseline_overwrite</span> <span class="k">if</span> <span class="n">run_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">create_test</span><span class="p">(</span>
            <span class="n">test_names</span><span class="p">,</span>
            <span class="n">test_data</span><span class="p">,</span>
            <span class="n">compiler</span><span class="p">,</span>
            <span class="n">machine_name</span><span class="p">,</span>
            <span class="n">no_run</span><span class="p">,</span>
            <span class="n">no_build</span><span class="p">,</span>
            <span class="n">no_setup</span><span class="p">,</span>
            <span class="n">no_batch</span><span class="p">,</span>
            <span class="n">test_root</span><span class="p">,</span>
            <span class="n">baseline_root</span><span class="p">,</span>
            <span class="n">clean</span><span class="p">,</span>
            <span class="n">baseline_cmp_name</span><span class="p">,</span>
            <span class="n">baseline_gen_name</span><span class="p">,</span>
            <span class="n">namelists_only</span><span class="p">,</span>
            <span class="n">project</span><span class="p">,</span>
            <span class="n">test_id</span><span class="p">,</span>
            <span class="n">parallel_jobs</span><span class="p">,</span>
            <span class="n">walltime</span><span class="p">,</span>
            <span class="n">single_submit</span><span class="p">,</span>
            <span class="n">proc_pool</span><span class="p">,</span>
            <span class="n">use_existing</span><span class="p">,</span>
            <span class="n">save_timing</span><span class="p">,</span>
            <span class="n">queue</span><span class="p">,</span>
            <span class="n">allow_baseline_overwrite</span><span class="p">,</span>
            <span class="n">output_root</span><span class="p">,</span>
            <span class="n">wait</span><span class="p">,</span>
            <span class="n">force_procs</span><span class="p">,</span>
            <span class="n">force_threads</span><span class="p">,</span>
            <span class="n">mpilib</span><span class="p">,</span>
            <span class="n">input_dir</span><span class="p">,</span>
            <span class="n">pesfile</span><span class="p">,</span>
            <span class="n">run_count</span><span class="p">,</span>
            <span class="n">mail_user</span><span class="p">,</span>
            <span class="n">mail_type</span><span class="p">,</span>
            <span class="n">check_throughput</span><span class="p">,</span>
            <span class="n">check_memory</span><span class="p">,</span>
            <span class="n">ignore_namelists</span><span class="p">,</span>
            <span class="n">ignore_memleak</span><span class="p">,</span>
            <span class="n">allow_pnl</span><span class="p">,</span>
            <span class="n">non_local</span><span class="p">,</span>
            <span class="n">single_exe</span><span class="p">,</span>
            <span class="n">workflow</span><span class="p">,</span>
            <span class="n">chksum</span><span class="p">,</span>
            <span class="n">force_rebuild</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">run_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># For testing only</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TESTBUILDFAIL_PASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TESTRUNFAIL_PASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;True&quot;</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">CIME</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">TESTS_FAILED_ERR_CODE</span><span class="p">)</span>


<span class="c1">###############################################################################</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">_main_func</span><span class="p">(</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>