<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIME.utils &mdash; CIME master documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=30d551ce"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/pop_ver.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            CIME
          </a>
              <div class="version">
                master
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../what_cime/index.html">What is CIME?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/index.html">Case Control System Part 1: Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users_guide/index.html#case-control-system-part-2-configuration-porting-testing-and-use-cases">Case Control System Part 2: Configuration, Porting, Testing and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_cpl/index.html">Building a Coupled Model with CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc_tools/index.html">Miscellaneous Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools_user/index.html">User Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xml_files/index.html">XML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CIME_api/modules.html">CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools_api/modules.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CIME</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">CIME.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CIME.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Common functions used by cime python scripts</span>
<span class="sd">Warning: you cannot use CIME Classes in this module as it causes circular dependencies</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">importlib</span><span class="o">,</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">importlib.util</span>
<span class="kn">import</span> <span class="nn">errno</span><span class="o">,</span> <span class="nn">signal</span><span class="o">,</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">stat</span> <span class="k">as</span> <span class="nn">statlib</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Action</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">from</span> <span class="nn">distutils</span> <span class="kn">import</span> <span class="n">file_util</span>

<span class="c1"># Return this error code if the scripts worked but tests failed</span>
<span class="n">TESTS_FAILED_ERR_CODE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Fix to pass user defined `srcroot` to `CIME.XML.generic_xml.GenericXML`</span>
<span class="c1"># where it&#39;s used to resolve $SRCROOT in XML config files.</span>
<span class="n">GLOBAL</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="deprecate_action">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.deprecate_action">[docs]</a>
<span class="k">def</span> <span class="nf">deprecate_action</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">ActionStoreDeprecated</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">DeprecationWarning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">option_string</span><span class="si">}</span><span class="s2"> is deprecated</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ActionStoreDeprecated</span></div>



<div class="viewcode-block" id="import_from_file">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.import_from_file">[docs]</a>
<span class="k">def</span> <span class="nf">import_from_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">machinery</span><span class="o">.</span><span class="n">SourceFileLoader</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_loader</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">loader</span><span class="p">)</span>

    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

    <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">module</span></div>



<div class="viewcode-block" id="redirect_stdout">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.redirect_stdout">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">redirect_stdout</span><span class="p">(</span><span class="n">new_target</span><span class="p">):</span>
    <span class="n">old_target</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">new_target</span>  <span class="c1"># replace sys.stdout</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">new_target</span>  <span class="c1"># run some code with the replaced stdout</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">old_target</span>  <span class="c1"># restore to the previous value</span></div>



<div class="viewcode-block" id="redirect_stderr">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.redirect_stderr">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">redirect_stderr</span><span class="p">(</span><span class="n">new_target</span><span class="p">):</span>
    <span class="n">old_target</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">new_target</span>  <span class="c1"># replace sys.stdout</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">new_target</span>  <span class="c1"># run some code with the replaced stdout</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_target</span>  <span class="c1"># restore to the previous value</span></div>



<div class="viewcode-block" id="redirect_stdout_stderr">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.redirect_stdout_stderr">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">redirect_stdout_stderr</span><span class="p">(</span><span class="n">new_target</span><span class="p">):</span>
    <span class="n">old_stdout</span><span class="p">,</span> <span class="n">old_stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">new_target</span><span class="p">,</span> <span class="n">new_target</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">new_target</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_stdout</span><span class="p">,</span> <span class="n">old_stderr</span></div>



<div class="viewcode-block" id="redirect_logger">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.redirect_logger">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">redirect_logger</span><span class="p">(</span><span class="n">new_target</span><span class="p">,</span> <span class="n">logger_name</span><span class="p">):</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">new_target</span><span class="p">)</span>
    <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>
    <span class="n">root_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">orig_handlers</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">handlers</span>
    <span class="n">orig_root_loggers</span> <span class="o">=</span> <span class="n">root_log</span><span class="o">.</span><span class="n">handlers</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">root_log</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">log</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">root_log</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">orig_root_loggers</span>
        <span class="n">log</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">orig_handlers</span></div>



<div class="viewcode-block" id="IndentFormatter">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.IndentFormatter">[docs]</a>
<span class="k">class</span> <span class="nc">IndentFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">datefmt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indent</span> <span class="o">=</span> <span class="n">indent</span>

<div class="viewcode-block" id="IndentFormatter.format">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.IndentFormatter.format">[docs]</a>
    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">record</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indent</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>
</div>



<div class="viewcode-block" id="set_logger_indent">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.set_logger_indent">[docs]</a>
<span class="k">def</span> <span class="nf">set_logger_indent</span><span class="p">(</span><span class="n">indent</span><span class="p">):</span>
    <span class="n">root_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">root_log</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">IndentFormatter</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>

    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">root_log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span></div>



<div class="viewcode-block" id="EnvironmentContext">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.EnvironmentContext">[docs]</a>
<span class="k">class</span> <span class="nc">EnvironmentContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager for environment variables</span>
<span class="sd">    Usage:</span>
<span class="sd">        os.environ[&#39;MYVAR&#39;] = &#39;oldvalue&#39;</span>
<span class="sd">        with EnvironmentContex(MYVAR=&#39;myvalue&#39;, MYVAR2=&#39;myvalue2&#39;):</span>
<span class="sd">            print os.getenv(&#39;MYVAR&#39;)    # Should print myvalue.</span>
<span class="sd">            print os.getenv(&#39;MYVAR2&#39;)    # Should print myvalue2.</span>
<span class="sd">        print os.getenv(&#39;MYVAR&#39;)        # Should print oldvalue.</span>
<span class="sd">        print os.getenv(&#39;MYVAR2&#39;)        # Should print None.</span>

<span class="sd">    CREDIT: https://github.com/sakurai-youhei/envcontext</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_envs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_envs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_envs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_envs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span></div>



<span class="c1"># This should be the go-to exception for CIME use. It&#39;s a subclass</span>
<span class="c1"># of SystemExit in order suppress tracebacks, which users generally</span>
<span class="c1"># hate seeing. It&#39;s a subclass of Exception because we want it to be</span>
<span class="c1"># &quot;catchable&quot;. If you are debugging CIME and want to see the stacktrace,</span>
<span class="c1"># run your CIME command with the --debug flag.</span>
<div class="viewcode-block" id="CIMEError">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.CIMEError">[docs]</a>
<span class="k">class</span> <span class="nc">CIMEError</span><span class="p">(</span><span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="expect">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.expect">[docs]</a>
<span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_type</span><span class="o">=</span><span class="n">CIMEError</span><span class="p">,</span> <span class="n">error_prefix</span><span class="o">=</span><span class="s2">&quot;ERROR:&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similar to assert except doesn&#39;t generate an ugly stacktrace. Useful for</span>
<span class="sd">    checking user error, not programming error.</span>

<span class="sd">    &gt;&gt;&gt; expect(True, &quot;error1&quot;)</span>
<span class="sd">    &gt;&gt;&gt; expect(False, &quot;error2&quot;) # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    CIMEError: ERROR: error2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Without this line we get a futurewarning on the use of condition below</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">pdb</span>

            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>  <span class="c1"># pylint: disable=forgotten-debug-statement</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">error_prefix</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">error_msg</span>
        <span class="k">raise</span> <span class="n">exc_type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="id_generator">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.id_generator">[docs]</a>
<span class="k">def</span> <span class="nf">id_generator</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">chars</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">))</span></div>



<div class="viewcode-block" id="check_name">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.check_name">[docs]</a>
<span class="k">def</span> <span class="nf">check_name</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">additional_chars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fullpath</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    check for unallowed characters in name, this routine only</span>
<span class="sd">    checks the final name and does not check if path exists or is</span>
<span class="sd">    writable</span>

<span class="sd">    &gt;&gt;&gt; check_name(&quot;test.id&quot;, additional_chars=&quot;.&quot;)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; check_name(&quot;case.name&quot;, fullpath=False)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; check_name(&quot;/some/file/path/case.name&quot;, fullpath=True)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; check_name(&quot;mycase+mods&quot;)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; check_name(&quot;mycase?mods&quot;)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; check_name(&quot;mycase*mods&quot;)</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; check_name(&quot;/some/full/path/name/&quot;)</span>
<span class="sd">    False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chars</span> <span class="o">=</span> <span class="s2">&quot;+*?&lt;&gt;/</span><span class="si">{}</span><span class="s2">[\]~`@:&quot;</span>  <span class="c1"># pylint: disable=anomalous-backslash-in-string</span>
    <span class="k">if</span> <span class="n">additional_chars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chars</span> <span class="o">+=</span> <span class="n">additional_chars</span>
    <span class="k">if</span> <span class="n">fullname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">fullpath</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">fullname</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Illegal character </span><span class="si">{}</span><span class="s2"> found in name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>



<span class="c1"># Should only be called from get_cime_config()</span>
<span class="k">def</span> <span class="nf">_read_cime_config_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    READ the config file in ~/.cime, this file may contain</span>
<span class="sd">    [main]</span>
<span class="sd">    CIME_MODEL=e3sm,cesm,ufs</span>
<span class="sd">    PROJECT=someprojectnumber</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed_sections</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;create_test&quot;</span><span class="p">)</span>

    <span class="n">allowed_in_main</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;cime_model&quot;</span><span class="p">,</span>
        <span class="s2">&quot;project&quot;</span><span class="p">,</span>
        <span class="s2">&quot;charge_account&quot;</span><span class="p">,</span>
        <span class="s2">&quot;srcroot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mail_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mail_user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;machine&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mpilib&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compiler&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input_dir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cime_driver&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">allowed_in_create_test</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;mail_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mail_user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_timing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;single_submit&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test_root&quot;</span><span class="p">,</span>
        <span class="s2">&quot;output_root&quot;</span><span class="p">,</span>
        <span class="s2">&quot;baseline_root&quot;</span><span class="p">,</span>
        <span class="s2">&quot;clean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;machine&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mpilib&quot;</span><span class="p">,</span>
        <span class="s2">&quot;compiler&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parallel_jobs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;proc_pool&quot;</span><span class="p">,</span>
        <span class="s2">&quot;walltime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job_queue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;allow_baseline_overwrite&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wait&quot;</span><span class="p">,</span>
        <span class="s2">&quot;force_procs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;force_threads&quot;</span><span class="p">,</span>
        <span class="s2">&quot;input_dir&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pesfile&quot;</span><span class="p">,</span>
        <span class="s2">&quot;retry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;walltime&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">cime_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="s2">&quot;.cime&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">cime_config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cime_config_file</span><span class="p">):</span>
        <span class="n">cime_config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cime_config_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="n">section</span> <span class="ow">in</span> <span class="n">allowed_sections</span><span class="p">,</span>
                <span class="s2">&quot;Unknown section </span><span class="si">{}</span><span class="s2"> in .cime/config</span><span class="se">\n</span><span class="s2">allowed sections are </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">section</span><span class="p">,</span> <span class="n">allowed_sections</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">):</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="n">item</span> <span class="ow">in</span> <span class="n">allowed_in_main</span><span class="p">,</span>
                    <span class="s1">&#39;Unknown option in config section &quot;main&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">allowed options are </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">item</span><span class="p">,</span> <span class="n">allowed_in_main</span>
                    <span class="p">),</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;create_test&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s2">&quot;create_test&quot;</span><span class="p">):</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="n">item</span> <span class="ow">in</span> <span class="n">allowed_in_create_test</span><span class="p">,</span>
                    <span class="s1">&#39;Unknown option in config section &quot;test&quot;: &quot;</span><span class="si">{}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">allowed options are </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">item</span><span class="p">,</span> <span class="n">allowed_in_create_test</span>
                    <span class="p">),</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cime_config_file</span><span class="p">))</span>
        <span class="n">cime_config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cime_config</span>


<span class="n">_CIMECONFIG</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_cime_config">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_cime_config">[docs]</a>
<span class="k">def</span> <span class="nf">get_cime_config</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_CIMECONFIG</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_CIMECONFIG</span><span class="p">:</span>
        <span class="n">_CIMECONFIG</span> <span class="o">=</span> <span class="n">_read_cime_config_file</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">_CIMECONFIG</span></div>



<div class="viewcode-block" id="reset_cime_config">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.reset_cime_config">[docs]</a>
<span class="k">def</span> <span class="nf">reset_cime_config</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Useful to keep unit tests from interfering with each other</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_CIMECONFIG</span>
    <span class="n">_CIMECONFIG</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="copy_local_macros_to_dir">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.copy_local_macros_to_dir">[docs]</a>
<span class="k">def</span> <span class="nf">copy_local_macros_to_dir</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">extra_machdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy any local macros files to the path given by &#39;destination&#39;.</span>

<span class="sd">    Local macros files are potentially found in:</span>
<span class="sd">    (1) extra_machdir/cmake_macros/*.cmake</span>
<span class="sd">    (2) $HOME/.cime/*.cmake</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">local_macros</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">extra_machdir</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extra_machdir</span><span class="p">,</span> <span class="s2">&quot;cmake_macros&quot;</span><span class="p">)):</span>
            <span class="n">local_macros</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extra_machdir</span><span class="p">,</span> <span class="s2">&quot;cmake_macros/*.cmake&quot;</span><span class="p">))</span>
            <span class="p">)</span>

    <span class="n">dotcime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HOME&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">home</span><span class="p">:</span>
        <span class="n">dotcime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;.cime&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dotcime</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dotcime</span><span class="p">):</span>
        <span class="n">local_macros</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">dotcime</span> <span class="o">+</span> <span class="s2">&quot;/*.cmake&quot;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">macro</span> <span class="ow">in</span> <span class="n">local_macros</span><span class="p">:</span>
        <span class="n">safe_copy</span><span class="p">(</span><span class="n">macro</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_python_libs_location_within_cime">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_python_libs_location_within_cime">[docs]</a>
<span class="k">def</span> <span class="nf">get_python_libs_location_within_cime</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From within CIME, return subdirectory of python libraries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;scripts&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_cime_root">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_cime_root">[docs]</a>
<span class="k">def</span> <span class="nf">get_cime_root</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the absolute path to the root of CIME that contains this script</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">real_file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">cimeroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">real_file_dir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">case_cimeroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">))</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">cimeroot</span> <span class="o">==</span> <span class="n">case_cimeroot</span><span class="p">,</span>
            <span class="s2">&quot;Inconsistent CIMEROOT variable: case -&gt; &#39;</span><span class="si">{}</span><span class="s2">&#39;, file location -&gt; &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">case_cimeroot</span><span class="p">,</span> <span class="n">cimeroot</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CIMEROOT is &quot;</span> <span class="o">+</span> <span class="n">cimeroot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cimeroot</span></div>



<div class="viewcode-block" id="get_config_path">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_config_path">[docs]</a>
<span class="k">def</span> <span class="nf">get_config_path</span><span class="p">():</span>
    <span class="n">cimeroot</span> <span class="o">=</span> <span class="n">get_cime_root</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">,</span> <span class="s2">&quot;CIME&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_schema_path">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_schema_path">[docs]</a>
<span class="k">def</span> <span class="nf">get_schema_path</span><span class="p">():</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">get_config_path</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;xml_schemas&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_template_path">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_template_path">[docs]</a>
<span class="k">def</span> <span class="nf">get_template_path</span><span class="p">():</span>
    <span class="n">cimeroot</span> <span class="o">=</span> <span class="n">get_cime_root</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">,</span> <span class="s2">&quot;CIME&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;templates&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_tools_path">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_tools_path">[docs]</a>
<span class="k">def</span> <span class="nf">get_tools_path</span><span class="p">():</span>
    <span class="n">cimeroot</span> <span class="o">=</span> <span class="n">get_cime_root</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">,</span> <span class="s2">&quot;CIME&quot;</span><span class="p">,</span> <span class="s2">&quot;Tools&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_src_root">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_src_root">[docs]</a>
<span class="k">def</span> <span class="nf">get_src_root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the absolute path to the root of SRCROOT.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cime_config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;SRCROOT&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">srcroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SRCROOT&quot;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SRCROOT from environment: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcroot</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;SRCROOT&quot;</span><span class="p">):</span>
        <span class="n">srcroot</span> <span class="o">=</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;SRCROOT&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SRCROOT from user config: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcroot</span><span class="p">))</span>
    <span class="k">elif</span> <span class="s2">&quot;SRCROOT&quot;</span> <span class="ow">in</span> <span class="n">GLOBAL</span><span class="p">:</span>
        <span class="n">srcroot</span> <span class="o">=</span> <span class="n">GLOBAL</span><span class="p">[</span><span class="s2">&quot;SRCROOT&quot;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SRCROOT from internal GLOBAL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcroot</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If the share directory exists in the CIME root then it&#39;s</span>
        <span class="c1"># assumed it&#39;s also the source root. This should only</span>
        <span class="c1"># occur when the local &quot;Externals.cfg&quot; is used to install</span>
        <span class="c1"># requirements for running/testing without a specific model.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_cime_root</span><span class="p">(),</span> <span class="s2">&quot;share&quot;</span><span class="p">)):</span>
            <span class="n">srcroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_cime_root</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">srcroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_cime_root</span><span class="p">(),</span> <span class="s2">&quot;..&quot;</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SRCROOT from implicit detection: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">srcroot</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">srcroot</span></div>



<div class="viewcode-block" id="get_cime_default_driver">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_cime_default_driver">[docs]</a>
<span class="k">def</span> <span class="nf">get_cime_default_driver</span><span class="p">():</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CIME_DRIVER&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">driver</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting CIME_DRIVER=</span><span class="si">{}</span><span class="s2"> from environment&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">driver</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cime_config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_DRIVER&quot;</span><span class="p">):</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_DRIVER&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">driver</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Setting CIME_driver=</span><span class="si">{}</span><span class="s2"> from ~/.cime/config&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="kn">from</span> <span class="nn">CIME.config</span> <span class="kn">import</span> <span class="n">Config</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">driver</span><span class="p">:</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">driver_default</span>

    <span class="n">expect</span><span class="p">(</span>
        <span class="n">driver</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">driver_choices</span><span class="p">,</span>
        <span class="s2">&quot;Attempt to set invalid driver </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">driver</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">driver</span></div>



<div class="viewcode-block" id="get_all_cime_models">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_all_cime_models">[docs]</a>
<span class="k">def</span> <span class="nf">get_all_cime_models</span><span class="p">():</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">get_config_path</span><span class="p">()</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">entry</span><span class="p">)):</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="n">models</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;xml_schemas&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">models</span></div>



<div class="viewcode-block" id="set_model">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.set_model">[docs]</a>
<span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the model to be used in this session</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cime_config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>
    <span class="n">cime_models</span> <span class="o">=</span> <span class="n">get_all_cime_models</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">):</span>
        <span class="n">cime_config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>
        <span class="n">model</span> <span class="ow">in</span> <span class="n">cime_models</span><span class="p">,</span>
        <span class="s2">&quot;model </span><span class="si">{}</span><span class="s2"> not recognized. The acceptable values of CIME_MODEL currently are </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">cime_models</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">cime_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_MODEL&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_model">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_model">[docs]</a>
<span class="k">def</span> <span class="nf">get_model</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the currently configured model value</span>
<span class="sd">    The CIME_MODEL env variable may or may not be set</span>

<span class="sd">    &gt;&gt;&gt; os.environ[&quot;CIME_MODEL&quot;] = &quot;garbage&quot;</span>
<span class="sd">    &gt;&gt;&gt; get_model() # doctest:+ELLIPSIS +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    CIMEError: ERROR: model garbage not recognized</span>
<span class="sd">    &gt;&gt;&gt; del os.environ[&quot;CIME_MODEL&quot;]</span>
<span class="sd">    &gt;&gt;&gt; set_model(&#39;rocky&#39;) # doctest:+ELLIPSIS +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    CIMEError: ERROR: model rocky not recognized</span>
<span class="sd">    &gt;&gt;&gt; set_model(&#39;e3sm&#39;)</span>
<span class="sd">    &gt;&gt;&gt; get_model()</span>
<span class="sd">    &#39;e3sm&#39;</span>
<span class="sd">    &gt;&gt;&gt; reset_cime_config()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CIME_MODEL&quot;</span><span class="p">)</span>
    <span class="n">cime_models</span> <span class="o">=</span> <span class="n">get_all_cime_models</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">cime_models</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting CIME_MODEL=</span><span class="si">{}</span><span class="s2"> from environment&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;model </span><span class="si">{}</span><span class="s2"> not recognized. The acceptable values of CIME_MODEL currently are </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">cime_models</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">cime_config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_MODEL&quot;</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_MODEL&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting CIME_MODEL=</span><span class="si">{}</span><span class="s2"> from ~/.cime/config&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

    <span class="c1"># One last try</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">srcroot</span> <span class="o">=</span> <span class="n">get_src_root</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">srcroot</span><span class="p">,</span> <span class="s2">&quot;Externals.cfg&quot;</span><span class="p">)):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;cesm&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">srcroot</span><span class="p">,</span> <span class="s2">&quot;Externals.cfg&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;ufs&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;ufs&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;e3sm&quot;</span>
        <span class="c1"># This message interfers with the correct operation of xmlquery</span>
        <span class="c1"># logger.debug(&quot;Guessing CIME_MODEL={}, set environment variable if this is incorrect&quot;.format(model))</span>

    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">set_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="n">modelroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_cime_root</span><span class="p">(),</span> <span class="s2">&quot;CIME&quot;</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">modelroot</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;.cime/config or environment variable CIME_MODEL must be set to one of: &quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">model</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modelroot</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span> <span class="ow">and</span> <span class="n">model</span> <span class="o">!=</span> <span class="s2">&quot;xml_schemas&quot;</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_get_path</span><span class="p">(</span><span class="n">filearg</span><span class="p">,</span> <span class="n">from_dir</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filearg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">from_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filearg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">from_dir</span><span class="p">,</span> <span class="n">filearg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filearg</span>


<span class="k">def</span> <span class="nf">_convert_to_fd</span><span class="p">(</span><span class="n">filearg</span><span class="p">,</span> <span class="n">from_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
    <span class="n">filearg</span> <span class="o">=</span> <span class="n">_get_path</span><span class="p">(</span><span class="n">filearg</span><span class="p">,</span> <span class="n">from_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">filearg</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>


<span class="n">_hack</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_line_defines_python_function</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if the given line defines the function &#39;funcname&#39; as a top-level definition</span>

<span class="sd">    (&quot;top-level definition&quot; means: not something like a class method; i.e., the def should</span>
<span class="sd">    be at the start of the line, not indented)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^def\s+</span><span class="si">{}</span><span class="s2">\s*\(&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">funcname</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^from\s.+\simport.*\s</span><span class="si">{}</span><span class="s2">(?:,|\s|$)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">funcname</span><span class="p">),</span> <span class="n">line</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="file_contains_python_function">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.file_contains_python_function">[docs]</a>
<span class="k">def</span> <span class="nf">file_contains_python_function</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks whether the given file contains a top-level definition of the function &#39;funcname&#39;</span>

<span class="sd">    Returns a boolean value (True if the file contains this function definition, False otherwise)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">has_function</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_line_defines_python_function</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
                <span class="n">has_function</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">has_function</span></div>



<div class="viewcode-block" id="fixup_sys_path">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.fixup_sys_path">[docs]</a>
<span class="k">def</span> <span class="nf">fixup_sys_path</span><span class="p">(</span><span class="o">*</span><span class="n">additional_paths</span><span class="p">):</span>
    <span class="n">cimeroot</span> <span class="o">=</span> <span class="n">get_cime_root</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">cimeroot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cimeroot</span><span class="p">)</span>

    <span class="n">tools_path</span> <span class="o">=</span> <span class="n">get_tools_path</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tools_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tools_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tools_path</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">additional_paths</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>



<div class="viewcode-block" id="import_and_run_sub_or_cmd">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.import_and_run_sub_or_cmd">[docs]</a>
<span class="k">def</span> <span class="nf">import_and_run_sub_or_cmd</span><span class="p">(</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="n">cmdargs</span><span class="p">,</span>
    <span class="n">subname</span><span class="p">,</span>
    <span class="n">subargs</span><span class="p">,</span>
    <span class="n">config_dir</span><span class="p">,</span>
    <span class="n">compname</span><span class="p">,</span>
    <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">from_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">sys_path_old</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
    <span class="c1"># ensure we provide `get_src_root()` and `get_tools_path()` to sys.path</span>
    <span class="c1"># allowing imported modules to correctly import `CIME` module or any</span>
    <span class="c1"># tool under `CIME/Tools`.</span>
    <span class="n">fixup_sys_path</span><span class="p">(</span><span class="n">config_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">compname</span><span class="si">}</span><span class="s2">_cime_py&quot;</span><span class="p">)</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">subname</span><span class="p">)(</span><span class="o">*</span><span class="n">subargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ModuleNotFoundError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># * ModuleNotFoundError if importlib can not find module,</span>
        <span class="c1"># * AttributeError if importlib finds the module but</span>
        <span class="c1">#   {subname} is not defined in the module</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
            <span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">subname</span><span class="si">}</span><span class="s2"> file for component </span><span class="si">{</span><span class="n">compname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># TODO shouldn&#39;t need to use logger.isEnabledFor for debug logging</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">)</span> <span class="ow">and</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: Could not import module &#39;</span><span class="si">{}</span><span class="s2">_cime_py&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compname</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">run_sub_or_cmd</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">cmdargs</span><span class="p">,</span> <span class="n">subname</span><span class="p">,</span> <span class="n">subargs</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">from_dir</span><span class="p">,</span> <span class="n">timeout</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e1</span> <span class="kn">from</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_fd</span><span class="p">:</span>
                <span class="n">log_fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> FAILED, cat </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">logfile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sys_path_old</span></div>



<div class="viewcode-block" id="run_sub_or_cmd">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.run_sub_or_cmd">[docs]</a>
<span class="k">def</span> <span class="nf">run_sub_or_cmd</span><span class="p">(</span>
    <span class="n">cmd</span><span class="p">,</span> <span class="n">cmdargs</span><span class="p">,</span> <span class="n">subname</span><span class="p">,</span> <span class="n">subargs</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This code will try to import and run each cmd as a subroutine</span>
<span class="sd">    if that fails it will run it as a program in a seperate shell</span>

<span class="sd">    Raises exception on failure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_contains_python_function</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">subname</span><span class="p">):</span>
        <span class="n">do_run_cmd</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">do_run_cmd</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">do_run_cmd</span><span class="p">:</span>
        <span class="c1"># ensure we provide `get_src_root()` and `get_tools_path()` to sys.path</span>
        <span class="c1"># allowing imported modules to correctly import `CIME` module or any</span>
        <span class="c1"># tool under `CIME/Tools`.</span>
        <span class="n">fixup_sys_path</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">import_from_file</span><span class="p">(</span><span class="n">subname</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Calling </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="c1"># Careful: logfile code is not thread safe!</span>
            <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_fd</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">redirect_logger</span><span class="p">(</span><span class="n">log_fd</span><span class="p">,</span> <span class="n">subname</span><span class="p">):</span>
                        <span class="k">with</span> <span class="n">redirect_stdout_stderr</span><span class="p">(</span><span class="n">log_fd</span><span class="p">):</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">subname</span><span class="p">)(</span><span class="o">*</span><span class="n">subargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">subname</span><span class="p">)(</span><span class="o">*</span><span class="n">subargs</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Need to try to run as shell command</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">log_fd</span><span class="p">:</span>
                    <span class="n">log_fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> FAILED, cat </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">logfile</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Running as python function worked, we&#39;re done</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;   Running </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">case</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">fullcmd</span> <span class="o">=</span> <span class="n">cmd</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmdargs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmdargs</span><span class="p">:</span>
            <span class="n">fullcmd</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fullcmd</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">cmdargs</span>

    <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
        <span class="n">fullcmd</span> <span class="o">+=</span> <span class="s2">&quot; &gt;&amp; </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>

    <span class="n">stat</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullcmd</span><span class="p">),</span> <span class="n">combine_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">from_dir</span><span class="o">=</span><span class="n">from_dir</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>  <span class="c1"># Will be empty if logfile</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> FAILED, cat </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullcmd</span><span class="p">,</span> <span class="n">logfile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> FAILED, see above&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullcmd</span><span class="p">))</span>

    <span class="c1"># refresh case xml object from file</span>
    <span class="k">if</span> <span class="n">case</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">case</span><span class="o">.</span><span class="n">read_xml</span><span class="p">()</span></div>



<div class="viewcode-block" id="run_cmd">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.run_cmd">[docs]</a>
<span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="n">input_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">from_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">arg_stdout</span><span class="o">=</span><span class="n">_hack</span><span class="p">,</span>
    <span class="n">arg_stderr</span><span class="o">=</span><span class="n">_hack</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">combine_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper around subprocess to make it much more convenient to run shell commands</span>

<span class="sd">    &gt;&gt;&gt; run_cmd(&#39;ls file_i_hope_doesnt_exist&#39;)[0] != 0</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>  <span class="c1"># Not safe to do globally, module not available in older pythons</span>

    <span class="c1"># Real defaults for these value should be subprocess.PIPE</span>
    <span class="k">if</span> <span class="n">arg_stdout</span> <span class="ow">is</span> <span class="n">_hack</span><span class="p">:</span>
        <span class="n">arg_stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_stdout</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">arg_stdout</span> <span class="o">=</span> <span class="n">_convert_to_fd</span><span class="p">(</span><span class="n">arg_stdout</span><span class="p">,</span> <span class="n">from_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">arg_stderr</span> <span class="ow">is</span> <span class="n">_hack</span><span class="p">:</span>
        <span class="n">arg_stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span> <span class="k">if</span> <span class="n">combine_output</span> <span class="k">else</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_stderr</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">arg_stderr</span> <span class="o">=</span> <span class="n">_convert_to_fd</span><span class="p">(</span><span class="n">arg_stdout</span><span class="p">,</span> <span class="n">from_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;RUN: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">FROM: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="k">if</span> <span class="n">from_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">from_dir</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">input_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stdin</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">shell</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="c1"># ensure we have an environment to use if not being over written by parent</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># persist current environment</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Always provide these variables for anything called externally.</span>
    <span class="c1"># `CIMEROOT` is provided for external scripts, makefiles, etc that</span>
    <span class="c1"># may reference it. `PYTHONPATH` is provided to ensure external</span>
    <span class="c1"># python can correctly import the CIME module and anything under</span>
    <span class="c1"># `CIME/tools`.</span>
    <span class="c1">#</span>
    <span class="c1"># `get_tools_path()` is provided for backwards compatibility.</span>
    <span class="c1"># External python prior to the CIME module move would use `CIMEROOT`</span>
    <span class="c1"># or build a relative path and append `sys.path` to import</span>
    <span class="c1"># `standard_script_setup`. Providing `PYTHONPATH` fixes protential</span>
    <span class="c1"># broken paths in external python.</span>
    <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;CIMEROOT&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_cime_root</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">get_cime_root</span><span class="p">()</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">get_tools_path</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">arg_stdout</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">arg_stderr</span><span class="p">,</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="n">from_dir</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">output</span><span class="p">,</span> <span class="n">errput</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">arg_stdout</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">arg_stderr</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">from_dir</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">output</span><span class="p">,</span> <span class="n">errput</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span>

    <span class="c1"># In Python3, subprocess.communicate returns bytes. We want to work with strings</span>
    <span class="c1"># as much as possible, so we convert bytes to string (which is unicode in py3) via</span>
    <span class="c1"># decode. For python2, we do NOT want to do this since decode will yield unicode</span>
    <span class="c1"># strings which are not necessarily compatible with the system&#39;s default base str type.</span>
    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">errput</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">errput</span> <span class="o">=</span> <span class="n">errput</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Always strip outputs</span>
    <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">errput</span><span class="p">:</span>
        <span class="n">errput</span> <span class="o">=</span> <span class="n">errput</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">stat</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_stdout</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
        <span class="n">arg_stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># pylint: disable=no-member</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_stderr</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg_stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">arg_stdout</span><span class="p">:</span>
        <span class="n">arg_stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># pylint: disable=no-member</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">!=</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  stat: </span><span class="si">{:d}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stat</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">output</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  output: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">errput</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  errput: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errput</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">stat</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">errput</span></div>



<div class="viewcode-block" id="run_cmd_no_fail">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.run_cmd_no_fail">[docs]</a>
<span class="k">def</span> <span class="nf">run_cmd_no_fail</span><span class="p">(</span>
    <span class="n">cmd</span><span class="p">,</span>
    <span class="n">input_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">from_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">arg_stdout</span><span class="o">=</span><span class="n">_hack</span><span class="p">,</span>
    <span class="n">arg_stderr</span><span class="o">=</span><span class="n">_hack</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">combine_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper around subprocess to make it much more convenient to run shell commands.</span>
<span class="sd">    Expects command to work. Just returns output string.</span>

<span class="sd">    &gt;&gt;&gt; run_cmd_no_fail(&#39;echo foo&#39;) == &#39;foo&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; run_cmd_no_fail(&#39;echo THE ERROR &gt;&amp;2; false&#39;) # doctest:+ELLIPSIS +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    CIMEError: ERROR: Command: &#39;echo THE ERROR &gt;&amp;2; false&#39; failed with error ...</span>

<span class="sd">    &gt;&gt;&gt; run_cmd_no_fail(&#39;grep foo&#39;, input_str=b&#39;foo&#39;) == &#39;foo&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; run_cmd_no_fail(&#39;echo THE ERROR &gt;&amp;2&#39;, combine_output=True) == &#39;THE ERROR&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">errput</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">input_str</span><span class="p">,</span>
        <span class="n">from_dir</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="n">arg_stdout</span><span class="p">,</span>
        <span class="n">arg_stderr</span><span class="p">,</span>
        <span class="n">env</span><span class="p">,</span>
        <span class="n">combine_output</span><span class="p">,</span>
        <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># If command produced no errput, put output in the exception since we</span>
        <span class="c1"># have nothing else to go on.</span>
        <span class="n">errput</span> <span class="o">=</span> <span class="n">output</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">errput</span> <span class="k">else</span> <span class="n">errput</span>
        <span class="k">if</span> <span class="n">errput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">combine_output</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_stdout</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">errput</span> <span class="o">=</span> <span class="s2">&quot;See </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_get_path</span><span class="p">(</span><span class="n">arg_stdout</span><span class="p">,</span> <span class="n">from_dir</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_stderr</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">errput</span> <span class="o">=</span> <span class="s2">&quot;See </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_get_path</span><span class="p">(</span><span class="n">arg_stderr</span><span class="p">,</span> <span class="n">from_dir</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">expect</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;Command: &#39;</span><span class="si">{}</span><span class="s2">&#39; failed with error &#39;</span><span class="si">{}</span><span class="s2">&#39; from dir &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">errput</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="k">if</span> <span class="n">from_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">from_dir</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span></div>



<div class="viewcode-block" id="normalize_case_id">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.normalize_case_id">[docs]</a>
<span class="k">def</span> <span class="nf">normalize_case_id</span><span class="p">(</span><span class="n">case_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a case_id, return it in form TESTCASE.GRID.COMPSET.PLATFORM</span>

<span class="sd">    &gt;&gt;&gt; normalize_case_id(&#39;ERT.ne16_g37.B1850C5.sandiatoss3_intel&#39;)</span>
<span class="sd">    &#39;ERT.ne16_g37.B1850C5.sandiatoss3_intel&#39;</span>
<span class="sd">    &gt;&gt;&gt; normalize_case_id(&#39;ERT.ne16_g37.B1850C5.sandiatoss3_intel.test-mod&#39;)</span>
<span class="sd">    &#39;ERT.ne16_g37.B1850C5.sandiatoss3_intel.test-mod&#39;</span>
<span class="sd">    &gt;&gt;&gt; normalize_case_id(&#39;ERT.ne16_g37.B1850C5.sandiatoss3_intel.G.20151121&#39;)</span>
<span class="sd">    &#39;ERT.ne16_g37.B1850C5.sandiatoss3_intel&#39;</span>
<span class="sd">    &gt;&gt;&gt; normalize_case_id(&#39;ERT.ne16_g37.B1850C5.sandiatoss3_intel.test-mod.G.20151121&#39;)</span>
<span class="sd">    &#39;ERT.ne16_g37.B1850C5.sandiatoss3_intel.test-mod&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sep_count</span> <span class="o">=</span> <span class="n">case_id</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>
        <span class="n">sep_count</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">sep_count</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;Case &#39;</span><span class="si">{}</span><span class="s2">&#39; needs to be in form: TESTCASE.GRID.COMPSET.PLATFORM[.TESTMOD]  or  TESTCASE.GRID.COMPSET.PLATFORM[.TESTMOD].GC.TESTID&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">case_id</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">sep_count</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">case_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">case_id</span></div>



<div class="viewcode-block" id="parse_test_name">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.parse_test_name">[docs]</a>
<span class="k">def</span> <span class="nf">parse_test_name</span><span class="p">(</span><span class="n">test_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a CIME test name TESTCASE[_CASEOPTS].GRID.COMPSET[.MACHINE_COMPILER[.TESTMODS]],</span>
<span class="sd">    return each component of the testname with machine and compiler split.</span>
<span class="sd">    Do not error if a partial testname is provided (TESTCASE or TESTCASE.GRID) instead</span>
<span class="sd">    parse and return the partial results.</span>

<span class="sd">    TESTMODS use hyphens in a special way:</span>
<span class="sd">    - A single hyphen stands for a path separator (for example, &#39;test-mods&#39; resolves to</span>
<span class="sd">      the path &#39;test/mods&#39;)</span>
<span class="sd">    - A double hyphen separates multiple test mods (for example, &#39;test-mods--other-dir-path&#39;</span>
<span class="sd">      indicates two test mods: &#39;test/mods&#39; and &#39;other/dir/path&#39;)</span>

<span class="sd">    If there are one or more TESTMODS, then the testmods component of the result will be a</span>
<span class="sd">    list, where each element of the list is one testmod, and hyphens have been replaced by</span>
<span class="sd">    slashes. (If there are no TESTMODS in this test, then the TESTMODS component of the</span>
<span class="sd">    result is None, as for other optional components.)</span>

<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, None, None, None, None, None]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS.fe12_123&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, &#39;fe12_123&#39;, None, None, None, None]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS.fe12_123.JGF&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, &#39;fe12_123&#39;, &#39;JGF&#39;, None, None, None]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS_D.fe12_123.JGF&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, [&#39;D&#39;], &#39;fe12_123&#39;, &#39;JGF&#39;, None, None, None]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS_D_P1.fe12_123.JGF&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, [&#39;D&#39;, &#39;P1&#39;], &#39;fe12_123&#39;, &#39;JGF&#39;, None, None, None]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS_D_G2.fe12_123.JGF&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, [&#39;D&#39;, &#39;G2&#39;], &#39;fe12_123&#39;, &#39;JGF&#39;, None, None, None]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;SMS_D_Ln9_Mmpi-serial.f19_g16_rx1.A&#39;)</span>
<span class="sd">    [&#39;SMS&#39;, [&#39;D&#39;, &#39;Ln9&#39;, &#39;Mmpi-serial&#39;], &#39;f19_g16_rx1&#39;, &#39;A&#39;, None, None, None]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS.fe12_123.JGF.machine_compiler&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, &#39;fe12_123&#39;, &#39;JGF&#39;, &#39;machine&#39;, &#39;compiler&#39;, None]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS.fe12_123.JGF.machine_compiler.test-mods&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, &#39;fe12_123&#39;, &#39;JGF&#39;, &#39;machine&#39;, &#39;compiler&#39;, [&#39;test/mods&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS.fe12_123.JGF.*_compiler.test-mods&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, &#39;fe12_123&#39;, &#39;JGF&#39;, None, &#39;compiler&#39;, [&#39;test/mods&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS.fe12_123.JGF.machine_*.test-mods&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, &#39;fe12_123&#39;, &#39;JGF&#39;, &#39;machine&#39;, None, [&#39;test/mods&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS.fe12_123.JGF.*_*.test-mods&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, &#39;fe12_123&#39;, &#39;JGF&#39;, None, None, [&#39;test/mods&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;ERS.fe12_123.JGF.machine_compiler.test-mods--other-dir-path--and-one-more&#39;)</span>
<span class="sd">    [&#39;ERS&#39;, None, &#39;fe12_123&#39;, &#39;JGF&#39;, &#39;machine&#39;, &#39;compiler&#39;, [&#39;test/mods&#39;, &#39;other/dir/path&#39;, &#39;and/one/more&#39;]]</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;SMS.f19_g16.2000_DATM%QI.A_XLND_SICE_SOCN_XROF_XGLC_SWAV.mach-ine_compiler.test-mods&#39;) # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    CIMEError: ERROR: Expected 4th item of &#39;SMS.f19_g16.2000_DATM%QI.A_XLND_SICE_SOCN_XROF_XGLC_SWAV.mach-ine_compiler.test-mods&#39; (&#39;A_XLND_SICE_SOCN_XROF_XGLC_SWAV&#39;) to be in form machine_compiler</span>
<span class="sd">    &gt;&gt;&gt; parse_test_name(&#39;SMS.f19_g16.2000_DATM%QI/A_XLND_SICE_SOCN_XROF_XGLC_SWAV.mach-ine_compiler.test-mods&#39;) # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    CIMEError: ERROR: Invalid compset name 2000_DATM%QI/A_XLND_SICE_SOCN_XROF_XGLC_SWAV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span>
    <span class="n">num_dots</span> <span class="o">=</span> <span class="n">test_name</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

    <span class="n">rv</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">num_dots</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">testcase_field_underscores</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">rv</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Make room for caseopts</span>
    <span class="n">rv</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">testcase_field_underscores</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">full_str</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">if</span> <span class="n">num_dots</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">check_name</span><span class="p">(</span><span class="n">rv</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="s2">&quot;Invalid compset name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rv</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

        <span class="n">expect</span><span class="p">(</span>
            <span class="n">rv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;Expected 4th item of &#39;</span><span class="si">{}</span><span class="s2">&#39; (&#39;</span><span class="si">{}</span><span class="s2">&#39;) to be in form machine_compiler&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">test_name</span><span class="p">,</span> <span class="n">rv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">rv</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="n">rv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
            <span class="n">rv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># The last element of the return value - testmods - will be a list of testmods,</span>
        <span class="c1"># built by separating the TESTMODS component on strings of double hyphens</span>
        <span class="n">testmods</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
        <span class="n">rv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">one_testmod</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">one_testmod</span> <span class="ow">in</span> <span class="n">testmods</span><span class="p">]</span>

    <span class="n">expect</span><span class="p">(</span>
        <span class="n">num_dots</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; does not look like a CIME test name, expect TESTCASE.GRID.COMPSET[.MACHINE_COMPILER[.TESTMODS]]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">test_name</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">rv</span></div>



<div class="viewcode-block" id="get_full_test_name">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_full_test_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_full_test_name</span><span class="p">(</span>
    <span class="n">partial_test</span><span class="p">,</span>
    <span class="n">caseopts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">compset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">machine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">compiler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">testmods_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">testmods_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a partial CIME test name, return in form TESTCASE.GRID.COMPSET.MACHINE_COMPILER[.TESTMODS]</span>
<span class="sd">    Use the additional args to fill out the name if needed</span>

<span class="sd">    Testmods can be provided through one of two arguments, but *not* both:</span>
<span class="sd">    - testmods_list: a list of one or more testmods (as would be returned by</span>
<span class="sd">      parse_test_name, for example)</span>
<span class="sd">    - testmods_string: a single string containing one or more testmods; if there is more</span>
<span class="sd">      than one, then they should be separated by a string of two hyphens (&#39;--&#39;)</span>

<span class="sd">    For both testmods_list and testmods_string, any slashes as path separators (&#39;/&#39;) are</span>
<span class="sd">    replaced by hyphens (&#39;-&#39;).</span>

<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS&quot;, grid=&quot;ne16_fe16&quot;, compset=&quot;JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;)</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS&quot;, caseopts=[&quot;D&quot;, &quot;P16&quot;], grid=&quot;ne16_fe16&quot;, compset=&quot;JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;)</span>
<span class="sd">    &#39;ERS_D_P16.ne16_fe16.JGF.melvin_gnu&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16&quot;, compset=&quot;JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;)</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;)</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF.melvin_gnu.mods&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;)</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu.mods&#39;</span>

<span class="sd">    testmods_list can be a single element:</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;, testmods_list=[&quot;mods/test&quot;])</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu.mods-test&#39;</span>

<span class="sd">    testmods_list can also have multiple elements, separated either by slashes or hyphens:</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;, testmods_list=[&quot;mods/test&quot;, &quot;mods2/test2/subdir2&quot;, &quot;mods3/test3/subdir3&quot;])</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu.mods-test--mods2-test2-subdir2--mods3-test3-subdir3&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;, testmods_list=[&quot;mods-test&quot;, &quot;mods2-test2-subdir2&quot;, &quot;mods3-test3-subdir3&quot;])</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu.mods-test--mods2-test2-subdir2--mods3-test3-subdir3&#39;</span>

<span class="sd">    The above testmods_list tests should also work with equivalent testmods_string arguments:</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;, testmods_string=&quot;mods/test&quot;)</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu.mods-test&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;, testmods_string=&quot;mods/test--mods2/test2/subdir2--mods3/test3/subdir3&quot;)</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu.mods-test--mods2-test2-subdir2--mods3-test3-subdir3&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;, testmods_string=&quot;mods-test--mods2-test2-subdir2--mods3-test3-subdir3&quot;)</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu.mods-test--mods2-test2-subdir2--mods3-test3-subdir3&#39;</span>

<span class="sd">    The following tests the consistency check between the test name and various optional arguments:</span>
<span class="sd">    &gt;&gt;&gt; get_full_test_name(&quot;ERS.ne16_fe16.JGF.melvin_gnu.mods-test--mods2-test2-subdir2--mods3-test3-subdir3&quot;, machine=&quot;melvin&quot;, compiler=&quot;gnu&quot;, testmods_list=[&quot;mods/test&quot;, &quot;mods2/test2/subdir2&quot;, &quot;mods3/test3/subdir3&quot;])</span>
<span class="sd">    &#39;ERS.ne16_fe16.JGF.melvin_gnu.mods-test--mods2-test2-subdir2--mods3-test3-subdir3&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">partial_testcase</span><span class="p">,</span>
        <span class="n">partial_caseopts</span><span class="p">,</span>
        <span class="n">partial_grid</span><span class="p">,</span>
        <span class="n">partial_compset</span><span class="p">,</span>
        <span class="n">partial_machine</span><span class="p">,</span>
        <span class="n">partial_compiler</span><span class="p">,</span>
        <span class="n">partial_testmods</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">parse_test_name</span><span class="p">(</span><span class="n">partial_test</span><span class="p">)</span>

    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">partial_grid</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">partial_compset</span><span class="p">,</span> <span class="n">compset</span><span class="p">,</span> <span class="s2">&quot;compset&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">partial_machine</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="s2">&quot;machine&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">partial_compiler</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="s2">&quot;compiler&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">partial_test</span>
    <span class="k">for</span> <span class="n">partial_val</span><span class="p">,</span> <span class="n">arg_val</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">partial_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Add to result based on args</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="n">arg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;Could not fill-out test name, partial string &#39;</span><span class="si">{}</span><span class="s2">&#39; had no </span><span class="si">{}</span><span class="s2"> information and you did not provide any&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">partial_test</span><span class="p">,</span> <span class="n">name</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;machine&quot;</span> <span class="ow">and</span> <span class="s2">&quot;*_&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*_&quot;</span><span class="p">,</span> <span class="n">arg_val</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;compiler&quot;</span> <span class="ow">and</span> <span class="s2">&quot;_*&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_*&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">arg_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">result</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;compiler&quot;</span> <span class="k">else</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">arg_val</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">arg_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">partial_val</span> <span class="o">!=</span> <span class="n">partial_compiler</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="n">arg_val</span> <span class="o">==</span> <span class="n">partial_val</span><span class="p">,</span>
                <span class="s2">&quot;Mismatch in field </span><span class="si">{}</span><span class="s2">, partial string &#39;</span><span class="si">{}</span><span class="s2">&#39; indicated it should be &#39;</span><span class="si">{}</span><span class="s2">&#39; but you provided &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">partial_test</span><span class="p">,</span> <span class="n">partial_val</span><span class="p">,</span> <span class="n">arg_val</span>
                <span class="p">),</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">testmods_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">testmods_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;Cannot provide both testmods_list and testmods_string&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Convert testmods_string to testmods_list; after this point, the code will work</span>
        <span class="c1"># the same regardless of whether testmods_string or testmods_list was provided.</span>
        <span class="n">testmods_list</span> <span class="o">=</span> <span class="n">testmods_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">partial_testmods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">testmods_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># No testmods for this test and that&#39;s OK</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">testmods_hyphenated</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">one_testmod</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">one_testmod</span> <span class="ow">in</span> <span class="n">testmods_list</span>
            <span class="p">]</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&quot;.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testmods_hyphenated</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">testmods_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">testmods_list</span> <span class="o">==</span> <span class="n">partial_testmods</span><span class="p">,</span>
            <span class="s2">&quot;Mismatch in field testmods, partial string &#39;</span><span class="si">{}</span><span class="s2">&#39; indicated it should be &#39;</span><span class="si">{}</span><span class="s2">&#39; but you provided &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">partial_test</span><span class="p">,</span> <span class="n">partial_testmods</span><span class="p">,</span> <span class="n">testmods_list</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">partial_caseopts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">caseopts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># No casemods for this test and that&#39;s OK</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">partial_testcase</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">partial_testcase</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">caseopts</span><span class="p">)),</span>
                <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">caseopts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">caseopts</span> <span class="o">==</span> <span class="n">partial_caseopts</span><span class="p">,</span>
            <span class="s2">&quot;Mismatch in field caseopts, partial string &#39;</span><span class="si">{}</span><span class="s2">&#39; indicated it should be &#39;</span><span class="si">{}</span><span class="s2">&#39; but you provided &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">partial_test</span><span class="p">,</span> <span class="n">partial_caseopts</span><span class="p">,</span> <span class="n">caseopts</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="get_current_branch">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_current_branch">[docs]</a>
<span class="k">def</span> <span class="nf">get_current_branch</span><span class="p">(</span><span class="n">repo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the name of the current branch for a repository</span>

<span class="sd">    &gt;&gt;&gt; if &quot;GIT_BRANCH&quot; in os.environ:</span>
<span class="sd">    ...     get_current_branch() is not None</span>
<span class="sd">    ... else:</span>
<span class="sd">    ...     os.environ[&quot;GIT_BRANCH&quot;] = &quot;foo&quot;</span>
<span class="sd">    ...     get_current_branch() == &quot;foo&quot;</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;GIT_BRANCH&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="c1"># This approach works better for Jenkins jobs because the Jenkins</span>
        <span class="c1"># git plugin does not use local tracking branches, it just checks out</span>
        <span class="c1"># to a commit</span>
        <span class="n">branch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;GIT_BRANCH&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">branch</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;origin/&quot;</span><span class="p">):</span>
            <span class="n">branch</span> <span class="o">=</span> <span class="n">branch</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;origin/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">branch</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stat</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span><span class="s2">&quot;git symbolic-ref HEAD&quot;</span><span class="p">,</span> <span class="n">from_dir</span><span class="o">=</span><span class="n">repo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;refs/heads/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_current_commit">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_current_commit">[docs]</a>
<span class="k">def</span> <span class="nf">get_current_commit</span><span class="p">(</span><span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the sha1 of the current HEAD commit</span>

<span class="sd">    &gt;&gt;&gt; get_current_commit() is not None</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span>
            <span class="s2">&quot;git describe --tags $(git log -n1 --pretty=&#39;%h&#39;)&quot;</span><span class="p">,</span> <span class="n">from_dir</span><span class="o">=</span><span class="n">repo</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rc</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span>
            <span class="s2">&quot;git rev-parse </span><span class="si">{}</span><span class="s2"> HEAD&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;--short&quot;</span> <span class="k">if</span> <span class="n">short</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">from_dir</span><span class="o">=</span><span class="n">repo</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span></div>



<div class="viewcode-block" id="get_model_config_location_within_cime">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_model_config_location_within_cime">[docs]</a>
<span class="k">def</span> <span class="nf">get_model_config_location_within_cime</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">()</span> <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">model</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_scripts_root">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_scripts_root">[docs]</a>
<span class="k">def</span> <span class="nf">get_scripts_root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get absolute path to scripts</span>

<span class="sd">    &gt;&gt;&gt; os.path.isdir(get_scripts_root())</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_cime_root</span><span class="p">(),</span> <span class="s2">&quot;scripts&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_model_config_root">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_model_config_root">[docs]</a>
<span class="k">def</span> <span class="nf">get_model_config_root</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get absolute path to model config area&quot;</span>

<span class="sd">    &gt;&gt;&gt; os.environ[&quot;CIME_MODEL&quot;] = &quot;e3sm&quot; # Set the test up don&#39;t depend on external resources</span>
<span class="sd">    &gt;&gt;&gt; os.path.isdir(get_model_config_root())</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">()</span> <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">model</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">get_cime_root</span><span class="p">(),</span> <span class="s2">&quot;CIME&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">get_model_config_location_within_cime</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="stop_buffering_output">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.stop_buffering_output">[docs]</a>
<span class="k">def</span> <span class="nf">stop_buffering_output</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All stdout, stderr will not be buffered after this is called.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONUNBUFFERED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span></div>



<div class="viewcode-block" id="start_buffering_output">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.start_buffering_output">[docs]</a>
<span class="k">def</span> <span class="nf">start_buffering_output</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All stdout, stderr will be buffered after this is called. This is python&#39;s</span>
<span class="sd">    default behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="match_any">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.match_any">[docs]</a>
<span class="k">def</span> <span class="nf">match_any</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">re_counts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return true if item matches any regex in re_counts&#39; keys. Increments</span>
<span class="sd">    count if a match was found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">regex_str</span> <span class="ow">in</span> <span class="n">re_counts</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">re_counts</span><span class="p">[</span><span class="n">regex_str</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="get_current_submodule_status">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_current_submodule_status">[docs]</a>
<span class="k">def</span> <span class="nf">get_current_submodule_status</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the sha1s of the current currently checked out commit for each submodule,</span>
<span class="sd">    along with the submodule path and the output of git describe for the SHA-1.</span>

<span class="sd">    &gt;&gt;&gt; get_current_submodule_status() is not None</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rc</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span>
        <span class="s2">&quot;git submodule status </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;--recursive&quot;</span> <span class="k">if</span> <span class="n">recursive</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="n">from_dir</span><span class="o">=</span><span class="n">repo</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span> <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span></div>



<div class="viewcode-block" id="copy_globs">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.copy_globs">[docs]</a>
<span class="k">def</span> <span class="nf">copy_globs</span><span class="p">(</span><span class="n">globs_to_copy</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">,</span> <span class="n">lid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a list of globs and copies all files to `output_directory`.</span>

<span class="sd">    Hiddens files become unhidden i.e. removing starting dot.</span>

<span class="sd">    Output filename is derviced from the basename of the input path and can</span>
<span class="sd">    be appended with the `lid`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">glob_to_copy</span> <span class="ow">in</span> <span class="n">globs_to_copy</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_to_copy</span><span class="p">):</span>
            <span class="n">item_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">item_basename</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item_basename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">lid</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">safe_copy</span><span class="p">(</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">preserve_meta</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="safe_copy">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.safe_copy">[docs]</a>
<span class="k">def</span> <span class="nf">safe_copy</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">tgt_path</span><span class="p">,</span> <span class="n">preserve_meta</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A flexbile and safe copy routine. Will try to copy file and metadata, but this</span>
<span class="sd">    can fail if the current user doesn&#39;t own the tgt file. A fallback data-only copy is</span>
<span class="sd">    attempted in this case. Works even if overwriting a read-only file.</span>

<span class="sd">    tgt_path can be a directory, src_path must be a file</span>

<span class="sd">    most of the complexity here is handling the case where the tgt_path file already</span>
<span class="sd">    exists. This problem does not exist for the tree operations so we don&#39;t need to wrap those.</span>

<span class="sd">    preserve_meta toggles if file meta-data, like permissions, should be preserved. If you are</span>
<span class="sd">    copying baseline files, you should be within a SharedArea context manager and preserve_meta</span>
<span class="sd">    should be false so that the umask set up by SharedArea can take affect regardless of the</span>
<span class="sd">    permissions of the src files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tgt_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tgt_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tgt_path</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">tgt_path</span>
    <span class="p">)</span>

    <span class="c1"># Handle pre-existing file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tgt_path</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">tgt_path</span><span class="p">)</span>
        <span class="n">owner_uid</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">st_uid</span>

        <span class="c1"># Handle read-only files if possible</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">tgt_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">owner_uid</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">():</span>
                <span class="c1"># I am the owner, make writeable</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">tgt_path</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">statlib</span><span class="o">.</span><span class="n">S_IWRITE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># I won&#39;t be able to copy this file</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot copy over file </span><span class="si">{}</span><span class="s2">, it is readonly and you are not the owner&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">tgt_path</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">owner_uid</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">():</span>
            <span class="c1"># I am the owner, copy file contents, permissions, and metadata</span>
            <span class="n">file_util</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span>
                <span class="n">src_path</span><span class="p">,</span>
                <span class="n">tgt_path</span><span class="p">,</span>
                <span class="n">preserve_mode</span><span class="o">=</span><span class="n">preserve_meta</span><span class="p">,</span>
                <span class="n">preserve_times</span><span class="o">=</span><span class="n">preserve_meta</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># I am not the owner, just copy file contents</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">tgt_path</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We are making a new file, copy file contents, permissions, and metadata.</span>
        <span class="c1"># This can fail if the underlying directory is not writable by current user.</span>
        <span class="n">file_util</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span>
            <span class="n">src_path</span><span class="p">,</span>
            <span class="n">tgt_path</span><span class="p">,</span>
            <span class="n">preserve_mode</span><span class="o">=</span><span class="n">preserve_meta</span><span class="p">,</span>
            <span class="n">preserve_times</span><span class="o">=</span><span class="n">preserve_meta</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># If src file was executable, then the tgt file should be too</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">tgt_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">st_uid</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">():</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span>
            <span class="n">tgt_path</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">statlib</span><span class="o">.</span><span class="n">S_IXUSR</span> <span class="o">|</span> <span class="n">statlib</span><span class="o">.</span><span class="n">S_IXGRP</span> <span class="o">|</span> <span class="n">statlib</span><span class="o">.</span><span class="n">S_IXOTH</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="safe_recursive_copy">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.safe_recursive_copy">[docs]</a>
<span class="k">def</span> <span class="nf">safe_recursive_copy</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">tgt_dir</span><span class="p">,</span> <span class="n">file_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copies a set of files from one dir to another. Works even if overwriting a</span>
<span class="sd">    read-only file. Files can be relative paths and the relative path will be</span>
<span class="sd">    matched on the tgt side.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">tgt_file</span> <span class="ow">in</span> <span class="n">file_map</span><span class="p">:</span>
        <span class="n">full_tgt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tgt_dir</span><span class="p">,</span> <span class="n">tgt_file</span><span class="p">)</span>
        <span class="n">full_src</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">src_file</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">src_file</span><span class="p">)</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">src_file</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_src</span><span class="p">),</span>
            <span class="s2">&quot;Source dir &#39;</span><span class="si">{}</span><span class="s2">&#39; missing file &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">src_file</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">safe_copy</span><span class="p">(</span><span class="n">full_src</span><span class="p">,</span> <span class="n">full_tgt</span><span class="p">)</span></div>



<div class="viewcode-block" id="symlink_force">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.symlink_force">[docs]</a>
<span class="k">def</span> <span class="nf">symlink_force</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">link_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes a symlink from link_name to target. Unlike the standard</span>
<span class="sd">    os.symlink, this will work even if link_name already exists (in</span>
<span class="sd">    which case link_name will be overwritten).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">link_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">link_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">link_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>



<div class="viewcode-block" id="find_proc_id">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.find_proc_id">[docs]</a>
<span class="k">def</span> <span class="nf">find_proc_id</span><span class="p">(</span><span class="n">proc_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">children_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">of_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Children implies recursive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expect</span><span class="p">(</span>
        <span class="n">proc_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">children_only</span><span class="p">,</span>
        <span class="s2">&quot;Must provide proc_name if not searching for children&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>
        <span class="ow">not</span> <span class="p">(</span><span class="n">of_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">children_only</span><span class="p">),</span>
        <span class="s2">&quot;of_parent only used with children_only&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="n">of_parent</span> <span class="k">if</span> <span class="n">of_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

    <span class="n">pgrep_cmd</span> <span class="o">=</span> <span class="s2">&quot;pgrep </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">proc_name</span> <span class="k">if</span> <span class="n">proc_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-P </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span> <span class="k">if</span> <span class="n">children_only</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">errput</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span><span class="n">pgrep_cmd</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">stat</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;pgrep failed with error: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errput</span><span class="p">))</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span>
    <span class="k">if</span> <span class="n">children_only</span><span class="p">:</span>
        <span class="n">pgrep_cmd</span> <span class="o">=</span> <span class="s2">&quot;pgrep -P </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">stat</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">errput</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span><span class="n">pgrep_cmd</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">stat</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;pgrep failed with error: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errput</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">find_proc_id</span><span class="p">(</span><span class="n">proc_name</span><span class="p">,</span> <span class="n">children_only</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">strip</span><span class="p">())))</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_timestamp">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_timestamp">[docs]</a>
<span class="k">def</span> <span class="nf">get_timestamp</span><span class="p">(</span><span class="n">timestamp_format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">,</span> <span class="n">utc_time</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a string representing the current UTC time in format: YYYYMMDD_HHMMSS</span>

<span class="sd">    The format can be changed if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">utc_time</span><span class="p">:</span>
        <span class="n">time_tuple</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time_tuple</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timestamp_format</span><span class="p">,</span> <span class="n">time_tuple</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_project">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_project">[docs]</a>
<span class="k">def</span> <span class="nf">get_project</span><span class="p">(</span><span class="n">machobj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hierarchy for choosing PROJECT:</span>
<span class="sd">    0. Command line flag to create_newcase or create_test</span>
<span class="sd">    1. Environment variable PROJECT</span>
<span class="sd">    2  Environment variable ACCOUNT  (this is for backward compatibility)</span>
<span class="sd">    3. File $HOME/.cime/config       (this is new)</span>
<span class="sd">    4  File $HOME/.cesm_proj         (this is for backward compatibility)</span>
<span class="sd">    5  config_machines.xml (if machobj provided)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PROJECT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using project from env PROJECT: &quot;</span> <span class="o">+</span> <span class="n">project</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">project</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ACCOUNT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using project from env ACCOUNT: &quot;</span> <span class="o">+</span> <span class="n">project</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">project</span>

    <span class="n">cime_config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;PROJECT&quot;</span><span class="p">):</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;PROJECT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using project from .cime/config: &quot;</span> <span class="o">+</span> <span class="n">project</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">project</span>

    <span class="n">projectfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="s2">&quot;.cesm_proj&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">projectfile</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">projectfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">myfile</span><span class="p">:</span>
                <span class="n">project</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">project</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using project from .cesm_proj: &quot;</span> <span class="o">+</span> <span class="n">project</span><span class="p">)</span>
            <span class="n">cime_config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;PROJECT&quot;</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">project</span>

    <span class="k">if</span> <span class="n">machobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;PROJECT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using project from config_machines.xml: &quot;</span> <span class="o">+</span> <span class="n">project</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">project</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No project info available&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="get_charge_account">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_charge_account">[docs]</a>
<span class="k">def</span> <span class="nf">get_charge_account</span><span class="p">(</span><span class="n">machobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hierarchy for choosing CHARGE_ACCOUNT:</span>
<span class="sd">    1. Environment variable CHARGE_ACCOUNT</span>
<span class="sd">    2. File $HOME/.cime/config</span>
<span class="sd">    3. config_machines.xml (if machobj provided)</span>
<span class="sd">    4. default to same value as PROJECT</span>

<span class="sd">    &gt;&gt;&gt; import CIME</span>
<span class="sd">    &gt;&gt;&gt; import CIME.XML.machines</span>
<span class="sd">    &gt;&gt;&gt; machobj = CIME.XML.machines.Machines(machine=&quot;theta&quot;)</span>
<span class="sd">    &gt;&gt;&gt; project = get_project(machobj)</span>
<span class="sd">    &gt;&gt;&gt; charge_account = get_charge_account(machobj, project)</span>
<span class="sd">    &gt;&gt;&gt; project == charge_account</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; os.environ[&quot;CHARGE_ACCOUNT&quot;] = &quot;ChargeAccount&quot;</span>
<span class="sd">    &gt;&gt;&gt; get_charge_account(machobj, project)</span>
<span class="sd">    &#39;ChargeAccount&#39;</span>
<span class="sd">    &gt;&gt;&gt; del os.environ[&quot;CHARGE_ACCOUNT&quot;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">charge_account</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CHARGE_ACCOUNT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">charge_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using charge_account from env CHARGE_ACCOUNT: &quot;</span> <span class="o">+</span> <span class="n">charge_account</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">charge_account</span>

    <span class="n">cime_config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CHARGE_ACCOUNT&quot;</span><span class="p">):</span>
        <span class="n">charge_account</span> <span class="o">=</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CHARGE_ACCOUNT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">charge_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using charge_account from .cime/config: &quot;</span> <span class="o">+</span> <span class="n">charge_account</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">charge_account</span>

    <span class="k">if</span> <span class="n">machobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">charge_account</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CHARGE_ACCOUNT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">charge_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Using charge_account from config_machines.xml: &quot;</span> <span class="o">+</span> <span class="n">charge_account</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">charge_account</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No charge_account info available, using value from PROJECT&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">project</span></div>



<div class="viewcode-block" id="find_files">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.find_files">[docs]</a>
<span class="k">def</span> <span class="nf">find_files</span><span class="p">(</span><span class="n">rootdir</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    recursively find all files matching a pattern</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">rootdir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="setup_standard_logging_options">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.setup_standard_logging_options">[docs]</a>
<span class="k">def</span> <span class="nf">setup_standard_logging_options</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s2">&quot;Logging options&quot;</span><span class="p">)</span>

    <span class="n">helpfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-d&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--debug&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print debug information (very verbose) to file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">helpfile</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Add additional context (time and file) to log messages&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--silent&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print only warnings and error messages&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="k">class</span> <span class="nc">_LessThanFilter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Filter</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclusive_maximum</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_LessThanFilter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_level</span> <span class="o">=</span> <span class="n">exclusive_maximum</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="c1"># non-zero return means we log this message</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_level</span> <span class="k">else</span> <span class="mi">0</span>


<div class="viewcode-block" id="configure_logging">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.configure_logging">[docs]</a>
<span class="k">def</span> <span class="nf">configure_logging</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">silent</span><span class="p">):</span>
    <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

    <span class="n">verbose_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(name)-12s</span><span class="s2"> </span><span class="si">%(levelname)-8s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Change info to go to stdout. This handle applies to INFO exclusively</span>
    <span class="n">stdout_stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">stdout_stream_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">stdout_stream_handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">_LessThanFilter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">))</span>

    <span class="c1"># Change warnings and above to go to stderr</span>
    <span class="n">stderr_stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">stderr_stream_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

    <span class="c1"># --verbose adds to the message format but does not impact the log level</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">stdout_stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">verbose_formatter</span><span class="p">)</span>
        <span class="n">stderr_stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">verbose_formatter</span><span class="p">)</span>

    <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stdout_stream_handler</span><span class="p">)</span>
    <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stderr_stream_handler</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="c1"># Set up log file to catch ALL logging records</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">debug_log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">debug_log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">verbose_formatter</span><span class="p">)</span>
        <span class="n">debug_log_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">debug_log_handler</span><span class="p">)</span>

        <span class="n">root_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">silent</span><span class="p">:</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>



<div class="viewcode-block" id="parse_args_and_handle_standard_logging_options">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.parse_args_and_handle_standard_logging_options">[docs]</a>
<span class="k">def</span> <span class="nf">parse_args_and_handle_standard_logging_options</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Guide to logging in CIME.</span>

<span class="sd">    logger.debug -&gt; Verbose/detailed output, use for debugging, off by default. Goes to a .log file</span>
<span class="sd">    logger.info -&gt; Goes to stdout (and log if --debug). Use for normal program output</span>
<span class="sd">    logger.warning -&gt; Goes to stderr (and log if --debug). Use for minor problems</span>
<span class="sd">    logger.error -&gt; Goes to stderr (and log if --debug)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># scripts_regression_tests is the only thing that should pass a None argument in parser</span>
    <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;--help&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">_check_for_invalid_args</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">configure_logging</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">silent</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">args</span></div>



<div class="viewcode-block" id="get_logging_options">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_logging_options">[docs]</a>
<span class="k">def</span> <span class="nf">get_logging_options</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use to pass same logging options as was used for current</span>
<span class="sd">    executable to subprocesses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;--debug&quot;</span>
    <span class="k">elif</span> <span class="n">root_logger</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;--silent&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>



<div class="viewcode-block" id="convert_to_type">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.convert_to_type">[docs]</a>
<span class="k">def</span> <span class="nf">convert_to_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">type_str</span><span class="p">,</span> <span class="n">vid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert value from string to another type.</span>
<span class="sd">    vid is only for generating better error messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">type_str</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">type_str</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;Entry </span><span class="si">{}</span><span class="s2"> was listed as type int but value &#39;</span><span class="si">{}</span><span class="s2">&#39; is not valid int&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">vid</span><span class="p">,</span> <span class="n">value</span>
                    <span class="p">),</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">type_str</span> <span class="o">==</span> <span class="s2">&quot;logical&quot;</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TRUE&quot;</span><span class="p">,</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Entry </span><span class="si">{}</span><span class="s2"> was listed as type logical but had val &#39;</span><span class="si">{}</span><span class="s2">&#39; instead of TRUE or FALSE&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">vid</span><span class="p">,</span> <span class="n">value</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span>

        <span class="k">elif</span> <span class="n">type_str</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;Entry </span><span class="si">{}</span><span class="s2"> was listed as type real but value &#39;</span><span class="si">{}</span><span class="s2">&#39; is not valid real&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">vid</span><span class="p">,</span> <span class="n">value</span>
                    <span class="p">),</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Unknown type &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">type_str</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">value</span></div>



<div class="viewcode-block" id="convert_to_unknown_type">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.convert_to_unknown_type">[docs]</a>
<span class="k">def</span> <span class="nf">convert_to_unknown_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert value to it&#39;s real type by probing conversions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># Attempt to convert to logical</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TRUE&quot;</span><span class="p">,</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span>

        <span class="c1"># Attempt to convert to integer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="c1"># Attempt to convert to float</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="c1"># Just treat as string</span>

    <span class="k">return</span> <span class="n">value</span></div>



<div class="viewcode-block" id="convert_to_string">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.convert_to_string">[docs]</a>
<span class="k">def</span> <span class="nf">convert_to_string</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">type_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert value back to string.</span>
<span class="sd">    vid is only for generating better error messages.</span>
<span class="sd">    &gt;&gt;&gt; convert_to_string(6, type_str=&quot;integer&quot;) == &#39;6&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; convert_to_string(&#39;6&#39;, type_str=&quot;integer&quot;) == &#39;6&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; convert_to_string(&#39;6.0&#39;, type_str=&quot;real&quot;) == &#39;6.0&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; convert_to_string(6.01, type_str=&quot;real&quot;) == &#39;6.01&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">type_str</span> <span class="o">==</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
                <span class="s2">&quot;Wrong type for entry id &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vid</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">type_str</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;Wrong type for entry id &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vid</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">type_str</span> <span class="o">==</span> <span class="s2">&quot;logical&quot;</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">,</span> <span class="s2">&quot;Wrong type for entry id &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vid</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span>
        <span class="k">elif</span> <span class="n">type_str</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">,</span> <span class="s2">&quot;Wrong type for entry id &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vid</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Unknown type &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">type_str</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempt to convert None value for vid </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">value</span></div>



<div class="viewcode-block" id="convert_to_seconds">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.convert_to_seconds">[docs]</a>
<span class="k">def</span> <span class="nf">convert_to_seconds</span><span class="p">(</span><span class="n">time_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert time value in [[HH:]MM:]SS to seconds</span>

<span class="sd">    We assume that XX:YY is likely to be HH:MM, not MM:SS</span>

<span class="sd">    &gt;&gt;&gt; convert_to_seconds(&quot;42&quot;)</span>
<span class="sd">    42</span>
<span class="sd">    &gt;&gt;&gt; convert_to_seconds(&quot;01:01:01&quot;)</span>
<span class="sd">    3661</span>
<span class="sd">    &gt;&gt;&gt; convert_to_seconds(&quot;01:01&quot;)</span>
<span class="sd">    3660</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">time_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Unusual time string: &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_str</span><span class="p">))</span>

    <span class="n">components</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">starting_exp</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">component</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">component</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">starting_exp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="convert_to_babylonian_time">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.convert_to_babylonian_time">[docs]</a>
<span class="k">def</span> <span class="nf">convert_to_babylonian_time</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert time value to seconds to HH:MM:SS</span>

<span class="sd">    &gt;&gt;&gt; convert_to_babylonian_time(3661)</span>
<span class="sd">    &#39;01:01:01&#39;</span>
<span class="sd">    &gt;&gt;&gt; convert_to_babylonian_time(360000)</span>
<span class="sd">    &#39;100:00:00&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="n">seconds</span> <span class="o">%=</span> <span class="mi">3600</span>
    <span class="n">minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">seconds</span> <span class="o">%=</span> <span class="mi">60</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">:</span><span class="si">{:02d}</span><span class="s2">:</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_time_in_seconds">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_time_in_seconds">[docs]</a>
<span class="k">def</span> <span class="nf">get_time_in_seconds</span><span class="p">(</span><span class="n">timeval</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a time from &#39;unit&#39; to seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;nyear&quot;</span> <span class="ow">in</span> <span class="n">unit</span><span class="p">:</span>
        <span class="n">dmult</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
    <span class="k">elif</span> <span class="s2">&quot;nmonth&quot;</span> <span class="ow">in</span> <span class="n">unit</span><span class="p">:</span>
        <span class="n">dmult</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
    <span class="k">elif</span> <span class="s2">&quot;nday&quot;</span> <span class="ow">in</span> <span class="n">unit</span><span class="p">:</span>
        <span class="n">dmult</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span>
    <span class="k">elif</span> <span class="s2">&quot;nhour&quot;</span> <span class="ow">in</span> <span class="n">unit</span><span class="p">:</span>
        <span class="n">dmult</span> <span class="o">=</span> <span class="mi">3600</span>
    <span class="k">elif</span> <span class="s2">&quot;nminute&quot;</span> <span class="ow">in</span> <span class="n">unit</span><span class="p">:</span>
        <span class="n">dmult</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dmult</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">dmult</span> <span class="o">*</span> <span class="n">timeval</span></div>



<div class="viewcode-block" id="compute_total_time">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.compute_total_time">[docs]</a>
<span class="k">def</span> <span class="nf">compute_total_time</span><span class="p">(</span><span class="n">job_cost_map</span><span class="p">,</span> <span class="n">proc_pool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a map: jobname -&gt; (procs, est-time), return a total time</span>
<span class="sd">    estimate for a given processor pool size</span>

<span class="sd">    &gt;&gt;&gt; job_cost_map = {&quot;A&quot; : (4, 3000), &quot;B&quot; : (2, 1000), &quot;C&quot; : (8, 2000), &quot;D&quot; : (1, 800)}</span>
<span class="sd">    &gt;&gt;&gt; compute_total_time(job_cost_map, 8)</span>
<span class="sd">    5160</span>
<span class="sd">    &gt;&gt;&gt; compute_total_time(job_cost_map, 12)</span>
<span class="sd">    3180</span>
<span class="sd">    &gt;&gt;&gt; compute_total_time(job_cost_map, 16)</span>
<span class="sd">    3060</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">waiting_jobs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">job_cost_map</span><span class="p">)</span>
    <span class="n">running_jobs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># name -&gt; (procs, est-time, start-time)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">waiting_jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">running_jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">launched_jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">waiting_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">procs_for_job</span><span class="p">,</span> <span class="n">time_for_job</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">if</span> <span class="n">procs_for_job</span> <span class="o">&lt;=</span> <span class="n">proc_pool</span><span class="p">:</span>
                <span class="n">proc_pool</span> <span class="o">-=</span> <span class="n">procs_for_job</span>
                <span class="n">launched_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobname</span><span class="p">)</span>
                <span class="n">running_jobs</span><span class="p">[</span><span class="n">jobname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">procs_for_job</span><span class="p">,</span> <span class="n">time_for_job</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">launched_job</span> <span class="ow">in</span> <span class="n">launched_jobs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">waiting_jobs</span><span class="p">[</span><span class="n">launched_job</span><span class="p">]</span>

        <span class="n">completed_jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">running_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">procs_for_job</span><span class="p">,</span> <span class="n">time_for_job</span><span class="p">,</span> <span class="n">time_started</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">current_time</span> <span class="o">-</span> <span class="n">time_started</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">time_for_job</span><span class="p">:</span>
                <span class="n">proc_pool</span> <span class="o">+=</span> <span class="n">procs_for_job</span>
                <span class="n">completed_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobname</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">completed_job</span> <span class="ow">in</span> <span class="n">completed_jobs</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">running_jobs</span><span class="p">[</span><span class="n">completed_job</span><span class="p">]</span>

        <span class="n">current_time</span> <span class="o">+=</span> <span class="mi">60</span>  <span class="c1"># minute time step</span>

    <span class="k">return</span> <span class="n">current_time</span></div>



<div class="viewcode-block" id="format_time">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.format_time">[docs]</a>
<span class="k">def</span> <span class="nf">format_time</span><span class="p">(</span><span class="n">time_format</span><span class="p">,</span> <span class="n">input_format</span><span class="p">,</span> <span class="n">input_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the string input_time from input_format to time_format</span>
<span class="sd">    Valid format specifiers are &quot;%H&quot;, &quot;%M&quot;, and &quot;%S&quot;</span>
<span class="sd">    % signs must be followed by an H, M, or S and then a separator</span>
<span class="sd">    Separators can be any string without digits or a % sign</span>
<span class="sd">    Each specifier can occur more than once in the input_format,</span>
<span class="sd">    but only the first occurence will be used.</span>
<span class="sd">    An example of a valid format: &quot;%H:%M:%S&quot;</span>
<span class="sd">    Unlike strptime, this does support %H &gt;= 24</span>

<span class="sd">    &gt;&gt;&gt; format_time(&quot;%H:%M:%S&quot;, &quot;%H&quot;, &quot;43&quot;)</span>
<span class="sd">    &#39;43:00:00&#39;</span>
<span class="sd">    &gt;&gt;&gt; format_time(&quot;%H  %M&quot;, &quot;%M,%S&quot;, &quot;59,59&quot;)</span>
<span class="sd">    &#39;0  59&#39;</span>
<span class="sd">    &gt;&gt;&gt; format_time(&quot;%H, %S&quot;, &quot;%H:%M:%S&quot;, &quot;2:43:9&quot;)</span>
<span class="sd">    &#39;2, 09&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_fields</span> <span class="o">=</span> <span class="n">input_format</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span>
        <span class="n">input_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_time</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span>
        <span class="s2">&quot;Failed to parse the input time &#39;</span><span class="si">{}</span><span class="s2">&#39;; does not match the header string &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">input_time</span><span class="p">,</span> <span class="n">input_format</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">input_time</span> <span class="o">=</span> <span class="n">input_time</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">input_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">:]</span>
    <span class="n">timespec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">maxvals</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">}</span>
    <span class="n">DIGIT_CHECK</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[^0-9]*&quot;</span><span class="p">)</span>
    <span class="c1"># Loop invariants given input follows the specs:</span>
    <span class="c1"># field starts with H, M, or S</span>
    <span class="c1"># input_time starts with a number corresponding with the start of field</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">input_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="c1"># Find all of the digits at the start of the string</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d*&quot;</span><span class="p">,</span> <span class="n">input_time</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">value_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;Failed to parse the input time for the &#39;</span><span class="si">{}</span><span class="s2">&#39; specifier, expected an integer&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">spec</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value_re</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">spec</span> <span class="ow">in</span> <span class="n">timespec</span><span class="p">,</span> <span class="s2">&quot;Unknown time specifier &#39;&quot;</span> <span class="o">+</span> <span class="n">spec</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># Don&#39;t do anything if the time field is already specified</span>
        <span class="k">if</span> <span class="n">timespec</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Verify we aren&#39;t exceeding the maximum value</span>
            <span class="k">if</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">maxvals</span><span class="p">:</span>
                <span class="n">expect</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxvals</span><span class="p">[</span><span class="n">spec</span><span class="p">],</span>
                    <span class="s2">&quot;Failed to parse the &#39;</span><span class="si">{}</span><span class="s2">&#39; specifier: A value less than </span><span class="si">{:d}</span><span class="s2"> is expected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">spec</span><span class="p">,</span> <span class="n">maxvals</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="n">timespec</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">input_time</span> <span class="o">=</span> <span class="n">input_time</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">:]</span>
        <span class="c1"># Check for the separator string</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">DIGIT_CHECK</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="p">),</span>
            <span class="s2">&quot;Numbers are not permissible in separator strings&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">input_time</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
            <span class="s2">&quot;The separator string (</span><span class="si">{}</span><span class="s2">) doesn&#39;t match &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">input_time</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">input_time</span> <span class="o">=</span> <span class="n">input_time</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:]</span>
    <span class="n">output_fields</span> <span class="o">=</span> <span class="n">time_format</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>
    <span class="n">output_time</span> <span class="o">=</span> <span class="n">output_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Used when a value isn&#39;t given</span>
    <span class="n">min_len_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="c1"># Loop invariants given input follows the specs:</span>
    <span class="c1"># field starts with H, M, or S</span>
    <span class="c1"># output_time</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">output_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="n">field</span> <span class="o">==</span> <span class="n">output_fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;Separator strings are required to properly parse times&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">spec</span> <span class="ow">in</span> <span class="n">timespec</span><span class="p">,</span> <span class="s2">&quot;Unknown time specifier &#39;&quot;</span> <span class="o">+</span> <span class="n">spec</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timespec</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_time</span> <span class="o">+=</span> <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">min_len_spec</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">timespec</span><span class="p">[</span><span class="n">spec</span><span class="p">]))</span>
            <span class="n">output_time</span> <span class="o">+=</span> <span class="n">timespec</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_time</span> <span class="o">+=</span> <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="n">min_len_spec</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span>
        <span class="n">output_time</span> <span class="o">+=</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">output_time</span></div>



<div class="viewcode-block" id="append_status">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.append_status">[docs]</a>
<span class="k">def</span> <span class="nf">append_status</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sfile</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append msg to sfile in caseroot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S: &quot;</span><span class="p">)</span>

    <span class="c1"># Reduce empty lines in CaseStatus. It&#39;s a very concise file</span>
    <span class="c1"># and does not need extra newlines for readability</span>
    <span class="n">line_ending</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">caseroot</span><span class="p">,</span> <span class="n">sfile</span><span class="p">),</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ctime</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="n">line_ending</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; ---------------------------------------------------&quot;</span> <span class="o">+</span> <span class="n">line_ending</span><span class="p">)</span></div>



<div class="viewcode-block" id="append_testlog">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.append_testlog">[docs]</a>
<span class="k">def</span> <span class="nf">append_testlog</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add to TestStatus.log file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">append_status</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;TestStatus.log&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="p">)</span></div>



<div class="viewcode-block" id="append_case_status">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.append_case_status">[docs]</a>
<span class="k">def</span> <span class="nf">append_case_status</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update CaseStatus file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">append_status</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;CaseStatus&quot;</span><span class="p">,</span>
        <span class="n">caseroot</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="does_file_have_string">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.does_file_have_string">[docs]</a>
<span class="k">def</span> <span class="nf">does_file_have_string</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Does the text string appear in the filepath file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>



<div class="viewcode-block" id="is_last_process_complete">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.is_last_process_complete">[docs]</a>
<span class="k">def</span> <span class="nf">is_last_process_complete</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">expect_text</span><span class="p">,</span> <span class="n">fail_text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search the filepath in reverse order looking for expect_text</span>
<span class="sd">    before finding fail_text. This utility is used by archive_metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">complete</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">fb</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">rfb</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">fb</span><span class="p">))</span>

    <span class="n">findex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fail_text</span><span class="p">,</span> <span class="n">rfb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">findex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">findex</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">findex</span> <span class="o">=</span> <span class="n">findex</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">eindex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expect_text</span><span class="p">,</span> <span class="n">rfb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eindex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eindex</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eindex</span> <span class="o">=</span> <span class="n">eindex</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">findex</span> <span class="o">&gt;</span> <span class="n">eindex</span><span class="p">:</span>
        <span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">complete</span></div>



<div class="viewcode-block" id="transform_vars">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.transform_vars">[docs]</a>
<span class="k">def</span> <span class="nf">transform_vars</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do the variable substitution for any variables that need transforms</span>
<span class="sd">    recursively.</span>

<span class="sd">    &gt;&gt;&gt; transform_vars(&quot;{{ cesm_stdout }}&quot;, default=&quot;cesm.stdout&quot;)</span>
<span class="sd">    &#39;cesm.stdout&#39;</span>
<span class="sd">    &gt;&gt;&gt; member_store = lambda : None</span>
<span class="sd">    &gt;&gt;&gt; member_store.foo = &quot;hi&quot;</span>
<span class="sd">    &gt;&gt;&gt; transform_vars(&quot;I say {{ foo }}&quot;, overrides={&quot;foo&quot;:&quot;hi&quot;})</span>
<span class="sd">    &#39;I say hi&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">directive_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;{{ (\w+) }}&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="c1"># loop through directive text, replacing each string enclosed with</span>
    <span class="c1"># template characters with the necessary values.</span>
    <span class="k">while</span> <span class="n">directive_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">directive_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">whole_match</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">overrides</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">overrides</span>
            <span class="ow">and</span> <span class="n">overrides</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">repl</span> <span class="o">=</span> <span class="n">overrides</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;from overrides: in </span><span class="si">{}</span><span class="s2">, replacing </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">,</span> <span class="n">whole_match</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">repl</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">whole_match</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">repl</span><span class="p">))</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">case</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">repl</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;from case members: in </span><span class="si">{}</span><span class="s2">, replacing </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">,</span> <span class="n">whole_match</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">repl</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">whole_match</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">repl</span><span class="p">))</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">case</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">subgroup</span><span class="o">=</span><span class="n">subgroup</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">repl</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">subgroup</span><span class="o">=</span><span class="n">subgroup</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;from case: in </span><span class="si">{}</span><span class="s2">, replacing </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">,</span> <span class="n">whole_match</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">repl</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">whole_match</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">repl</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;from default: in </span><span class="si">{}</span><span class="s2">, replacing </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">,</span> <span class="n">whole_match</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">whole_match</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no queue exists, then the directive &#39;-q&#39; by itself will cause an error</span>
            <span class="k">if</span> <span class="s2">&quot;-q {{ queue }}&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not replace variable &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">whole_match</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">text</span></div>



<div class="viewcode-block" id="wait_for_unlocked">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.wait_for_unlocked">[docs]</a>
<span class="k">def</span> <span class="nf">wait_for_unlocked</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="n">locked</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">file_object</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">locked</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="c1"># Opening file in append mode and read the first 8 characters.</span>
            <span class="n">file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_object</span><span class="p">:</span>
                <span class="n">locked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">locked</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_object</span><span class="p">:</span>
                <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="gunzip_existing_file">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.gunzip_existing_file">[docs]</a>
<span class="k">def</span> <span class="nf">gunzip_existing_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>



<div class="viewcode-block" id="gzip_existing_file">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.gzip_existing_file">[docs]</a>
<span class="k">def</span> <span class="nf">gzip_existing_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gzips an existing file, removes the unzipped version, returns path to zip file.</span>
<span class="sd">    Note the that the timestamp of the original file will be maintained in</span>
<span class="sd">    the zipped file.</span>

<span class="sd">    &gt;&gt;&gt; import tempfile</span>
<span class="sd">    &gt;&gt;&gt; fd, filename = tempfile.mkstemp(text=True)</span>
<span class="sd">    &gt;&gt;&gt; _ = os.write(fd, b&quot;Hello World&quot;)</span>
<span class="sd">    &gt;&gt;&gt; os.close(fd)</span>
<span class="sd">    &gt;&gt;&gt; gzfile = gzip_existing_file(filename)</span>
<span class="sd">    &gt;&gt;&gt; gunzip_existing_file(gzfile) == b&#39;Hello World&#39;</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; os.remove(gzfile)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does not exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>

    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">orig_atime</span><span class="p">,</span> <span class="n">orig_mtime</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="n">statlib</span><span class="o">.</span><span class="n">ST_ATIME</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="n">statlib</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">]</span>

    <span class="n">gzpath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.gz&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gzpath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">f_in</span><span class="p">,</span> <span class="n">f_out</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">gzpath</span><span class="p">,</span> <span class="p">(</span><span class="n">orig_atime</span><span class="p">,</span> <span class="n">orig_mtime</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">gzpath</span></div>



<div class="viewcode-block" id="touch">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.touch">[docs]</a>
<span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="find_system_test">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.find_system_test">[docs]</a>
<span class="k">def</span> <span class="nf">find_system_test</span><span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find and import the test matching testname</span>
<span class="sd">    Look through the paths set in config_files.xml variable SYSTEM_TESTS_DIR</span>
<span class="sd">    for components used in this case to find a test matching testname.  Add the</span>
<span class="sd">    path to that directory to sys.path if its not there and return the test object</span>
<span class="sd">    Fail if the test is not found in any of the paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>

    <span class="n">system_test_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">testname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TEST&quot;</span><span class="p">):</span>
        <span class="n">system_test_path</span> <span class="o">=</span> <span class="s2">&quot;CIME.SystemTests.system_tests_common.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;any&quot;</span><span class="p">]</span>
        <span class="n">components</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">get_compset_components</span><span class="p">())</span>
        <span class="n">fdir</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">tdir</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                <span class="s2">&quot;SYSTEM_TESTS_DIR&quot;</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="n">component</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">tdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
                <span class="n">system_test_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tdir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.py&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testname</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">system_test_file</span><span class="p">):</span>
                    <span class="n">fdir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;found &quot;</span> <span class="o">+</span> <span class="n">system_test_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
                        <span class="n">system_test_path</span> <span class="o">=</span> <span class="s2">&quot;CIME.SystemTests.</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">testname</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">testname</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">system_test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">system_test_file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">system_test_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">system_test_dir</span><span class="p">)</span>
                        <span class="n">system_test_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testname</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">testname</span><span class="p">)</span>
        <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Test </span><span class="si">{}</span><span class="s2"> not found, aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>
        <span class="n">expect</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">fdir</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;Test </span><span class="si">{}</span><span class="s2"> found in multiple locations </span><span class="si">{}</span><span class="s2">, aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testname</span><span class="p">,</span> <span class="n">fdir</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">system_test_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No test </span><span class="si">{}</span><span class="s2"> found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testname</span><span class="p">))</span>

    <span class="n">path</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">system_test_path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_get_most_recent_lid_impl</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; files = [&#39;/foo/bar/e3sm.log.20160905_111212&#39;, &#39;/foo/bar/e3sm.log.20160906_111212.gz&#39;]</span>
<span class="sd">    &gt;&gt;&gt; _get_most_recent_lid_impl(files)</span>
<span class="sd">    [&#39;20160905_111212&#39;, &#39;20160906_111212&#39;]</span>
<span class="sd">    &gt;&gt;&gt; files = [&#39;/foo/bar/e3sm.log.20160905_111212&#39;, &#39;/foo/bar/e3sm.log.20160905_111212.gz&#39;]</span>
<span class="sd">    &gt;&gt;&gt; _get_most_recent_lid_impl(files)</span>
<span class="sd">    [&#39;20160905_111212&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Apparent model log file &#39;</span><span class="si">{}</span><span class="s2">&#39; did not conform to expected name format&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">item</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="p">)))</span>


<div class="viewcode-block" id="ls_sorted_by_mtime">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.ls_sorted_by_mtime">[docs]</a>
<span class="k">def</span> <span class="nf">ls_sorted_by_mtime</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;return list of path sorted by timestamp oldest first&quot;&quot;&quot;</span>
    <span class="n">mtime</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span><span class="o">.</span><span class="n">st_mtime</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">mtime</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_lids">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_lids">[docs]</a>
<span class="k">def</span> <span class="nf">get_lids</span><span class="p">(</span><span class="n">case</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MODEL&quot;</span><span class="p">)</span>
    <span class="n">rundir</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_get_most_recent_lid_impl</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.log*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">model</span><span class="p">)))</span></div>



<div class="viewcode-block" id="new_lid">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.new_lid">[docs]</a>
<span class="k">def</span> <span class="nf">new_lid</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">lid</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">batch_jobid</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">jobid</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">lid</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lid</span>
    <span class="k">return</span> <span class="n">lid</span></div>



<div class="viewcode-block" id="batch_jobid">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.batch_jobid">[docs]</a>
<span class="k">def</span> <span class="nf">batch_jobid</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">jobid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PBS_JOBID&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SLURM_JOB_ID&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LSB_JOBID&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jobid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COBALT_JOBID&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_job_id</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jobid</span></div>



<div class="viewcode-block" id="analyze_build_log">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.analyze_build_log">[docs]</a>
<span class="k">def</span> <span class="nf">analyze_build_log</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">compiler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Capture and report warning count,</span>
<span class="sd">    capture and report errors and undefined references.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warncnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="s2">&quot;intel&quot;</span> <span class="ow">in</span> <span class="n">compiler</span><span class="p">:</span>
        <span class="n">warn_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; warning #&quot;</span><span class="p">)</span>
        <span class="n">error_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; error #&quot;</span><span class="p">)</span>
        <span class="n">undefined_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; undefined reference to &quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;gnu&quot;</span> <span class="ow">in</span> <span class="n">compiler</span> <span class="ow">or</span> <span class="s2">&quot;nag&quot;</span> <span class="ow">in</span> <span class="n">compiler</span><span class="p">:</span>
        <span class="n">warn_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Warning: &quot;</span><span class="p">)</span>
        <span class="n">error_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Error: &quot;</span><span class="p">)</span>
        <span class="n">undefined_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; undefined reference to &quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># don&#39;t know enough about this compiler</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">warn_re</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">warncnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">error_re</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">undefined_re</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">warncnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Component </span><span class="si">{}</span><span class="s2"> build complete with </span><span class="si">{}</span><span class="s2"> warnings&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">warncnt</span><span class="p">)</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="is_python_executable">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.is_python_executable">[docs]</a>
<span class="k">def</span> <span class="nf">is_python_executable</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="n">first_line</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">first_line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">first_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">first_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#!&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;python&quot;</span> <span class="ow">in</span> <span class="n">first_line</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="get_umask">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_umask">[docs]</a>
<span class="k">def</span> <span class="nf">get_umask</span><span class="p">():</span>
    <span class="n">current_umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">current_umask</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">current_umask</span></div>



<div class="viewcode-block" id="stringify_bool">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.stringify_bool">[docs]</a>
<span class="k">def</span> <span class="nf">stringify_bool</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val</span>
    <span class="n">expect</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">,</span> <span class="s2">&quot;Wrong type for val &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
    <span class="k">return</span> <span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="n">val</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span></div>



<div class="viewcode-block" id="indent_string">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.indent_string">[docs]</a>
<span class="k">def</span> <span class="nf">indent_string</span><span class="p">(</span><span class="n">the_string</span><span class="p">,</span> <span class="n">indent_level</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Indents the given string by a given number of spaces</span>

<span class="sd">    Args:</span>
<span class="sd">       the_string: str</span>
<span class="sd">       indent_level: int</span>

<span class="sd">    Returns a new string that is the same as the_string, except that</span>
<span class="sd">    each line is indented by &#39;indent_level&#39; spaces.</span>

<span class="sd">    In python3, this can be done with textwrap.indent.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">the_string</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent_level</span>
    <span class="n">lines_indented</span> <span class="o">=</span> <span class="p">[</span><span class="n">padding</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines_indented</span><span class="p">)</span></div>



<div class="viewcode-block" id="verbatim_success_msg">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.verbatim_success_msg">[docs]</a>
<span class="k">def</span> <span class="nf">verbatim_success_msg</span><span class="p">(</span><span class="n">return_val</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">return_val</span></div>



<span class="n">CASE_SUCCESS</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
<span class="n">CASE_FAILURE</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>


<div class="viewcode-block" id="run_and_log_case_status">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.run_and_log_case_status">[docs]</a>
<span class="k">def</span> <span class="nf">run_and_log_case_status</span><span class="p">(</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">phase</span><span class="p">,</span>
    <span class="n">caseroot</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">custom_starting_msg_functor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">custom_success_msg_functor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">is_batch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">starting_msg</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">custom_starting_msg_functor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">starting_msg</span> <span class="o">=</span> <span class="n">custom_starting_msg_functor</span><span class="p">()</span>

    <span class="c1"># Delay appending &quot;starting&quot; on &quot;case.subsmit&quot; phase when batch system is</span>
    <span class="c1"># present since we don&#39;t have the jobid yet</span>
    <span class="k">if</span> <span class="n">phase</span> <span class="o">!=</span> <span class="s2">&quot;case.submit&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_batch</span><span class="p">:</span>
        <span class="n">append_case_status</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="s2">&quot;starting&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">starting_msg</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="n">caseroot</span><span class="p">)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">custom_success_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">custom_success_msg_functor</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">custom_success_msg_functor</span> <span class="ow">and</span> <span class="n">rv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;case.submit&quot;</span> <span class="ow">and</span> <span class="n">is_batch</span><span class="p">:</span>
            <span class="n">append_case_status</span><span class="p">(</span>
                <span class="n">phase</span><span class="p">,</span> <span class="s2">&quot;starting&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">custom_success_msg</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="n">caseroot</span>
            <span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">append_case_status</span><span class="p">(</span>
            <span class="n">phase</span><span class="p">,</span> <span class="n">CASE_FAILURE</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="n">caseroot</span><span class="o">=</span><span class="n">caseroot</span>
        <span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">custom_success_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">custom_success_msg_functor</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="k">if</span> <span class="n">custom_success_msg_functor</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;case.submit&quot;</span> <span class="ow">and</span> <span class="n">is_batch</span><span class="p">:</span>
            <span class="n">append_case_status</span><span class="p">(</span>
                <span class="n">phase</span><span class="p">,</span> <span class="s2">&quot;starting&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">custom_success_msg</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="n">caseroot</span>
            <span class="p">)</span>
        <span class="n">append_case_status</span><span class="p">(</span>
            <span class="n">phase</span><span class="p">,</span> <span class="n">CASE_SUCCESS</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">custom_success_msg</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="n">caseroot</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">rv</span></div>



<span class="k">def</span> <span class="nf">_check_for_invalid_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># Prevent circular import</span>
    <span class="kn">from</span> <span class="nn">CIME.config</span> <span class="kn">import</span> <span class="n">Config</span>

    <span class="c1"># TODO Is this really model specific</span>
    <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">check_invalid_args</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># if arg contains a space then it was originally quoted and we can ignore it here.</span>
            <span class="k">if</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">arg</span> <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;WARNING: The </span><span class="si">{}</span><span class="s1"> argument is deprecated. Multi-character arguments should begin with &quot;--&quot; and single character with &quot;-&quot;</span><span class="se">\n</span><span class="s1">  Use --help for a complete list of available options</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">arg</span>
                    <span class="p">)</span>
                <span class="p">)</span>


<div class="viewcode-block" id="add_mail_type_args">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.add_mail_type_args">[docs]</a>
<span class="k">def</span> <span class="nf">add_mail_type_args</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mail-user&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Email to be used for batch notification.&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-M&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--mail-type&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;When to send user email. Options are: never, all, begin, end, fail.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;You can specify multiple types with either comma-separated args or multiple -M flags.&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="resolve_mail_type_args">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.resolve_mail_type_args">[docs]</a>
<span class="k">def</span> <span class="nf">resolve_mail_type_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mail_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resolved_mail_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mail_type</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">mail_type</span><span class="p">:</span>
            <span class="n">resolved_mail_types</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mail_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">mail_type</span> <span class="ow">in</span> <span class="n">resolved_mail_types</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span>
                <span class="n">mail_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;never&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;begin&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">),</span>
                <span class="s2">&quot;Unsupported mail-type &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mail_type</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">args</span><span class="o">.</span><span class="n">mail_type</span> <span class="o">=</span> <span class="n">resolved_mail_types</span></div>



<div class="viewcode-block" id="copyifnewer">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.copyifnewer">[docs]</a>
<span class="k">def</span> <span class="nf">copyifnewer</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;if dest does not exist or is older than src copy src to dest&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="n">safe_copy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span></div>



<div class="viewcode-block" id="SharedArea">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.SharedArea">[docs]</a>
<span class="k">class</span> <span class="nc">SharedArea</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enable 0002 umask within this manager</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_perms</span><span class="o">=</span><span class="mo">0o002</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_umask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_perms</span> <span class="o">=</span> <span class="n">new_perms</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_perms</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orig_umask</span><span class="p">)</span></div>



<div class="viewcode-block" id="Timeout">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.Timeout">[docs]</a>
<span class="k">class</span> <span class="nc">Timeout</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A context manager that implements a timeout. By default, it</span>
<span class="sd">    will raise exception, but a custon function call can be provided.</span>
<span class="sd">    Provided None as seconds makes this class a no-op</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="o">=</span> <span class="n">seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action</span> <span class="o">=</span> <span class="n">action</span> <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_timeout</span>

    <span class="k">def</span> <span class="nf">_handle_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Timeout expired&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="filter_unicode">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.filter_unicode">[docs]</a>
<span class="k">def</span> <span class="nf">filter_unicode</span><span class="p">(</span><span class="n">unistr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sometimes unicode chars can cause problems</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">128</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unistr</span><span class="p">])</span></div>



<div class="viewcode-block" id="run_bld_cmd_ensure_logging">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.run_bld_cmd_ensure_logging">[docs]</a>
<span class="k">def</span> <span class="nf">run_bld_cmd_ensure_logging</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">arg_logger</span><span class="p">,</span> <span class="n">from_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">arg_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">stat</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">errput</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">from_dir</span><span class="o">=</span><span class="n">from_dir</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="n">arg_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">arg_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">errput</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">filter_unicode</span><span class="p">(</span><span class="n">errput</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_batch_script_for_job">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_batch_script_for_job">[docs]</a>
<span class="k">def</span> <span class="nf">get_batch_script_for_job</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">job</span> <span class="k">if</span> <span class="s2">&quot;st_archive&quot;</span> <span class="ow">in</span> <span class="n">job</span> <span class="k">else</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">job</span></div>



<div class="viewcode-block" id="string_in_list">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.string_in_list">[docs]</a>
<span class="k">def</span> <span class="nf">string_in_list</span><span class="p">(</span><span class="n">_string</span><span class="p">,</span> <span class="n">_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Case insensitive search for string in list</span>
<span class="sd">    returns the matching list value</span>
<span class="sd">    &gt;&gt;&gt; string_in_list(&quot;Brack&quot;,[&quot;bar&quot;, &quot;bracK&quot;, &quot;foo&quot;])</span>
<span class="sd">    &#39;bracK&#39;</span>
<span class="sd">    &gt;&gt;&gt; string_in_list(&quot;foo&quot;, [&quot;FFO&quot;, &quot;FOO&quot;, &quot;foo2&quot;, &quot;foo3&quot;])</span>
<span class="sd">    &#39;FOO&#39;</span>
<span class="sd">    &gt;&gt;&gt; string_in_list(&quot;foo&quot;, [&quot;FFO&quot;, &quot;foo2&quot;, &quot;foo3&quot;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">x</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="model_log">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.model_log">[docs]</a>
<span class="k">def</span> <span class="nf">model_log</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">arg_logger</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">debug_others</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">get_model</span><span class="p">()</span> <span class="o">==</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">arg_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">debug_others</span><span class="p">:</span>
        <span class="n">arg_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_htmlroot">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_htmlroot">[docs]</a>
<span class="k">def</span> <span class="nf">get_htmlroot</span><span class="p">(</span><span class="n">machobj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get location for test HTML output</span>

<span class="sd">    Hierarchy for choosing CIME_HTML_ROOT:</span>
<span class="sd">    0. Environment variable CIME_HTML_ROOT</span>
<span class="sd">    1. File $HOME/.cime/config</span>
<span class="sd">    2. config_machines.xml (if machobj provided)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">htmlroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CIME_HTML_ROOT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">htmlroot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using htmlroot from env CIME_HTML_ROOT: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">htmlroot</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">htmlroot</span>

    <span class="n">cime_config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_HTML_ROOT&quot;</span><span class="p">):</span>
        <span class="n">htmlroot</span> <span class="o">=</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_HTML_ROOT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">htmlroot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using htmlroot from .cime/config: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">htmlroot</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">htmlroot</span>

    <span class="k">if</span> <span class="n">machobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">htmlroot</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIME_HTML_ROOT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">htmlroot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using htmlroot from config_machines.xml: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">htmlroot</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">htmlroot</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No htmlroot info available&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="get_urlroot">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.get_urlroot">[docs]</a>
<span class="k">def</span> <span class="nf">get_urlroot</span><span class="p">(</span><span class="n">machobj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get URL to htmlroot</span>

<span class="sd">    Hierarchy for choosing CIME_URL_ROOT:</span>
<span class="sd">    0. Environment variable CIME_URL_ROOT</span>
<span class="sd">    1. File $HOME/.cime/config</span>
<span class="sd">    2. config_machines.xml (if machobj provided)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">urlroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CIME_URL_ROOT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">urlroot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using urlroot from env CIME_URL_ROOT: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urlroot</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">urlroot</span>

    <span class="n">cime_config</span> <span class="o">=</span> <span class="n">get_cime_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_URL_ROOT&quot;</span><span class="p">):</span>
        <span class="n">urlroot</span> <span class="o">=</span> <span class="n">cime_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="s2">&quot;CIME_URL_ROOT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">urlroot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using urlroot from .cime/config: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urlroot</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">urlroot</span>

    <span class="k">if</span> <span class="n">machobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">urlroot</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIME_URL_ROOT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">urlroot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using urlroot from config_machines.xml: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urlroot</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">urlroot</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No urlroot info available&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="clear_folder">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.clear_folder">[docs]</a>
<span class="k">def</span> <span class="nf">clear_folder</span><span class="p">(</span><span class="n">_dir</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">the_file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">_dir</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_dir</span><span class="p">,</span> <span class="n">the_file</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clear_folder</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_flag_to_cmd">
<a class="viewcode-back" href="../../CIME_api/CIME.html#CIME.utils.add_flag_to_cmd">[docs]</a>
<span class="k">def</span> <span class="nf">add_flag_to_cmd</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a flag and value for a shell command, return a string</span>

<span class="sd">    &gt;&gt;&gt; add_flag_to_cmd(&quot;-f&quot;, &quot;hi&quot;)</span>
<span class="sd">    &#39;-f hi&#39;</span>
<span class="sd">    &gt;&gt;&gt; add_flag_to_cmd(&quot;--foo&quot;, 42)</span>
<span class="sd">    &#39;--foo 42&#39;</span>
<span class="sd">    &gt;&gt;&gt; add_flag_to_cmd(&quot;--foo=&quot;, 42)</span>
<span class="sd">    &#39;--foo=42&#39;</span>
<span class="sd">    &gt;&gt;&gt; add_flag_to_cmd(&quot;--foo:&quot;, 42)</span>
<span class="sd">    &#39;--foo:42&#39;</span>
<span class="sd">    &gt;&gt;&gt; add_flag_to_cmd(&quot;--foo:&quot;, &quot; hi &quot;)</span>
<span class="sd">    &#39;--foo:hi&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">no_space_chars</span> <span class="o">=</span> <span class="s2">&quot;=:&quot;</span>
    <span class="n">no_space</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">no_space_chars</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">no_space</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">separator</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">no_space</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>